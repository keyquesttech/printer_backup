#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 600
variable_macro_travel_accel: 8000
variable_adaptive_mesh: False
variable_skew_profile: "CaliFlower"
variable_end_print_park_z_hop: 20

variable_filament_load_length: 100
variable_filament_load_speed: 10
variable_filament_unload_length: 150
variable_filament_unload_speed: 25

variable_nozzle_prime_bridge_fan: 255

#####
# Beacon probe configuration
#####
variable_beacon_bed_mesh_scv: 25                         # square corner velocity for bed meshing with proximity method
variable_beacon_contact_z_homing: False                  # printer z-homing with contact method
variable_beacon_contact_z_calibration: True              # contact z-calibration before the print starts
variable_beacon_contact_calibration_location: "center"   # center = center of the build plate / front = front center / corner = front corner
variable_beacon_contact_calibrate_margin_x: 30           # x-margin if calibrate in front corners
variable_beacon_contact_bed_mesh: False                  # bed mesh with contact method
variable_beacon_contact_bed_mesh_samples: 2              # probe samples for contact bed mesh
variable_beacon_contact_z_tilt_adjust: False             # z-tilt adjust with contact method
variable_beacon_contact_z_tilt_adjust_samples: 2         # probe samples for contact z-tilt adjust
variable_beacon_contact_prime_probing: True              # probe for priming with contact method
variable_beacon_contact_calibration_temp: 150            # nozzle temperature for auto calibration
variable_beacon_contact_expansion_compensation: True     # enables the nozzle thermal expansion compensation
variable_beacon_contact_wipe_before_calibrate: True      # enables a nozzle wipe at Y0 before doing the contact calibration
variable_beacon_scan_compensation_enable: False          # Enables the beacon scan compensation
variable_beacon_scan_compensation_profile: "Contact"     # The contact profile name for the scan compensation
variable_beacon_scan_compensation_probe_count: 15,15     # The contact probe count for the scan compensation

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: Follow along from step 6 in the official beacon guide
###    https://docs.beacon3d.com/quickstart/#6-calibrate-beacon
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################


#------------------------------------------ Printer limits ---------------------------------------------------
# Printer limits
#------------------------------------------------------------------------------------------------------------

[printer]
max_velocity: 250
max_accel: 5000
square_corner_velocity: 5
minimum_cruise_ratio: 0.5
max_z_velocity: 50
max_z_accel: 600

# AWD printer limits. Uncomment to enable AWD
# [include User_files/AWD/48v/limits.cfg]
# [include User_files/AWD/24v/limits.cfg]

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
# Connected to MOTOR 4 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 39.85     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 208
position_endstop: 0

# Physical X endstop configuration
[stepper_x]
endstop_pin: ^!PF0
[gcode_macro RatOS]
variable_homing_x: "endstop"

# AWD stepper_x1 config. Uncomment to enable AWD
# [include User_files/AWD/48v/AWD_x1.cfg]
[include User_files/AWD/24v/AWD_x1.cfg]

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
# Connected to MOTOR 6 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 39.89     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -14
position_max: 181
position_endstop: 181

# Physical Y endstop configuration
[stepper_y]
endstop_pin: ^!PF2
[gcode_macro RatOS]
variable_homing_y: "endstop"

# AWD stepper_y1 config. Uncomment to enable AWD
# [include User_files/AWD/48v/AWD_y1.cfg]
[include User_files/AWD/24v/AWD_y1.cfg]

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
# Connected to MOTOR 1 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4      # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 200

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
# Connected to MOTOR 2 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: z1_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4      # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
# Connected to MOTOR 3 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: z2_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4      # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
# Connected to Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: !e_dir_pin       # Remove ! in front of pin name to reverse the direction of extruder
sensor_pin: PC5

rotation_distance: 4.63
pressure_advance: 0.05

nozzle_diameter: 0.6

max_extrude_cross_section: 10
min_temp: 0
max_temp: 275

[firmware_retraction]
retract_length: 0.5
retract_speed: 120
unretract_extra_length: 0
retract_speed: 120

# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 4-pin fan connected to 2-pin header on Octopus Max EZ V1.0 - digital pwm
pin: PA6
cycle_time:  0.00004

[temperature_sensor bed_core]
sensor_pin: PB0
sensor_type: PT1000
pullup_resistor: 2200
min_temp: 0
max_temp: 150

[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114

#------------------------------------------------- Z-probe -------------------------------------------------
# Z tilt and probe
# With beacon
#------------------------------------------------------------------------------------------------------------

[z_tilt]
z_positions:
	0,0
	100,200
	200,0
points:
	17, -13
	104, 143
	191, -13

horizontal_move_z: 20
retries: 10
retry_tolerance: 0.005

[beacon]
x_offset: 0
y_offset: 21.3
mesh_runs: 2

[bed_mesh]
probe_count: 50, 50
mesh_min: 18, 7.3
mesh_max: 189, 166

#------------------------------------------------- EXTRS ----------------------------------------------------
# Extras
# Extra files on "User_files"
#------------------------------------------------------------------------------------------------------------
[exclude_object]
[force_move]

[include User_files/Respond_colors/respond.cfg]

[include User_files/Smart_part_cooling_fan/Main_part_cooling_fan.cfg]
[include User_files/Smart_part_cooling_fan/Booster_part_cooling_fan.cfg]
[include User_files/Smart_part_cooling_fan/Part_cooling_fans_variables.cfg]
[include User_files/Smart_part_cooling_fan/Part_cooling_fan_macros.cfg]

[include User_files/Auto_speed/Auto_speed_setup.cfg]

[include User_files/Servo/Servo_variables.cfg]
[include User_files/Servo/Servo_macros.cfg]
[include User_files/Servo/Servo_brush.cfg]

[include User_files/Github_backup/Backup_macro.cfg]

[include User_files/Power/power_check.cfg]
[include User_files/Power/power_off_printer.cfg]

[include User_files/Macro_buttons/top.cfg]
[include User_files/Macro_buttons/bottom.cfg]

[include User_files/Beeper/buzzer_light.cfg]
[include User_files/Beeper/status_beep.cfg]

[include User_files/Filament_sensor/Filament_sensor.cfg]
[include User_files/Filament_sensor/Filament_sensor_macros.cfg]

[include User_files/Misc_macros/Misc_macro_variables.cfg]
[include User_files/Misc_macros/Auto_tune.cfg]
[include User_files/Misc_macros/Countdown_timer.cfg]
[include User_files/Misc_macros/Lube_bed.cfg]
[include User_files/Misc_macros/Lube_rails.cfg]

[include User_files/Relay/output_1.cfg]
[include User_files/Relay/output_2.cfg]

[temperature_sensor AIO_liquid]
sensor_type: Generic 3950
sensor_pin: PC4
min_temp: 0
max_temp: 80
pullup_resistor: 4700
gcode_id: liquid

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode:
	FILDET_ENABLE
    Z_TILT_ADJUST
    _CLEAN_NOZZLE_WITH_BRUSH
    BEACON_AUTO_CALIBRATE
    G28 Z METHOD=CONTACT CALIBRATE=0

[gcode_macro _USER_END_PRINT_PARK]
gcode:
	BEEP_STATUS_LONG
    FILDET_DISABLE

[idle_timeout]
gcode:
  UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
# 2 hour timeout
timeout: 7200

[gcode_macro ECHO_PRINTER_LIMITS]
description: Macro to output to terminal the printer limits
gcode:
    {% set max_velocity = printer.configfile.settings.printer.max_velocity %}
    {% set max_accel = printer.configfile.settings.printer.max_accel %}
    {% set square_corner_velocity = printer.configfile.settings.printer.square_corner_velocity %}
    {% set minimum_cruise_ratio = printer.configfile.settings.printer.minimum_cruise_ratio %}
    {% set max_z_velocity = printer.configfile.settings.printer.max_z_velocity %}
    {% set max_z_accel = printer.configfile.settings.printer.max_z_accel %}

    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Max velocity: {max_velocity}"
    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Max accel: {max_accel}"
    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Square corner velocity: {square_corner_velocity}"
    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Minimum cruise ratio: {minimum_cruise_ratio}"
    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Max Z velocity: {max_z_velocity}"
    RESPOND PREFIX="Printer limits:" COLOR=info MSG="Max Z accel: {max_z_accel}"

# REMEMBER TO CALIBRATE YOUR BEACON!
# Follow along from step 6 in the official beacon guide https://docs.beacon3d.com/quickstart/#6-calibrate-beacon

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.198
#*# pid_ki = 1.164
#*# pid_kd = 79.192
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 55.757
#*# pid_ki = 2.239
#*# pid_kd = 347.090
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 125.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 105.0
#*#
#*# [skew_correction CaliFlower]
#*# xy_skew = -0.005614659312787736
#*# xz_skew = 0.0
#*# yz_skew = 0.0
#*#
#*# [beacon model default]
#*# model_coef = 1.4154245037122208,
#*# 	1.751818747109917,
#*# 	0.8405806946244281,
#*# 	0.5052718968676256,
#*# 	0.2312562389816302,
#*# 	-0.07537800904031797,
#*# 	-0.0708968260259082,
#*# 	0.19842796261387213,
#*# 	0.18411466677373262,
#*# 	0.022118744196444096
#*# model_domain = 1.799721320158133e-07,1.9322657866419394e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 63.890054
#*# model_offset = 0.00000
