#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### Aditional boards added by user
#############################################################################################################

[include User_files/User_boards/thermexp1.cfg]
[include User_files/User_boards/thermexp2.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 600
variable_macro_travel_accel: 8000

#####
# Beacon probe configuration
#####
variable_beacon_bed_mesh_scv: 25                         # square corner velocity for bed meshing with proximity method
variable_beacon_contact_z_homing: False                  # printer z-homing with contact method
variable_beacon_contact_z_calibration: True              # contact z-calibration before the print starts
variable_beacon_contact_calibration_location: "center"   # center = center of the build plate / front = front center / corner = front corner
variable_beacon_contact_calibrate_margin_x: 30           # x-margin if calibrate in front corners
variable_beacon_contact_bed_mesh: False                  # bed mesh with contact method
variable_beacon_contact_bed_mesh_samples: 2              # probe samples for contact bed mesh
variable_beacon_contact_z_tilt_adjust: False             # z-tilt adjust with contact method
variable_beacon_contact_z_tilt_adjust_samples: 2         # probe samples for contact z-tilt adjust
variable_beacon_contact_prime_probing: True              # probe for priming with contact method
variable_beacon_contact_calibration_temp: 150            # nozzle temperature for auto calibration
variable_beacon_contact_expansion_compensation: True     # enables the nozzle thermal expansion compensation
variable_beacon_contact_wipe_before_calibrate: True      # enables a nozzle wipe at Y0 before doing the contact calibration
variable_beacon_scan_compensation_enable: False          # Enables the beacon scan compensation
variable_beacon_scan_compensation_profile: "Contact"     # The contact profile name for the scan compensation
variable_beacon_scan_compensation_probe_count: 15,15     # The contact probe count for the scan compensation

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: Follow along from step 6 in the official beacon guide
###    https://docs.beacon3d.com/quickstart/#6-calibrate-beacon
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
# Connected to MOTOR 4 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 208
position_endstop: 0

[stepper_x1]
dir_pin: x1_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

# Physical X endstop configuration
[stepper_x]
endstop_pin: ^!PF0
[gcode_macro RatOS]
variable_homing_x: "endstop"

[tmc5160 stepper_x1]
stealthchop_threshold: 0
interpolate: False
cs_pin: PG10
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.768
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4
sense_resistor: 0.075
	
[stepper_x1]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB6
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
# Connected to MOTOR 6 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
# position_min: 16
# position_max: 200
# position_endstop: 200
position_min: -14
position_max: 181
position_endstop: 181

[stepper_y1]
dir_pin: y1_dir_pin        # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys

# Physical Y endstop configuration
[stepper_y]
endstop_pin: ^!PF2
[gcode_macro RatOS]
variable_homing_y: "endstop"

[tmc5160 stepper_y1]
stealthchop_threshold: 0
interpolate: False
cs_pin: PD7
spi_software_mosi_pin: PE14
spi_software_miso_pin: PE13
spi_software_sclk_pin: PE12
run_current: 1.768
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 0
driver_HSTRT: 4
sense_resistor: 0.075

[stepper_y1]
step_pin: PD3
dir_pin: PD2
enable_pin: !PD4
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
# Connected to MOTOR 1 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4      # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 200

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
# Connected to MOTOR 2 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: z1_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4      # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
# Connected to MOTOR 3 on Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: z2_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4      # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
# Connected to Octopus Max EZ V1.0
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: !e_dir_pin       # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 5.57   # Bondtech LGX Lite default
#pressure_advance: 0.05   # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
control: pid
pid_kp: 28.413
pid_ki: 1.334
pid_kd: 151.300

# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 4-pin fan connected to 2-pin header on Octopus Max EZ V1.0 - digital pwm
pin: PA6
cycle_time:  0.00004

[heater_bed]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[temperature_sensor bed_core]
sensor_pin: PB0
sensor_type: PT1000
pullup_resistor: 2200
min_temp: 0
max_temp: 150

#------------------------------------------------- Z-probe -------------------------------------------------
# Z tilt and probe
# With beacon
#------------------------------------------------------------------------------------------------------------

[z_tilt]
z_positions:
	0,0
	100,200
	200,0
points:
	17, -13
	104, 143
	191, -13

[beacon]
x_offset: 0
y_offset: 21.3

[bed_mesh]
mesh_min: 18, 7.3
mesh_max: 189, 166

#------------------------------------------------- EXTRS ----------------------------------------------------
# Extras
# Extra files on "User_files"
#------------------------------------------------------------------------------------------------------------
[include User_files/Extra_thermistors/Stepper_thersmistors.cfg]
[include User_files/Extra_thermistors/Stepper_driver_thermistors.cfg]
[include User_files/Extra_thermistors/AIO_liquid.cfg]

[include User_files/Servo/Servo_variables.cfg]
[include User_files/Servo/Servo_macros.cfg]
[include User_files/Servo/Servo_brush.cfg]

[include User_files/Github_backup/Backup_macro.cfg]

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode:
	_CLEAN_NOZZLE_WITH_BRUSH

# REMEMBER TO CALIBRATE YOUR BEACON!
# Follow along from step 6 in the official beacon guide https://docs.beacon3d.com/quickstart/#6-calibrate-beacon

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.4382393788738252,
#*# 	  1.790311720676889,
#*# 	  0.8239677570983328,
#*# 	  0.3113673397379039,
#*# 	  0.17147497805840778,
#*# 	  0.44167399021429915,
#*# 	  0.06126692843555578,
#*# 	  -0.4025561501886048,
#*# 	  0.10507778929280384,
#*# 	  0.2613672473022101
#*# model_domain = 1.8097689725968362e-07,1.9335016582861798e-07
#*# model_range = 0.200000,5.000000
#*# model_temp = 61.072109
#*# model_offset = 0.00000
