===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}

[thermistor 10k]
temperature1 = -39.44
resistance1 = 323839
temperature2 = 25.00
resistance2 = 10000
temperature3 = 86.11
resistance3 = 1034

[temperature_sensor barrow]
sensor_type = 10k
sensor_pin = thermistor_e2
min_temp = -240
max_temp = 99999
=======================
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-169-g28faf814-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
webhooks client 4127116976: {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
=============== Log rollover at Sun Apr 21 00:00:58 2024 ===============
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
MCU error during connect
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/mcu.py", line 791, in _mcu_identify
    self._serial.connect_uart(self._serialport, self._baud, rts)
  File "/home/pi/klipper/klippy/serialhdl.py", line 182, in connect_uart
    self._error("Unable to connect")
  File "/home/pi/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/pi/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/pi/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/mcu.py", line 796, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
Build file /home/pi/klipper/klippy/../.config(914): Sat Apr 20 22:38:30 2024
========= Last MCU build config =========
# CONFIG_LOW_LEVEL_OPTIONS is not set
# CONFIG_MACH_AVR is not set
# CONFIG_MACH_ATSAM is not set
# CONFIG_MACH_ATSAMD is not set
# CONFIG_MACH_LPC176X is not set
# CONFIG_MACH_STM32 is not set
# CONFIG_MACH_HC32F460 is not set
# CONFIG_MACH_RP2040 is not set
# CONFIG_MACH_PRU is not set
# CONFIG_MACH_AR100 is not set
CONFIG_MACH_LINUX=y
# CONFIG_MACH_SIMU is not set
CONFIG_BOARD_DIRECTORY="linux"
CONFIG_CLOCK_FREQ=50000000
CONFIG_LINUX_SELECT=y
CONFIG_USB_VENDOR_ID=0x1d50
CONFIG_USB_DEVICE_ID=0x614e
CONFIG_USB_SERIAL_NUMBER="12345"
CONFIG_WANT_GPIO_BITBANGING=y
CONFIG_WANT_DISPLAYS=y
CONFIG_WANT_SENSORS=y
CONFIG_WANT_LIS2DW=y
CONFIG_WANT_LDC1612=y
CONFIG_WANT_SOFTWARE_I2C=y
CONFIG_WANT_SOFTWARE_SPI=y
CONFIG_NEED_SENSOR_BULK=y
CONFIG_CANBUS_FREQUENCY=1000000
CONFIG_HAVE_GPIO=y
CONFIG_HAVE_GPIO_ADC=y
CONFIG_HAVE_GPIO_SPI=y
CONFIG_HAVE_GPIO_I2C=y
CONFIG_HAVE_GPIO_HARD_PWM=y
CONFIG_INLINE_STEPPER_HACK=y
=======================
Build file /home/pi/klipper/klippy/../out/klipper.dict(9535): Sat Apr 20 22:38:48 2024
Last MCU build version: v0.12.0-169-g28faf814
Last MCU build tools: gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2
Last MCU build config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
Build file /home/pi/klipper/klippy/../out/klipper.elf(712672): Sat Apr 20 22:38:52 2024
Attempting MCU 'mcu' reset
Unable to issue reset command on MCU 'rpi'
webhooks client 4127116976: Disconnected
Restarting printer
Start printer at Sun Apr 21 00:15:06 2024 (1713654906.1 887.9)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}

[thermistor 10k]
temperature1 = -39.44
resistance1 = 323839
temperature2 = 25.00
resistance2 = 10000
temperature3 = 86.11
resistance3 = 1034

[temperature_sensor barrow]
sensor_type = 10k
sensor_pin = thermistor_e2
min_temp = -240
max_temp = 99999
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
webhooks client 4119846600: New connection
webhooks client 4119846600: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
Loaded MCU 'mcu' 112 commands (v0.12.0-169-g28faf814 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
Loaded MCU 'rpi' 118 commands (v0.12.0-169-g28faf814 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'rpi' printer configuration...
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)

Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.


Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
Stats 892.0: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9165 bytes_read=12356 bytes_retransmit=9 bytes_invalid=0 send_seq=606 receive_seq=606 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027062 rpi: mcu_awake=0.003 mcu_task_avg=0.000020 mcu_task_stddev=0.000011 bytes_write=831 bytes_read=6881 bytes_retransmit=0 bytes_invalid=0 send_seq=113 receive_seq=113 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998014 adj=49991229 Octopus_Max: temp=31.2 Pi: temp=36.5  heater_bed: target=0 temp=26.1 pwm=0.000 bed_mat: temp=25.7 bed_core: temp=26.5 barrow: temp=-119.3 sysload=0.01 cputime=4.670 memavail=7499412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.3 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 4119846600
webhooks: registering remote method 'reboot_machine' for connection id: 4119846600
webhooks: registering remote method 'pause_job_queue' for connection id: 4119846600
webhooks: registering remote method 'start_job_queue' for connection id: 4119846600
webhooks: registering remote method 'set_device_power' for connection id: 4119846600
Stats 893.0: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9171 bytes_read=12639 bytes_retransmit=9 bytes_invalid=0 send_seq=607 receive_seq=607 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027555 rpi: mcu_awake=0.003 mcu_task_avg=0.000020 mcu_task_stddev=0.000011 bytes_write=837 bytes_read=6897 bytes_retransmit=0 bytes_invalid=0 send_seq=114 receive_seq=114 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999328 adj=49996597 Octopus_Max: temp=31.1 Pi: temp=37.0  heater_bed: target=0 temp=26.1 pwm=0.000 bed_mat: temp=25.6 bed_core: temp=26.6 barrow: temp=-119.3 sysload=0.01 cputime=4.711 memavail=7498768 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.2 pwm=0.000
Stats 894.0: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9177 bytes_read=12921 bytes_retransmit=9 bytes_invalid=0 send_seq=608 receive_seq=608 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028320 rpi: mcu_awake=0.003 mcu_task_avg=0.000020 mcu_task_stddev=0.000011 bytes_write=843 bytes_read=6913 bytes_retransmit=0 bytes_invalid=0 send_seq=115 receive_seq=115 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999647 adj=49998354 Octopus_Max: temp=31.3 Pi: temp=35.5  heater_bed: target=0 temp=26.1 pwm=0.000 bed_mat: temp=25.7 bed_core: temp=26.6 barrow: temp=-110.0 sysload=0.01 cputime=4.723 memavail=7498768 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.2 pwm=0.000
Stats 895.0: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9183 bytes_read=13232 bytes_retransmit=9 bytes_invalid=0 send_seq=609 receive_seq=609 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028606 rpi: mcu_awake=0.003 mcu_task_avg=0.000020 mcu_task_stddev=0.000011 bytes_write=849 bytes_read=6929 bytes_retransmit=0 bytes_invalid=0 send_seq=116 receive_seq=116 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999618 adj=49998183 Octopus_Max: temp=31.2 Pi: temp=36.0  heater_bed: target=0 temp=26.1 pwm=0.000 bed_mat: temp=25.6 bed_core: temp=26.6 barrow: temp=-119.3 sysload=0.01 cputime=4.734 memavail=7498768 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=26.2 pwm=0.000
webhooks client 4119846600: Disconnected
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-169-g28faf814-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 00:15:37 2024 (1713654937.7 23.2)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}

[thermistor 10k]
temperature1 = -39.44
resistance1 = 323839
temperature2 = 25.00
resistance2 = 10000
temperature3 = 86.11
resistance3 = 1034

[temperature_sensor barrow]
sensor_type = 10k
sensor_pin = thermistor_e2
min_temp = -240
max_temp = 99999
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
webhooks client 4132642648: New connection
webhooks client 4132642648: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
MCU error during connect
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/mcu.py", line 791, in _mcu_identify
    self._serial.connect_uart(self._serialport, self._baud, rts)
  File "/home/pi/klipper/klippy/serialhdl.py", line 182, in connect_uart
    self._error("Unable to connect")
  File "/home/pi/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/pi/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/pi/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/mcu.py", line 796, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
Build file /home/pi/klipper/klippy/../.config(914): Sat Apr 20 22:38:30 2024
========= Last MCU build config =========
# CONFIG_LOW_LEVEL_OPTIONS is not set
# CONFIG_MACH_AVR is not set
# CONFIG_MACH_ATSAM is not set
# CONFIG_MACH_ATSAMD is not set
# CONFIG_MACH_LPC176X is not set
# CONFIG_MACH_STM32 is not set
# CONFIG_MACH_HC32F460 is not set
# CONFIG_MACH_RP2040 is not set
# CONFIG_MACH_PRU is not set
# CONFIG_MACH_AR100 is not set
CONFIG_MACH_LINUX=y
# CONFIG_MACH_SIMU is not set
CONFIG_BOARD_DIRECTORY="linux"
CONFIG_CLOCK_FREQ=50000000
CONFIG_LINUX_SELECT=y
CONFIG_USB_VENDOR_ID=0x1d50
CONFIG_USB_DEVICE_ID=0x614e
CONFIG_USB_SERIAL_NUMBER="12345"
CONFIG_WANT_GPIO_BITBANGING=y
CONFIG_WANT_DISPLAYS=y
CONFIG_WANT_SENSORS=y
CONFIG_WANT_LIS2DW=y
CONFIG_WANT_LDC1612=y
CONFIG_WANT_SOFTWARE_I2C=y
CONFIG_WANT_SOFTWARE_SPI=y
CONFIG_NEED_SENSOR_BULK=y
CONFIG_CANBUS_FREQUENCY=1000000
CONFIG_HAVE_GPIO=y
CONFIG_HAVE_GPIO_ADC=y
CONFIG_HAVE_GPIO_SPI=y
CONFIG_HAVE_GPIO_I2C=y
CONFIG_HAVE_GPIO_HARD_PWM=y
CONFIG_INLINE_STEPPER_HACK=y
=======================
Build file /home/pi/klipper/klippy/../out/klipper.dict(9535): Sat Apr 20 22:38:48 2024
Last MCU build version: v0.12.0-169-g28faf814
Last MCU build tools: gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2
Last MCU build config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
Build file /home/pi/klipper/klippy/../out/klipper.elf(712672): Sat Apr 20 22:38:52 2024
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-169-g28faf814-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py, klippy/extras/state_notify.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:30:09 2024 (1713677409.6 4061.7)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
webhooks client 4123009232: New connection
webhooks client 4123009232: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
MCU error during connect
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/mcu.py", line 791, in _mcu_identify
    self._serial.connect_uart(self._serialport, self._baud, rts)
  File "/home/pi/klipper/klippy/serialhdl.py", line 182, in connect_uart
    self._error("Unable to connect")
  File "/home/pi/klipper/klippy/serialhdl.py", line 61, in _error
    raise error(self.warn_prefix + (msg % params))
serialhdl.error: mcu 'mcu': Unable to connect

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/pi/klipper/klippy/klippy.py", line 176, in _connect
    self.send_event("klippy:mcu_identify")
  File "/home/pi/klipper/klippy/klippy.py", line 263, in send_event
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/klippy.py", line 263, in <listcomp>
    return [cb(*params) for cb in self.event_handlers.get(event, [])]
  File "/home/pi/klipper/klippy/mcu.py", line 796, in _mcu_identify
    raise error(str(e))
mcu.error: mcu 'mcu': Unable to connect
Build file /home/pi/klipper/klippy/../.config(914): Sat Apr 20 22:38:30 2024
========= Last MCU build config =========
# CONFIG_LOW_LEVEL_OPTIONS is not set
# CONFIG_MACH_AVR is not set
# CONFIG_MACH_ATSAM is not set
# CONFIG_MACH_ATSAMD is not set
# CONFIG_MACH_LPC176X is not set
# CONFIG_MACH_STM32 is not set
# CONFIG_MACH_HC32F460 is not set
# CONFIG_MACH_RP2040 is not set
# CONFIG_MACH_PRU is not set
# CONFIG_MACH_AR100 is not set
CONFIG_MACH_LINUX=y
# CONFIG_MACH_SIMU is not set
CONFIG_BOARD_DIRECTORY="linux"
CONFIG_CLOCK_FREQ=50000000
CONFIG_LINUX_SELECT=y
CONFIG_USB_VENDOR_ID=0x1d50
CONFIG_USB_DEVICE_ID=0x614e
CONFIG_USB_SERIAL_NUMBER="12345"
CONFIG_WANT_GPIO_BITBANGING=y
CONFIG_WANT_DISPLAYS=y
CONFIG_WANT_SENSORS=y
CONFIG_WANT_LIS2DW=y
CONFIG_WANT_LDC1612=y
CONFIG_WANT_SOFTWARE_I2C=y
CONFIG_WANT_SOFTWARE_SPI=y
CONFIG_NEED_SENSOR_BULK=y
CONFIG_CANBUS_FREQUENCY=1000000
CONFIG_HAVE_GPIO=y
CONFIG_HAVE_GPIO_ADC=y
CONFIG_HAVE_GPIO_SPI=y
CONFIG_HAVE_GPIO_I2C=y
CONFIG_HAVE_GPIO_HARD_PWM=y
CONFIG_INLINE_STEPPER_HACK=y
=======================
Build file /home/pi/klipper/klippy/../out/klipper.dict(9535): Sat Apr 20 22:38:48 2024
Last MCU build version: v0.12.0-169-g28faf814
Last MCU build tools: gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2
Last MCU build config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
Build file /home/pi/klipper/klippy/../out/klipper.elf(712672): Sat Apr 20 22:38:52 2024
webhooks client 4123009232: Disconnected
webhooks client 4123671976: New connection
webhooks client 4123671976: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
webhooks client 4123671976: Disconnected
webhooks client 4123670128: New connection
webhooks client 4123670128: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
Attempting MCU 'mcu' reset
Unable to issue reset command on MCU 'rpi'
webhooks client 4123670128: Disconnected
Restarting printer
Start printer at Sun Apr 21 06:32:47 2024 (1713677567.9 4220.0)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
webhooks client 4122799360: New connection
webhooks client 4122799360: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
Loaded MCU 'mcu' 112 commands (v0.12.0-169-g28faf814 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
Loaded MCU 'rpi' 118 commands (v0.12.0-169-g28faf814 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'rpi' printer configuration...
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)

Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.


Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
Stats 4224.1: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9087 bytes_read=12256 bytes_retransmit=9 bytes_invalid=0 send_seq=595 receive_seq=595 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026483 rpi: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=831 bytes_read=15434 bytes_retransmit=0 bytes_invalid=0 send_seq=113 receive_seq=113 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49996043 adj=49985174 Octopus_Max: temp=28.5 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.50 cputime=3.602 memavail=7500100 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 4122799360
webhooks: registering remote method 'reboot_machine' for connection id: 4122799360
webhooks: registering remote method 'pause_job_queue' for connection id: 4122799360
webhooks: registering remote method 'start_job_queue' for connection id: 4122799360
webhooks: registering remote method 'set_device_power' for connection id: 4122799360
Stats 4225.1: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9093 bytes_read=12479 bytes_retransmit=9 bytes_invalid=0 send_seq=596 receive_seq=596 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027601 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=837 bytes_read=15464 bytes_retransmit=0 bytes_invalid=0 send_seq=114 receive_seq=114 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998152 adj=49996954 Octopus_Max: temp=28.5 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.50 cputime=3.643 memavail=7499876 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4226.1: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9099 bytes_read=12716 bytes_retransmit=9 bytes_invalid=0 send_seq=597 receive_seq=597 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028118 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=843 bytes_read=15480 bytes_retransmit=0 bytes_invalid=0 send_seq=115 receive_seq=115 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998726 adj=49999439 Octopus_Max: temp=28.5 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.50 cputime=3.655 memavail=7499876 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4227.1: gcodein=0  mcu: mcu_awake=0.010 mcu_task_avg=0.000013 mcu_task_stddev=0.000094 bytes_write=9105 bytes_read=12982 bytes_retransmit=9 bytes_invalid=0 send_seq=598 receive_seq=598 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028537 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=849 bytes_read=15496 bytes_retransmit=0 bytes_invalid=0 send_seq=116 receive_seq=116 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998760 adj=49999290 Octopus_Max: temp=28.7 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.50 cputime=3.666 memavail=7499916 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4228.1: gcodein=0  mcu: mcu_awake=0.005 mcu_task_avg=0.000004 mcu_task_stddev=0.000007 bytes_write=9111 bytes_read=13221 bytes_retransmit=9 bytes_invalid=0 send_seq=599 receive_seq=599 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028531 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=855 bytes_read=15512 bytes_retransmit=0 bytes_invalid=0 send_seq=117 receive_seq=117 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998955 adj=49998223 Octopus_Max: temp=28.7 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.50 cputime=3.678 memavail=7499916 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4229.1: gcodein=0  mcu: mcu_awake=0.005 mcu_task_avg=0.000004 mcu_task_stddev=0.000007 bytes_write=9117 bytes_read=13446 bytes_retransmit=9 bytes_invalid=0 send_seq=600 receive_seq=600 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028452 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=867 bytes_read=15544 bytes_retransmit=0 bytes_invalid=0 send_seq=119 receive_seq=119 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999044 adj=49997957 Octopus_Max: temp=28.7 Pi: temp=33.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.46 cputime=3.694 memavail=7494132 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4230.1: gcodein=0  mcu: mcu_awake=0.005 mcu_task_avg=0.000004 mcu_task_stddev=0.000007 bytes_write=9123 bytes_read=13712 bytes_retransmit=9 bytes_invalid=0 send_seq=601 receive_seq=601 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028347 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000011 bytes_write=873 bytes_read=15573 bytes_retransmit=0 bytes_invalid=0 send_seq=120 receive_seq=120 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999064 adj=49997589 Octopus_Max: temp=28.8 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.46 cputime=3.706 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4231.1: gcodein=0  mcu: mcu_awake=0.005 mcu_task_avg=0.000004 mcu_task_stddev=0.000007 bytes_write=9129 bytes_read=13935 bytes_retransmit=9 bytes_invalid=0 send_seq=602 receive_seq=602 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028272 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000011 bytes_write=879 bytes_read=15589 bytes_retransmit=0 bytes_invalid=0 send_seq=121 receive_seq=121 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999082 adj=49997163 Octopus_Max: temp=28.9 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.46 cputime=3.717 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4232.1: gcodein=0  mcu: mcu_awake=0.005 mcu_task_avg=0.000004 mcu_task_stddev=0.000007 bytes_write=9135 bytes_read=14172 bytes_retransmit=9 bytes_invalid=0 send_seq=603 receive_seq=603 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028224 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000011 bytes_write=885 bytes_read=15605 bytes_retransmit=0 bytes_invalid=0 send_seq=122 receive_seq=122 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999098 adj=49996842 Octopus_Max: temp=28.7 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.46 cputime=3.728 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4233.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9141 bytes_read=14452 bytes_retransmit=9 bytes_invalid=0 send_seq=604 receive_seq=604 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028211 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000011 bytes_write=891 bytes_read=15621 bytes_retransmit=0 bytes_invalid=0 send_seq=123 receive_seq=123 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999116 adj=49996592 Octopus_Max: temp=28.9 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.7 bed_core: temp=23.5 sysload=0.46 cputime=3.739 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4234.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9147 bytes_read=14675 bytes_retransmit=9 bytes_invalid=0 send_seq=605 receive_seq=605 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028191 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000011 bytes_write=897 bytes_read=15637 bytes_retransmit=0 bytes_invalid=0 send_seq=124 receive_seq=124 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999255 adj=49996410 Octopus_Max: temp=29.0 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.43 cputime=3.755 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4235.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9153 bytes_read=14912 bytes_retransmit=9 bytes_invalid=0 send_seq=606 receive_seq=606 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028455 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000013 bytes_write=903 bytes_read=15666 bytes_retransmit=0 bytes_invalid=0 send_seq=125 receive_seq=125 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999323 adj=49996750 Octopus_Max: temp=29.0 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.43 cputime=3.783 memavail=7500312 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4236.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9159 bytes_read=15178 bytes_retransmit=9 bytes_invalid=0 send_seq=607 receive_seq=607 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028965 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000013 bytes_write=909 bytes_read=15682 bytes_retransmit=0 bytes_invalid=0 send_seq=126 receive_seq=126 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999386 adj=49996633 Octopus_Max: temp=29.0 Pi: temp=34.1  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.43 cputime=3.809 memavail=7500088 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4237.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9165 bytes_read=15401 bytes_retransmit=9 bytes_invalid=0 send_seq=608 receive_seq=608 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029065 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000013 bytes_write=915 bytes_read=15698 bytes_retransmit=0 bytes_invalid=0 send_seq=127 receive_seq=127 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999409 adj=49996405 Octopus_Max: temp=29.3 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.43 cputime=3.836 memavail=7500088 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4238.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9171 bytes_read=15652 bytes_retransmit=9 bytes_invalid=0 send_seq=609 receive_seq=609 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029105 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000013 bytes_write=921 bytes_read=15714 bytes_retransmit=0 bytes_invalid=0 send_seq=128 receive_seq=128 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999442 adj=49996291 Octopus_Max: temp=29.3 Pi: temp=34.1  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.43 cputime=3.862 memavail=7500088 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4239.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9177 bytes_read=15914 bytes_retransmit=9 bytes_invalid=0 send_seq=610 receive_seq=610 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029066 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000013 bytes_write=927 bytes_read=15730 bytes_retransmit=0 bytes_invalid=0 send_seq=129 receive_seq=129 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999506 adj=49996293 Octopus_Max: temp=29.3 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.39 cputime=3.890 memavail=7499600 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4240.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9183 bytes_read=16131 bytes_retransmit=9 bytes_invalid=0 send_seq=611 receive_seq=611 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029061 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000020 bytes_write=933 bytes_read=15759 bytes_retransmit=0 bytes_invalid=0 send_seq=130 receive_seq=130 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999537 adj=49996508 Octopus_Max: temp=29.5 Pi: temp=34.1  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.39 cputime=3.917 memavail=7499600 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4241.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9189 bytes_read=16368 bytes_retransmit=9 bytes_invalid=0 send_seq=612 receive_seq=612 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029118 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000020 bytes_write=939 bytes_read=15775 bytes_retransmit=0 bytes_invalid=0 send_seq=131 receive_seq=131 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999544 adj=49996512 Octopus_Max: temp=29.4 Pi: temp=33.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.39 cputime=3.945 memavail=7499600 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4242.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9195 bytes_read=16634 bytes_retransmit=9 bytes_invalid=0 send_seq=613 receive_seq=613 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029082 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000020 bytes_write=945 bytes_read=15791 bytes_retransmit=0 bytes_invalid=0 send_seq=132 receive_seq=132 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999545 adj=49996357 Octopus_Max: temp=29.5 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.39 cputime=3.973 memavail=7499600 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4243.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9201 bytes_read=16871 bytes_retransmit=9 bytes_invalid=0 send_seq=614 receive_seq=614 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029040 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000020 bytes_write=951 bytes_read=15807 bytes_retransmit=0 bytes_invalid=0 send_seq=133 receive_seq=133 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999528 adj=49996274 Octopus_Max: temp=29.5 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.39 cputime=4.001 memavail=7499608 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4244.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9207 bytes_read=17108 bytes_retransmit=9 bytes_invalid=0 send_seq=615 receive_seq=615 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028999 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000020 bytes_write=957 bytes_read=15823 bytes_retransmit=0 bytes_invalid=0 send_seq=134 receive_seq=134 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999508 adj=49996121 Octopus_Max: temp=29.5 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.36 cputime=4.026 memavail=7499608 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4245.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9213 bytes_read=17374 bytes_retransmit=9 bytes_invalid=0 send_seq=616 receive_seq=616 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028940 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000019 bytes_write=963 bytes_read=15852 bytes_retransmit=0 bytes_invalid=0 send_seq=135 receive_seq=135 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999498 adj=49995979 Octopus_Max: temp=29.5 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.36 cputime=4.054 memavail=7496836 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4246.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9219 bytes_read=17597 bytes_retransmit=9 bytes_invalid=0 send_seq=617 receive_seq=617 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028805 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000019 bytes_write=969 bytes_read=15868 bytes_retransmit=0 bytes_invalid=0 send_seq=136 receive_seq=136 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999470 adj=49995940 Octopus_Max: temp=29.5 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.36 cputime=4.067 memavail=7502500 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4247.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9225 bytes_read=17834 bytes_retransmit=9 bytes_invalid=0 send_seq=618 receive_seq=618 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028690 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000019 bytes_write=975 bytes_read=15884 bytes_retransmit=0 bytes_invalid=0 send_seq=137 receive_seq=137 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999442 adj=49995855 Octopus_Max: temp=29.7 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.36 cputime=4.078 memavail=7502500 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4248.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9231 bytes_read=18114 bytes_retransmit=9 bytes_invalid=0 send_seq=619 receive_seq=619 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028586 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000019 bytes_write=981 bytes_read=15900 bytes_retransmit=0 bytes_invalid=0 send_seq=138 receive_seq=138 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999419 adj=49995772 Octopus_Max: temp=29.6 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.36 cputime=4.090 memavail=7502500 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4249.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9237 bytes_read=18337 bytes_retransmit=9 bytes_invalid=0 send_seq=620 receive_seq=620 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028500 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000019 bytes_write=987 bytes_read=15916 bytes_retransmit=0 bytes_invalid=0 send_seq=139 receive_seq=139 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999407 adj=49995731 Octopus_Max: temp=29.7 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.33 cputime=4.101 memavail=7502008 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4250.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9243 bytes_read=18569 bytes_retransmit=9 bytes_invalid=0 send_seq=621 receive_seq=621 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028425 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=993 bytes_read=15945 bytes_retransmit=0 bytes_invalid=0 send_seq=140 receive_seq=140 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999391 adj=49995752 Octopus_Max: temp=29.8 Pi: temp=34.1  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.33 cputime=4.114 memavail=7502008 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4251.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9249 bytes_read=18830 bytes_retransmit=9 bytes_invalid=0 send_seq=622 receive_seq=622 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028445 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=999 bytes_read=15961 bytes_retransmit=0 bytes_invalid=0 send_seq=141 receive_seq=141 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999398 adj=49995731 Octopus_Max: temp=29.9 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.33 cputime=4.141 memavail=7502008 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4252.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9255 bytes_read=19053 bytes_retransmit=9 bytes_invalid=0 send_seq=623 receive_seq=623 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028463 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=1005 bytes_read=15977 bytes_retransmit=0 bytes_invalid=0 send_seq=142 receive_seq=142 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999422 adj=49995789 Octopus_Max: temp=29.8 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.33 cputime=4.168 memavail=7502008 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4253.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9261 bytes_read=19304 bytes_retransmit=9 bytes_invalid=0 send_seq=624 receive_seq=624 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028487 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=1011 bytes_read=15993 bytes_retransmit=0 bytes_invalid=0 send_seq=143 receive_seq=143 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999485 adj=49995960 Octopus_Max: temp=29.9 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.33 cputime=4.196 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4254.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9267 bytes_read=19570 bytes_retransmit=9 bytes_invalid=0 send_seq=625 receive_seq=625 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028515 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=1017 bytes_read=16009 bytes_retransmit=0 bytes_invalid=0 send_seq=144 receive_seq=144 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999502 adj=49996383 Octopus_Max: temp=30.0 Pi: temp=33.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.4 sysload=0.30 cputime=4.224 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4255.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9273 bytes_read=19793 bytes_retransmit=9 bytes_invalid=0 send_seq=626 receive_seq=626 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028560 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1023 bytes_read=16038 bytes_retransmit=0 bytes_invalid=0 send_seq=145 receive_seq=145 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999524 adj=49996378 Octopus_Max: temp=30.0 Pi: temp=33.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.30 cputime=4.251 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4256.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9279 bytes_read=20030 bytes_retransmit=9 bytes_invalid=0 send_seq=627 receive_seq=627 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028555 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1029 bytes_read=16054 bytes_retransmit=0 bytes_invalid=0 send_seq=146 receive_seq=146 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999527 adj=49996393 Octopus_Max: temp=29.9 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.30 cputime=4.279 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4257.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9285 bytes_read=20296 bytes_retransmit=9 bytes_invalid=0 send_seq=628 receive_seq=628 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028538 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1035 bytes_read=16070 bytes_retransmit=0 bytes_invalid=0 send_seq=147 receive_seq=147 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999519 adj=49996310 Octopus_Max: temp=29.9 Pi: temp=33.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.30 cputime=4.307 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4258.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9291 bytes_read=20533 bytes_retransmit=9 bytes_invalid=0 send_seq=629 receive_seq=629 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028535 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1041 bytes_read=16086 bytes_retransmit=0 bytes_invalid=0 send_seq=148 receive_seq=148 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999512 adj=49996172 Octopus_Max: temp=30.2 Pi: temp=33.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.30 cputime=4.334 memavail=7502016 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4259.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9297 bytes_read=20770 bytes_retransmit=9 bytes_invalid=0 send_seq=630 receive_seq=630 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028517 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1047 bytes_read=16102 bytes_retransmit=0 bytes_invalid=0 send_seq=149 receive_seq=149 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999508 adj=49996069 Octopus_Max: temp=30.0 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.28 cputime=4.363 memavail=7503844 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4260.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9303 bytes_read=21036 bytes_retransmit=9 bytes_invalid=0 send_seq=631 receive_seq=631 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028517 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1053 bytes_read=16131 bytes_retransmit=0 bytes_invalid=0 send_seq=150 receive_seq=150 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999503 adj=49996023 Octopus_Max: temp=30.3 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.28 cputime=4.391 memavail=7503340 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4261.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9315 bytes_read=21278 bytes_retransmit=9 bytes_invalid=0 send_seq=633 receive_seq=633 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028500 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1059 bytes_read=16147 bytes_retransmit=0 bytes_invalid=0 send_seq=151 receive_seq=151 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999496 adj=49995955 Octopus_Max: temp=30.2 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.28 cputime=4.417 memavail=7503340 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4262.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9321 bytes_read=21501 bytes_retransmit=9 bytes_invalid=0 send_seq=634 receive_seq=634 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028442 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1065 bytes_read=16163 bytes_retransmit=0 bytes_invalid=0 send_seq=152 receive_seq=152 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999477 adj=49995912 Octopus_Max: temp=30.1 Pi: temp=33.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.28 cputime=4.434 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4263.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9327 bytes_read=21781 bytes_retransmit=9 bytes_invalid=0 send_seq=635 receive_seq=635 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028395 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1071 bytes_read=16179 bytes_retransmit=0 bytes_invalid=0 send_seq=153 receive_seq=153 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999459 adj=49995812 Octopus_Max: temp=30.0 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.28 cputime=4.446 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4264.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9333 bytes_read=22018 bytes_retransmit=9 bytes_invalid=0 send_seq=636 receive_seq=636 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028358 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1077 bytes_read=16195 bytes_retransmit=0 bytes_invalid=0 send_seq=154 receive_seq=154 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999444 adj=49995734 Octopus_Max: temp=30.4 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.26 cputime=4.457 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4265.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9339 bytes_read=22241 bytes_retransmit=9 bytes_invalid=0 send_seq=637 receive_seq=637 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028317 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000015 bytes_write=1083 bytes_read=16224 bytes_retransmit=0 bytes_invalid=0 send_seq=155 receive_seq=155 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999430 adj=49995677 Octopus_Max: temp=30.4 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.26 cputime=4.468 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4266.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9345 bytes_read=22507 bytes_retransmit=9 bytes_invalid=0 send_seq=638 receive_seq=638 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028282 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000015 bytes_write=1089 bytes_read=16240 bytes_retransmit=0 bytes_invalid=0 send_seq=156 receive_seq=156 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999421 adj=49995653 Octopus_Max: temp=30.2 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.26 cputime=4.480 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4267.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9351 bytes_read=22744 bytes_retransmit=9 bytes_invalid=0 send_seq=639 receive_seq=639 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028301 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000015 bytes_write=1095 bytes_read=16256 bytes_retransmit=0 bytes_invalid=0 send_seq=157 receive_seq=157 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999430 adj=49995668 Octopus_Max: temp=30.4 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.26 cputime=4.502 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4268.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9357 bytes_read=22981 bytes_retransmit=9 bytes_invalid=0 send_seq=640 receive_seq=640 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028320 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000015 bytes_write=1101 bytes_read=16272 bytes_retransmit=0 bytes_invalid=0 send_seq=158 receive_seq=158 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999430 adj=49995787 Octopus_Max: temp=30.3 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.4 sysload=0.26 cputime=4.529 memavail=7503196 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4269.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9363 bytes_read=23247 bytes_retransmit=9 bytes_invalid=0 send_seq=641 receive_seq=641 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028321 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000015 bytes_write=1107 bytes_read=16288 bytes_retransmit=0 bytes_invalid=0 send_seq=159 receive_seq=159 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999430 adj=49995795 Octopus_Max: temp=30.4 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.24 cputime=4.556 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4270.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9369 bytes_read=23484 bytes_retransmit=9 bytes_invalid=0 send_seq=642 receive_seq=642 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028318 rpi: mcu_awake=0.001 mcu_task_avg=0.000015 mcu_task_stddev=0.000018 bytes_write=1113 bytes_read=16317 bytes_retransmit=0 bytes_invalid=0 send_seq=160 receive_seq=160 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999430 adj=49995811 Octopus_Max: temp=30.4 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.24 cputime=4.583 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4271.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9375 bytes_read=23707 bytes_retransmit=9 bytes_invalid=0 send_seq=643 receive_seq=643 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028307 rpi: mcu_awake=0.001 mcu_task_avg=0.000015 mcu_task_stddev=0.000018 bytes_write=1119 bytes_read=16333 bytes_retransmit=0 bytes_invalid=0 send_seq=161 receive_seq=161 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999428 adj=49995837 Octopus_Max: temp=30.4 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.4 sysload=0.24 cputime=4.610 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4272.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9381 bytes_read=23959 bytes_retransmit=9 bytes_invalid=0 send_seq=644 receive_seq=644 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028305 rpi: mcu_awake=0.001 mcu_task_avg=0.000015 mcu_task_stddev=0.000018 bytes_write=1125 bytes_read=16349 bytes_retransmit=0 bytes_invalid=0 send_seq=162 receive_seq=162 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999427 adj=49995844 Octopus_Max: temp=30.6 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.24 cputime=4.638 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4273.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9387 bytes_read=24210 bytes_retransmit=9 bytes_invalid=0 send_seq=645 receive_seq=645 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028316 rpi: mcu_awake=0.001 mcu_task_avg=0.000015 mcu_task_stddev=0.000018 bytes_write=1131 bytes_read=16365 bytes_retransmit=0 bytes_invalid=0 send_seq=163 receive_seq=163 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999427 adj=49995854 Octopus_Max: temp=30.7 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.24 cputime=4.665 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4274.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9393 bytes_read=24433 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028314 rpi: mcu_awake=0.001 mcu_task_avg=0.000015 mcu_task_stddev=0.000018 bytes_write=1137 bytes_read=16381 bytes_retransmit=0 bytes_invalid=0 send_seq=164 receive_seq=164 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999423 adj=49995846 Octopus_Max: temp=30.6 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.22 cputime=4.693 memavail=7502696 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4275.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9399 bytes_read=24699 bytes_retransmit=9 bytes_invalid=0 send_seq=647 receive_seq=647 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028304 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000024 bytes_write=1143 bytes_read=16410 bytes_retransmit=0 bytes_invalid=0 send_seq=165 receive_seq=165 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999423 adj=49995818 Octopus_Max: temp=30.7 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.22 cputime=4.720 memavail=7502700 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.2 pwm=0.000
Stats 4276.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9405 bytes_read=24936 bytes_retransmit=9 bytes_invalid=0 send_seq=648 receive_seq=648 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028284 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000024 bytes_write=1149 bytes_read=16426 bytes_retransmit=0 bytes_invalid=0 send_seq=166 receive_seq=166 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999415 adj=49995841 Octopus_Max: temp=30.7 Pi: temp=34.1  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.22 cputime=4.739 memavail=7496808 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4277.1: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9411 bytes_read=25159 bytes_retransmit=9 bytes_invalid=0 send_seq=649 receive_seq=649 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028263 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000024 bytes_write=1155 bytes_read=16442 bytes_retransmit=0 bytes_invalid=0 send_seq=167 receive_seq=167 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999407 adj=49995804 Octopus_Max: temp=30.6 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.22 cputime=4.755 memavail=7503184 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-169-g28faf814-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py, klippy/extras/state_notify.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:34:10 2024 (1713677650.2 4302.3)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
webhooks client 4123213912: New connection
webhooks client 4123213912: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': got {'oid': 24, 'next_clock': 136261632, 'value': 6181, '#name': 'analog_in_state', '#sent_time': 4303.842479805, '#receive_time': 4303.853039638}
mcu 'mcu': got {'oid': 26, 'next_clock': 144261632, 'value': 31429, '#name': 'analog_in_state', '#sent_time': 4303.842479805, '#receive_time': 4303.873075897}
mcu 'mcu': got {'oid': 27, 'next_clock': 148261632, 'value': 10865, '#name': 'analog_in_state', '#sent_time': 4303.842479805, '#receive_time': 4303.883054342}
mcu 'mcu': got {'oid': 0, 'next_clock': 56861632, 'count': 1, 'count_clock': 2000000000, '#name': 'counter_state', '#sent_time': 4303.943767731, '#receive_time': 4303.946837693}
mcu 'mcu': got {'oid': 1, 'next_clock': 60861632, 'count': 1, 'count_clock': 2004000000, '#name': 'counter_state', '#sent_time': 4303.943767731, '#receive_time': 4303.956847786}
mcu 'mcu': got {'oid': 41, 'next_clock': 204261632, 'value': 10861, '#name': 'analog_in_state', '#sent_time': 4303.994326342, '#receive_time': 4304.022991268}
Loaded MCU 'mcu' 112 commands (v0.12.0-169-g28faf814 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
mcu 'mcu': got {'oid': 24, 'next_clock': 256261632, 'value': 6180, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.152994527}
mcu 'mcu': got {'oid': 26, 'next_clock': 264261632, 'value': 31433, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.173003008}
mcu 'mcu': got {'oid': 27, 'next_clock': 268261632, 'value': 10864, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.182996453}
mcu 'mcu': got {'oid': 41, 'next_clock': 324261632, 'value': 10857, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.32301073}
mcu 'mcu': got {'oid': 24, 'next_clock': 376261632, 'value': 6178, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.452984564}
mcu 'mcu': got {'oid': 26, 'next_clock': 384261632, 'value': 31433, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.472987897}
mcu 'mcu': got {'oid': 27, 'next_clock': 388261632, 'value': 10862, '#name': 'analog_in_state', '#sent_time': 4304.148193323, '#receive_time': 4304.482971156}
Loaded MCU 'rpi' 118 commands (v0.12.0-169-g28faf814 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Configured MCU 'mcu' (1024 moves)
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)
Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
webhooks: registering remote method 'shutdown_machine' for connection id: 4123213912
webhooks: registering remote method 'reboot_machine' for connection id: 4123213912
webhooks: registering remote method 'pause_job_queue' for connection id: 4123213912
webhooks: registering remote method 'start_job_queue' for connection id: 4123213912
webhooks: registering remote method 'set_device_power' for connection id: 4123213912
Starting Klippy...
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-171-g2f6e94c9-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py, klippy/extras/state_notify.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:43:29 2024 (1713678209.7 4861.8)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-171-g2f6e94c9-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py, klippy/extras/state_notify.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:43:30 2024 (1713678210.5 4862.6)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
webhooks client 4127908288: New connection
webhooks client 4127908288: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
Loaded MCU 'mcu' 112 commands (v0.12.0-171-g2f6e94c9 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
Loaded MCU 'rpi' 118 commands (v0.12.0-169-g28faf814 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)

Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.


Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
Stats 4866.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9727 bytes_read=12790 bytes_retransmit=9 bytes_invalid=0 send_seq=723 receive_seq=723 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400019437 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=807 bytes_read=4693 bytes_retransmit=0 bytes_invalid=0 send_seq=103 receive_seq=103 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998392 adj=49995428 Octopus_Max: temp=37.4 Pi: temp=38.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.99 cputime=2.039 memavail=7502640 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 4127908288
webhooks: registering remote method 'reboot_machine' for connection id: 4127908288
webhooks: registering remote method 'pause_job_queue' for connection id: 4127908288
webhooks: registering remote method 'start_job_queue' for connection id: 4127908288
webhooks: registering remote method 'set_device_power' for connection id: 4127908288
Stats 4867.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9733 bytes_read=13027 bytes_retransmit=9 bytes_invalid=0 send_seq=724 receive_seq=724 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400023527 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=813 bytes_read=4709 bytes_retransmit=0 bytes_invalid=0 send_seq=104 receive_seq=104 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999413 adj=49995760 Octopus_Max: temp=37.4 Pi: temp=38.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.99 cputime=2.081 memavail=7501472 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4868.7: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9739 bytes_read=13263 bytes_retransmit=9 bytes_invalid=0 send_seq=725 receive_seq=725 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400025266 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=819 bytes_read=4725 bytes_retransmit=0 bytes_invalid=0 send_seq=105 receive_seq=105 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999227 adj=49996670 Octopus_Max: temp=37.4 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.99 cputime=2.092 memavail=7501472 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4869.7: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9745 bytes_read=13529 bytes_retransmit=9 bytes_invalid=0 send_seq=726 receive_seq=726 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400025631 rpi: mcu_awake=0.003 mcu_task_avg=0.000019 mcu_task_stddev=0.000010 bytes_write=825 bytes_read=4741 bytes_retransmit=0 bytes_invalid=0 send_seq=106 receive_seq=106 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999205 adj=49995778 Octopus_Max: temp=37.3 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.91 cputime=2.103 memavail=7501472 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4870.7: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9751 bytes_read=13761 bytes_retransmit=9 bytes_invalid=0 send_seq=727 receive_seq=727 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026249 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=831 bytes_read=4770 bytes_retransmit=0 bytes_invalid=0 send_seq=107 receive_seq=107 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999377 adj=49995693 Octopus_Max: temp=37.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.91 cputime=2.119 memavail=7501044 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4871.7: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9757 bytes_read=13979 bytes_retransmit=9 bytes_invalid=0 send_seq=728 receive_seq=728 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026619 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=837 bytes_read=4786 bytes_retransmit=0 bytes_invalid=0 send_seq=108 receive_seq=108 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999481 adj=49996001 Octopus_Max: temp=37.3 Pi: temp=38.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.91 cputime=2.138 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4872.7: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9763 bytes_read=14245 bytes_retransmit=9 bytes_invalid=0 send_seq=729 receive_seq=729 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026796 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=843 bytes_read=4802 bytes_retransmit=0 bytes_invalid=0 send_seq=109 receive_seq=109 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999432 adj=49996179 Octopus_Max: temp=37.4 Pi: temp=38.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.91 cputime=2.149 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4873.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9769 bytes_read=14496 bytes_retransmit=9 bytes_invalid=0 send_seq=730 receive_seq=730 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026884 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=849 bytes_read=4818 bytes_retransmit=0 bytes_invalid=0 send_seq=110 receive_seq=110 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999440 adj=49995958 Octopus_Max: temp=37.2 Pi: temp=37.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.91 cputime=2.160 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4874.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9775 bytes_read=14733 bytes_retransmit=9 bytes_invalid=0 send_seq=731 receive_seq=731 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026952 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=855 bytes_read=4834 bytes_retransmit=0 bytes_invalid=0 send_seq=111 receive_seq=111 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999448 adj=49995980 Octopus_Max: temp=37.4 Pi: temp=37.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.84 cputime=2.171 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4875.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9781 bytes_read=14985 bytes_retransmit=9 bytes_invalid=0 send_seq=732 receive_seq=732 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027029 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=867 bytes_read=4879 bytes_retransmit=0 bytes_invalid=0 send_seq=113 receive_seq=113 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999441 adj=49996001 Octopus_Max: temp=37.5 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.84 cputime=2.183 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4876.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9787 bytes_read=15222 bytes_retransmit=9 bytes_invalid=0 send_seq=733 receive_seq=733 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027414 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=873 bytes_read=4895 bytes_retransmit=0 bytes_invalid=0 send_seq=114 receive_seq=114 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999515 adj=49995961 Octopus_Max: temp=37.5 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.84 cputime=2.207 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4877.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9793 bytes_read=15459 bytes_retransmit=9 bytes_invalid=0 send_seq=734 receive_seq=734 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027652 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=879 bytes_read=4911 bytes_retransmit=0 bytes_invalid=0 send_seq=115 receive_seq=115 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999561 adj=49996080 Octopus_Max: temp=37.5 Pi: temp=36.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.84 cputime=2.232 memavail=7500568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4878.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9799 bytes_read=15725 bytes_retransmit=9 bytes_invalid=0 send_seq=735 receive_seq=735 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027805 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=885 bytes_read=4927 bytes_retransmit=0 bytes_invalid=0 send_seq=116 receive_seq=116 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999656 adj=49996144 Octopus_Max: temp=37.4 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.84 cputime=2.260 memavail=7500572 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 4879.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9805 bytes_read=15962 bytes_retransmit=9 bytes_invalid=0 send_seq=736 receive_seq=736 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028171 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=891 bytes_read=4943 bytes_retransmit=0 bytes_invalid=0 send_seq=117 receive_seq=117 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999649 adj=49996455 Octopus_Max: temp=37.6 Pi: temp=38.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.85 cputime=2.275 memavail=7499672 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4880.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9811 bytes_read=16199 bytes_retransmit=9 bytes_invalid=0 send_seq=737 receive_seq=737 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028037 rpi: mcu_awake=0.001 mcu_task_avg=0.000009 mcu_task_stddev=0.000010 bytes_write=897 bytes_read=4959 bytes_retransmit=0 bytes_invalid=0 send_seq=118 receive_seq=118 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999633 adj=49996145 Octopus_Max: temp=37.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.85 cputime=2.286 memavail=7499420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 4881.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9817 bytes_read=16440 bytes_retransmit=9 bytes_invalid=0 send_seq=738 receive_seq=738 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027983 rpi: mcu_awake=0.001 mcu_task_avg=0.000014 mcu_task_stddev=0.000015 bytes_write=903 bytes_read=4988 bytes_retransmit=0 bytes_invalid=0 send_seq=119 receive_seq=119 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999619 adj=49996147 Octopus_Max: temp=37.4 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.85 cputime=2.298 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4882.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9823 bytes_read=16675 bytes_retransmit=9 bytes_invalid=0 send_seq=739 receive_seq=739 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027949 rpi: mcu_awake=0.001 mcu_task_avg=0.000014 mcu_task_stddev=0.000015 bytes_write=909 bytes_read=5004 bytes_retransmit=0 bytes_invalid=0 send_seq=120 receive_seq=120 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999592 adj=49996109 Octopus_Max: temp=37.6 Pi: temp=36.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.85 cputime=2.309 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4883.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9829 bytes_read=16926 bytes_retransmit=9 bytes_invalid=0 send_seq=740 receive_seq=740 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027925 rpi: mcu_awake=0.001 mcu_task_avg=0.000014 mcu_task_stddev=0.000015 bytes_write=915 bytes_read=5020 bytes_retransmit=0 bytes_invalid=0 send_seq=121 receive_seq=121 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999569 adj=49995999 Octopus_Max: temp=37.5 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.85 cputime=2.320 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 4884.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9835 bytes_read=17178 bytes_retransmit=9 bytes_invalid=0 send_seq=741 receive_seq=741 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027980 rpi: mcu_awake=0.001 mcu_task_avg=0.000014 mcu_task_stddev=0.000015 bytes_write=921 bytes_read=5036 bytes_retransmit=0 bytes_invalid=0 send_seq=122 receive_seq=122 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999598 adj=49995916 Octopus_Max: temp=37.6 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.78 cputime=2.345 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4885.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9841 bytes_read=17415 bytes_retransmit=9 bytes_invalid=0 send_seq=742 receive_seq=742 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028269 rpi: mcu_awake=0.001 mcu_task_avg=0.000014 mcu_task_stddev=0.000015 bytes_write=927 bytes_read=5052 bytes_retransmit=0 bytes_invalid=0 send_seq=123 receive_seq=123 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999620 adj=49996078 Octopus_Max: temp=37.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.78 cputime=2.371 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4886.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9847 bytes_read=17652 bytes_retransmit=9 bytes_invalid=0 send_seq=743 receive_seq=743 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028263 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=933 bytes_read=5081 bytes_retransmit=0 bytes_invalid=0 send_seq=124 receive_seq=124 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999634 adj=49996001 Octopus_Max: temp=37.5 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.78 cputime=2.398 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 4887.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9853 bytes_read=17904 bytes_retransmit=9 bytes_invalid=0 send_seq=744 receive_seq=744 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028258 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=939 bytes_read=5097 bytes_retransmit=0 bytes_invalid=0 send_seq=125 receive_seq=125 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999650 adj=49996111 Octopus_Max: temp=37.5 Pi: temp=37.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.78 cputime=2.425 memavail=7499428 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
webhooks client 4127908288: Disconnected
b'Got EOF when reading from device'
webhooks client 4128263472: New connection
webhooks client 4128263472: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
webhooks: registering remote method 'shutdown_machine' for connection id: 4128263472
webhooks: registering remote method 'reboot_machine' for connection id: 4128263472
webhooks: registering remote method 'pause_job_queue' for connection id: 4128263472
webhooks: registering remote method 'start_job_queue' for connection id: 4128263472
webhooks: registering remote method 'set_device_power' for connection id: 4128263472
Timeout with MCU 'mcu' (eventtime=4919.728236)
Transition to shutdown state: Lost communication with MCU 'mcu'
Dumping gcode input 0 blocks
Dumping 20 requests for client 4128263472
Received 4916.339581: b'{"id": 3873724232, "method": "objects/subscribe", "params": {"objects": {"webhooks": null}, "response_template": {"method": "process_status_update"}}}'
Received 4916.348399: b'{"id": 3873723752, "method": "gcode/subscribe_output", "params": {"response_template": {"method": "process_gcode_response"}}}'
Received 4916.368700: b'{"id": 3873725192, "method": "list_endpoints", "params": {}}'
Received 4916.374295: b'{"id": 3873723104, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null}, "response_template": {"method": "process_status_update"}}}'
Received 4916.592616: b'{"id": 4122049312, "method": "objects/list", "params": {}}'
Received 4916.594582: b'{"id": 4122049312, "method": "objects/query", "params": {"objects": {"configfile": null}}}'
Received 4916.850286: b'{"id": 4122049312, "method": "register_remote_method", "params": {"response_template": {"method": "shutdown_machine"}, "remote_method": "shutdown_machine"}}'
Received 4916.852030: b'{"id": 4121774904, "method": "register_remote_method", "params": {"response_template": {"method": "reboot_machine"}, "remote_method": "reboot_machine"}}'
Received 4916.853399: b'{"id": 3863929568, "method": "register_remote_method", "params": {"response_template": {"method": "pause_job_queue"}, "remote_method": "pause_job_queue"}}'
Received 4916.854614: b'{"id": 3873745432, "method": "register_remote_method", "params": {"response_template": {"method": "start_job_queue"}, "remote_method": "start_job_queue"}}'
Received 4916.855780: b'{"id": 3873745432, "method": "register_remote_method", "params": {"response_template": {"method": "set_device_power"}, "remote_method": "set_device_power"}}'
Received 4916.858195: b'{"id": 3873739296, "method": "objects/query", "params": {"objects": {"heaters": null}}}'
Received 4916.858595: b'{"id": 3873738936, "method": "objects/query", "params": {"objects": {"heaters": null}}}'
Received 4916.863988: b'{"id": 3873741552, "method": "info", "params": {}}'
Received 4916.863988: b'{"id": 3873680472, "method": "objects/list", "params": {}}'
Received 4916.864973: b'{"id": 3873725168, "method": "gcode/help", "params": {}}'
Received 4916.889662: b'{"id": 3873677880, "method": "objects/subscribe", "params": {"objects": {"gcode": null, "webhooks": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_sensor Octopus_Max": null, "temperature_host Pi": null, "temperature_sensor Pi": null, "idle_timeout": null, "gcode_move": null, "print_stats": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null, "extruder": null}, "response_template": {"method": "process_status_update"}}}'
Received 4917.108990: b'{"id": 3882626376, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null, "temperature_sensor Octopus_Max": null, "temperature_sensor Pi": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "extruder": null, "gcode": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_host Pi": null, "idle_timeout": null, "gcode_move": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null}, "response_template": {"method": "process_status_update"}}}'
Received 4917.342196: b'{"id": 3873678480, "method": "objects/query", "params": {"objects": {"extruder": ["can_extrude"]}}}'
Received 4917.355954: b'{"id": 3863932376, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null, "temperature_sensor Octopus_Max": null, "temperature_sensor Pi": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "extruder": null, "gcode": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_host Pi": null, "idle_timeout": null, "gcode_move": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null}, "response_template": {"method": "process_status_update"}}}'
gcode state: absolute_coord=True absolute_extrude=True base_position=[0.0, 0.0, 0.0, 0.0] last_position=[0.0, 0.0, 0.0, 0.0] homing_position=[0.0, 0.0, 0.0, 0.0] speed_factor=0.016666666666666666 extrude_factor=1.0 speed=25.0
Reactor garbage collection: (4917.109505939, 0.0, 0.0)
MCU 'rpi' shutdown: Command request
clocksync state: mcu_freq=50000000 last_clock=245548183881 clock_est=(4894.826 244339231993 49999548.505) min_half_rtt=0.000040 min_rtt_time=4864.854 time_avg=4894.826(343.385) clock_avg=244339231993.822(17169116368.533) pred_variance=292297520.079 clock_adj=(-4820.115 49995809.250)
Dumping serial stats: bytes_write=1137 bytes_read=5693 bytes_retransmit=0 bytes_invalid=0 send_seq=158 receive_seq=158 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0
Dumping send queue 100 messages
Sent 0 4864.417017 4864.417017 9: seq: 1a, identify offset=1960 count=40
Sent 1 4864.417305 4864.417305 9: seq: 1b, identify offset=2000 count=40
Sent 2 4864.417592 4864.417592 9: seq: 1c, identify offset=2040 count=40
Sent 3 4864.417893 4864.417893 9: seq: 1d, identify offset=2080 count=40
Sent 4 4864.418178 4864.418178 9: seq: 1e, identify offset=2120 count=40
Sent 5 4864.418462 4864.418462 9: seq: 1f, identify offset=2160 count=40
Sent 6 4864.418742 4864.418742 9: seq: 10, identify offset=2200 count=40
Sent 7 4864.419024 4864.419024 9: seq: 11, identify offset=2240 count=40
Sent 8 4864.419307 4864.419307 9: seq: 12, identify offset=2280 count=40
Sent 9 4864.419591 4864.419591 9: seq: 13, identify offset=2320 count=40
Sent 10 4864.419874 4864.419874 9: seq: 14, identify offset=2360 count=40
Sent 11 4864.420158 4864.420158 9: seq: 15, identify offset=2400 count=40
Sent 12 4864.420441 4864.420441 9: seq: 16, identify offset=2440 count=40
Sent 13 4864.420727 4864.420727 9: seq: 17, identify offset=2480 count=40
Sent 14 4864.421034 4864.421034 9: seq: 18, identify offset=2520 count=40
Sent 15 4864.421323 4864.421323 9: seq: 19, identify offset=2560 count=40
Sent 16 4864.421610 4864.421610 9: seq: 1a, identify offset=2600 count=40
Sent 17 4864.421893 4864.421893 9: seq: 1b, identify offset=2640 count=40
Sent 18 4864.422175 4864.422175 9: seq: 1c, identify offset=2680 count=40
Sent 19 4864.422456 4864.422456 9: seq: 1d, identify offset=2720 count=40
Sent 20 4864.422738 4864.422738 9: seq: 1e, identify offset=2760 count=40
Sent 21 4864.423020 4864.423020 9: seq: 1f, identify offset=2800 count=40
Sent 22 4864.423301 4864.423301 9: seq: 10, identify offset=2840 count=40
Sent 23 4864.423581 4864.423581 9: seq: 11, identify offset=2880 count=40
Sent 24 4864.423861 4864.423861 9: seq: 12, identify offset=2920 count=40
Sent 25 4864.424139 4864.424139 9: seq: 13, identify offset=2960 count=40
Sent 26 4864.424420 4864.424420 9: seq: 14, identify offset=3000 count=40
Sent 27 4864.424700 4864.424700 9: seq: 15, identify offset=3040 count=40
Sent 28 4864.425003 4864.425003 9: seq: 16, identify offset=3080 count=40
Sent 29 4864.425288 4864.425288 9: seq: 17, identify offset=3120 count=40
Sent 30 4864.425571 4864.425571 9: seq: 18, identify offset=3160 count=40
Sent 31 4864.425854 4864.425854 9: seq: 19, identify offset=3200 count=40
Sent 32 4864.426136 4864.426136 9: seq: 1a, identify offset=3233 count=40
Sent 33 4864.448778 4864.448778 6: seq: 1b, get_uptime
Sent 34 4864.499649 4864.499649 6: seq: 1c, get_clock
Sent 35 4864.550188 4864.550188 6: seq: 1d, get_clock
Sent 36 4864.601253 4864.601253 6: seq: 1e, get_clock
Sent 37 4864.651791 4864.651791 6: seq: 1f, get_clock
Sent 38 4864.702242 4864.702242 6: seq: 10, get_clock
Sent 39 4864.752671 4864.752671 6: seq: 11, get_clock
Sent 40 4864.803778 4864.803778 6: seq: 12, get_clock
Sent 41 4864.854310 4864.854310 6: seq: 13, get_clock
Sent 42 4864.855393 4864.855393 6: seq: 14, get_clock
Sent 43 4864.870513 4864.870513 6: seq: 15, get_config
Sent 44 4865.839704 4865.839704 6: seq: 16, get_clock
Sent 45 4866.824107 4866.824107 6: seq: 17, get_clock
Sent 46 4867.808555 4867.808555 6: seq: 18, get_clock
Sent 47 4868.793239 4868.793239 6: seq: 19, get_clock
Sent 48 4869.777902 4869.777902 6: seq: 1a, get_clock
Sent 49 4870.762509 4870.762509 6: seq: 1b, get_clock
Sent 50 4871.746631 4871.746631 6: seq: 1c, get_clock
Sent 51 4872.731349 4872.731349 6: seq: 1d, get_clock
Sent 52 4873.716214 4873.716214 6: seq: 1e, get_clock
Sent 53 4874.700746 4874.700746 6: seq: 1f, get_clock
Sent 54 4875.685209 4875.685209 6: seq: 10, get_clock
Sent 55 4876.670292 4876.670292 6: seq: 11, get_clock
Sent 56 4877.654684 4877.654684 6: seq: 12, get_clock
Sent 57 4878.639115 4878.639115 6: seq: 13, get_clock
Sent 58 4879.623779 4879.623779 6: seq: 14, get_clock
Sent 59 4880.608550 4880.608550 6: seq: 15, get_clock
Sent 60 4881.592971 4881.592971 6: seq: 16, get_clock
Sent 61 4882.577683 4882.577683 6: seq: 17, get_clock
Sent 62 4883.562559 4883.562559 6: seq: 18, get_clock
Sent 63 4884.547592 4884.547592 6: seq: 19, get_clock
Sent 64 4885.531988 4885.531988 6: seq: 1a, get_clock
Sent 65 4886.516217 4886.516217 6: seq: 1b, get_clock
Sent 66 4887.500434 4887.500434 6: seq: 1c, get_clock
Sent 67 4888.484782 4888.484782 6: seq: 1d, get_clock
Sent 68 4889.469167 4889.469167 6: seq: 1e, get_clock
Sent 69 4890.453449 4890.453449 6: seq: 1f, get_clock
Sent 70 4891.437979 4891.437979 6: seq: 10, get_clock
Sent 71 4892.422830 4892.422830 6: seq: 11, get_clock
Sent 72 4893.407472 4893.407472 6: seq: 12, get_clock
Sent 73 4894.393670 4894.393670 6: seq: 13, get_clock
Sent 74 4895.377677 4895.377677 6: seq: 14, get_clock
Sent 75 4896.362191 4896.362191 6: seq: 15, get_clock
Sent 76 4897.346631 4897.346631 6: seq: 16, get_clock
Sent 77 4898.330904 4898.330904 6: seq: 17, get_clock
Sent 78 4899.315381 4899.315381 6: seq: 18, get_clock
Sent 79 4900.299516 4900.299516 6: seq: 19, get_clock
Sent 80 4901.284353 4901.284353 6: seq: 1a, get_clock
Sent 81 4902.268474 4902.268474 6: seq: 1b, get_clock
Sent 82 4903.252674 4903.252674 6: seq: 1c, get_clock
Sent 83 4904.236958 4904.236958 6: seq: 1d, get_clock
Sent 84 4905.221215 4905.221215 6: seq: 1e, get_clock
Sent 85 4906.206135 4906.206135 6: seq: 1f, get_clock
Sent 86 4907.190284 4907.190284 6: seq: 10, get_clock
Sent 87 4908.174615 4908.174615 6: seq: 11, get_clock
Sent 88 4909.159688 4909.159688 6: seq: 12, get_clock
Sent 89 4910.143848 4910.143848 6: seq: 13, get_clock
Sent 90 4911.128730 4911.128730 6: seq: 14, get_clock
Sent 91 4912.113348 4912.113348 6: seq: 15, get_clock
Sent 92 4913.097687 4913.097687 6: seq: 16, get_clock
Sent 93 4914.082193 4914.082193 6: seq: 17, get_clock
Sent 94 4915.067006 4915.067006 6: seq: 18, get_clock
Sent 95 4916.051582 4916.051582 6: seq: 19, get_clock
Sent 96 4917.035901 4917.035901 6: seq: 1a, get_clock
Sent 97 4918.020507 4918.020507 6: seq: 1b, get_clock
Sent 98 4919.004855 4919.004855 6: seq: 1c, get_clock
Sent 99 4919.730629 4919.730629 6: seq: 1d, emergency_stop
Dumping receive queue 100 messages
Receive: 0 4864.420237 4864.420158 49: seq: 16, identify_response offset=2400 data=b'S2\xea(g,}\x82\nK.\x8f\xca\x9c\xf8\x13\x14\x98%\xde\xf2Q\xdf\x89b\x1b1D35f\xce\xd8\x02\x9e\xc5\xda5v\xc0'
Receive: 1 4864.420520 4864.420441 49: seq: 17, identify_response offset=2440 data=b'`1\xe5w\x95;\xf3\x1f\xa3n\xb5#\x1e\xbb\x8e\xed\n%\x13\x92\x076\xfc\xde\xfb*\xa2\xfd\x9e\xea\xbdS\x7f\xfc\xbd\x92"R\x82['
Receive: 2 4864.420819 4864.420727 49: seq: 18, identify_response offset=2480 data=b'\x92\\50\xdf\xc3\x08t\xff\x19\x9bd\xdawHzX\xb3\x10\xd4X\x0b\xc1T\xffC[\xdca4\xea\xb4"+i\x10\x06\xf5\xf8\x1c'
Receive: 3 4864.421114 4864.421034 49: seq: 19, identify_response offset=2520 data=b'\x02h\x02\\,\xae\x00\t\xd3XS\xd3\xc9\x81\x95\xc7Y\xfa.\xea\x1e/\x90\x8a\xaat\xe0\xf51X\xc7\x02\x1b\x89\rn\x9c\x1d\xe1\xba'
Receive: 4 4864.421402 4864.421323 49: seq: 1a, identify_response offset=2560 data=b"\x93R\x9d\xb4\x04\xfb\x1c\x81\xf6r\xea\xeb-\xb0P\xd1\x8e\xd0\xd2#4';z\xa9s`\x15\x8df\xac\x84>\x18\xc3\xef\xed\xbb\xb7\xaa"
Receive: 5 4864.421688 4864.421610 49: seq: 1b, identify_response offset=2600 data=b'\xb2\xa3\xee\xdb1L\xf6\x1c\x93\x86$Y\x02\xdb\xae=\xbf\xc3\xc8\xa3lo\xc1\xc5\x8cI\xed\x00\x8d\xd4\xb4\xbfJfwH\xddL\\\xba'
Receive: 6 4864.421970 4864.421893 49: seq: 1c, identify_response offset=2640 data=b'\x17\xd4\x93\xd70\x02\xcc\xce\x00\xb7\xab^\x7f\xf3\xf20\xb5\xf7\xa0|\x90\xaaT\xf4\xa8\xe8\xcdK\x07\x00n\xc8\xeb\xe9 \x8bN\x1d\xaa-'
Receive: 7 4864.422252 4864.422175 49: seq: 1d, identify_response offset=2680 data=b'\xc9J\xc9T\xc5\x11\xaf\xe7OCp\x9e\x1a\xf2\x98\x07X\x80\x98P\xe9\x895\x91\xedQ\x87\xf9\x92\xfd\x02\xf9\x10\xd49wX\xa6\xed\xf0'
Receive: 8 4864.422534 4864.422456 49: seq: 1e, identify_response offset=2720 data=b'\x85A\xfe\x8d\xaaA\xf5>mS#\xfdj]\xd1\xb3\x81\xc4>-zx\xf2=%\x80\x11\x84u5$e\xeaA\xf1\xe7\xab\xeb\x1f\xe9'
Receive: 9 4864.422817 4864.422738 49: seq: 1f, identify_response offset=2760 data=b'\x85\xc7\xbcq\xa8\xf2\x18\r\xac.\x06\xcc"\xb0\x1dp\xa2\x06D\xab&\xa7\x8e/F:\xa9"\'\x88\x95/\xa4\x9fG\xaf*\x98\x7fB'
Receive: 10 4864.423097 4864.423020 49: seq: 10, identify_response offset=2800 data=b'A\x17\x05Y\x92\xa8\x84[\x0fR\x95q\xd3 M\x94\x8b\x80A\x9an\xe0;\xfa\x08+\xd5p1-\x1a\xfb\n\x9f\xf1\xdf\xbc\xfb\xe9!'
Receive: 11 4864.423379 4864.423301 49: seq: 11, identify_response offset=2840 data=b'Z\xa9>\x10$1\x92KW\xd2\xe5\xa2\x9du\x13\x95\xc7\xceOu\x9f\xce1{4\xef\xee3\x92\xc2k\xb32\x05\xa1\x06\xc19\xe6\x8b'
Receive: 12 4864.423659 4864.423581 49: seq: 12, identify_response offset=2880 data=b'\x94\x0b\xb9z\xfc\xdc=\x89\x83\x9f\xd0\x0f\x10\xaadW\xef\x148g\xeeU\xf5A <\xe4\xb6\xad\x85\xe4\x01\x92\xab\xfe\xed\xa7\x18\xd7$'
Receive: 13 4864.423938 4864.423861 49: seq: 13, identify_response offset=2920 data=b'\xfa#\xf7\xf6\x0f\xb6\xeeuH\x82\x97\xb4\x8f=\xe7\xe8\xbaug\xd7\xc0>%\x14A^V\xaf\xea=\x0b\xcd\xd8:t\r\xd8\xe3\xf1"'
Receive: 14 4864.424216 4864.424139 49: seq: 14, identify_response offset=2960 data=b"\xfe\xc3\x0f\xee\xbdq\xaf\x1d\xb9\xb9'\xaf\xbf\xaa\xc6F\xac\x91{Q\xf0p\xed\xd3\x02\xb5h.\x10\x17\x9fF\x9c@\xd9\xb2\xbe!\x99B"
Receive: 15 4864.424498 4864.424420 49: seq: 15, identify_response offset=3000 data=b'\xf9\xb3z\xb1\xbd\xec\x1d\xc0\xbc3\xf8\xc2L\xbd\xd7\x84\xb9\xcc\xe4T\x96\xea\x89D\x1d\x0f\x18\x016\xfdW\xba\xf3\x88\xec\r\xec\x1f*\xc5'
Receive: 16 4864.424793 4864.424700 49: seq: 16, identify_response offset=3040 data=b'\xfa~\xd6e\x92\x98\xe5\xb5%_\xbcG\x9cc\xbe\xe7\xd3\xcc\x1a\xcb\xaei\xaa{\xc3\xa6\x97C\xbdG\x7f\xc9\xbbi\xb7\xe3\x10o\xa9\xeb'
Receive: 17 4864.425083 4864.425003 49: seq: 17, identify_response offset=3080 data=b'\x0f\xc5\x108\x95\xdcd"R\xab\x1a\xe6#.\xf1\xb6\xcf\x14\xa7e\x18\x9dj$\x1e\xdd\xa4\xdf\x9a\xf6\xaf\x14]\xa5\xdf\xb9\xfb\xac\n\xc4'
Receive: 18 4864.425367 4864.425288 49: seq: 18, identify_response offset=3120 data=b'\xaaX\x1dF\x95\xb0o\x03*]\xa5S{95\xfaG\xfe\xa1\xaej\x1b\xbbf\xdc\xa2SG\x0f?\x02\x97\xcd\x16N\xe8/\x98\xc1d'
Receive: 19 4864.425650 4864.425571 49: seq: 19, identify_response offset=3160 data=b'\xcc\x00\xef\xd9o\xe0\x1d\x1f\x01[w\xc4~\xe07\xe5\x9c\xae\x95\x85\xed\x10\x9e|\xd8\xf2\xfd\x08V\xe1\xf4^\xc9\xe8\xff\x01&\x0f\xbaM'
Receive: 20 4864.425933 4864.425854 42: seq: 1a, identify_response offset=3200 data=b"\xc0\t\xea\xff\x82\x02'\xf8\xb0\xbe\x08\xc2\x8b5\xa8\xeb\xf6|\x1ff\xbbb\x97\x05\xf1\xea\xe3\x7f\x00\xeb\xfca\xe4"
Receive: 21 4864.426214 4864.426136 9: seq: 1b, identify_response offset=3233 data=b''
Receive: 22 4864.448926 4864.448778 12: seq: 1c, uptime high=56 clock=2302238078
Receive: 23 4864.499755 4864.499649 11: seq: 1d, clock clock=2304780381
Receive: 24 4864.550302 4864.550188 11: seq: 1e, clock clock=2307307631
Receive: 25 4864.601373 4864.601253 11: seq: 1f, clock clock=2309861225
Receive: 26 4864.651871 4864.651791 11: seq: 10, clock clock=2312386245
Receive: 27 4864.702329 4864.702242 11: seq: 11, clock clock=2314909101
Receive: 28 4864.752771 4864.752671 11: seq: 12, clock clock=2317430163
Receive: 29 4864.803896 4864.803778 11: seq: 13, clock clock=2319987234
Receive: 30 4864.854389 4864.854310 11: seq: 14, clock clock=2322512053
Receive: 31 4864.855510 4864.855393 11: seq: 15, clock clock=2322567158
Receive: 32 4864.870654 4864.870513 15: seq: 16, config is_config=1 crc=3912464276 is_shutdown=0 move_count=1024
Receive: 33 4865.640885 4864.870513 14: seq: 16, stats count=144 sum=134872 sumsq=627905
Receive: 34 4865.839832 4865.839704 11: seq: 17, clock clock=2371783409
Receive: 35 4866.824289 4866.824107 11: seq: 18, clock clock=2421003725
Receive: 36 4867.808659 4867.808555 11: seq: 19, clock clock=2470223595
Receive: 37 4868.793340 4868.793239 11: seq: 1a, clock clock=2519457240
Receive: 38 4869.778043 4869.777902 11: seq: 1b, clock clock=2568691693
Receive: 39 4870.641005 4869.777902 13: seq: 1b, stats count=55 sum=23916 sumsq=83969
Receive: 40 4870.762652 4870.762509 11: seq: 1c, clock clock=2617921905
Receive: 41 4871.746734 4871.746631 11: seq: 1d, clock clock=2667125601
Receive: 42 4872.731467 4872.731349 11: seq: 1e, clock clock=2716361744
Receive: 43 4873.716334 4873.716214 11: seq: 1f, clock clock=2765604551
Receive: 44 4874.700876 4874.700746 11: seq: 10, clock clock=2814830586
Receive: 45 4875.685335 4875.685209 11: seq: 11, clock clock=2864052635
Receive: 46 4875.685345 4875.685209 13: seq: 11, stats count=56 sum=25381 sumsq=102230
Receive: 47 4876.670574 4876.670292 11: seq: 12, clock clock=2913310007
Receive: 48 4877.654936 4877.654684 11: seq: 13, clock clock=2962528973
Receive: 49 4878.639416 4878.639115 11: seq: 14, clock clock=3011753911
Receive: 50 4879.623933 4879.623779 11: seq: 15, clock clock=3060981837
Receive: 51 4880.608691 4880.608550 11: seq: 16, clock clock=3110219230
Receive: 52 4880.740998 4880.608550 13: seq: 16, stats count=56 sum=39615 sumsq=235928
Receive: 53 4881.593108 4881.592971 11: seq: 17, clock clock=3159439723
Receive: 54 4882.577791 4882.577683 11: seq: 18, clock clock=3208673507
Receive: 55 4883.562663 4883.562559 11: seq: 19, clock clock=3257916559
Receive: 56 4884.547870 4884.547592 11: seq: 1a, clock clock=3307172786
Receive: 57 4885.532267 4885.531988 11: seq: 1b, clock clock=3356392143
Receive: 58 4885.741249 4885.531988 13: seq: 1b, stats count=55 sum=33783 sumsq=204757
Receive: 59 4886.516484 4886.516217 11: seq: 1c, clock clock=3405602831
Receive: 60 4887.500719 4887.500434 11: seq: 1d, clock clock=3454813910
Receive: 61 4888.485161 4888.484782 11: seq: 1e, clock clock=3504029913
Receive: 62 4889.469443 4889.469167 11: seq: 1f, clock clock=3553249321
Receive: 63 4890.453744 4890.453449 11: seq: 10, clock clock=3602463683
Receive: 64 4890.841311 4890.453449 13: seq: 10, stats count=56 sum=55953 sumsq=510065
Receive: 65 4891.438359 4891.437979 11: seq: 11, clock clock=3651690579
Receive: 66 4892.423198 4892.422830 11: seq: 12, clock clock=3700931953
Receive: 67 4893.407807 4893.407472 11: seq: 13, clock clock=3750163074
Receive: 68 4894.394065 4894.393670 11: seq: 14, clock clock=3799473654
Receive: 69 4895.377831 4895.377677 11: seq: 15, clock clock=3848668253
Receive: 70 4895.941163 4895.377677 13: seq: 15, stats count=56 sum=50836 sumsq=430889
Receive: 71 4896.362293 4896.362191 11: seq: 16, clock clock=3897892247
Receive: 72 4897.346730 4897.346631 11: seq: 17, clock clock=3947113690
Receive: 73 4898.331011 4898.330904 11: seq: 18, clock clock=3996326918
Receive: 74 4899.315480 4899.315381 11: seq: 19, clock clock=4045550053
Receive: 75 4900.299789 4900.299516 11: seq: 1a, clock clock=4094761267
Receive: 76 4900.941442 4900.299516 13: seq: 1a, stats count=55 sum=26613 sumsq=133185
Receive: 77 4901.284642 4901.284353 11: seq: 1b, clock clock=4144003023
Receive: 78 4902.268816 4902.268474 11: seq: 1c, clock clock=4193208727
Receive: 79 4903.253001 4903.252674 10: seq: 1d, clock clock=4242417683
Receive: 80 4904.237366 4904.236958 10: seq: 1e, clock clock=4291634852
Receive: 81 4905.221587 4905.221215 10: seq: 1f, clock clock=45878171
Receive: 82 4905.941509 4905.221215 13: seq: 1f, stats count=55 sum=58497 sumsq=580935
Receive: 83 4906.206503 4906.206135 10: seq: 10, clock clock=95123657
Receive: 84 4907.190673 4907.190284 10: seq: 11, clock clock=144331559
Receive: 85 4908.174953 4908.174615 10: seq: 12, clock clock=193545660
Receive: 86 4909.160020 4909.159688 11: seq: 13, clock clock=242798488
Receive: 87 4910.144098 4910.143848 11: seq: 14, clock clock=292004986
Receive: 88 4910.941596 4910.143848 13: seq: 14, stats count=55 sum=55258 sumsq=471465
Receive: 89 4911.129009 4911.128730 11: seq: 15, clock clock=341248487
Receive: 90 4912.113468 4912.113348 11: seq: 16, clock clock=390475365
Receive: 91 4913.097807 4913.097687 11: seq: 17, clock clock=439691806
Receive: 92 4914.082314 4914.082193 11: seq: 18, clock clock=488916721
Receive: 93 4915.067109 4915.067006 11: seq: 19, clock clock=538157147
Receive: 94 4916.041390 4915.067006 13: seq: 19, stats count=56 sum=27569 sumsq=143449
Receive: 95 4916.051750 4916.051582 11: seq: 1a, clock clock=587388462
Receive: 96 4917.036025 4917.035901 11: seq: 1b, clock clock=636601821
Receive: 97 4918.020621 4918.020507 11: seq: 1c, clock clock=685831217
Receive: 98 4919.004965 4919.004855 11: seq: 1d, clock clock=735048009
Receive: 99 4919.730854 4919.730629 12: seq: 1e, shutdown clock=771339341 static_string_id=Command request
Unable to issue reset command on MCU 'mcu'
Attempting MCU 'rpi' config_reset command
b'Got EOF when reading from device'
webhooks client 4128263472: Disconnected
Restarting printer
Start printer at Sun Apr 21 06:45:54 2024 (1713678354.9 5007.0)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}

[state_notify]

[gcode_macro STATE_NOTIFY_EXAMPLE]
description = Display the state_notify state
gcode = 
	{% set st = printer.state_notify %}
	{action_respond_info("state_notify: state=%s, timeout=%" % (st.state, st.timeout))}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
webhooks client 4127756144: New connection
webhooks client 4127756144: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
Loaded MCU 'mcu' 112 commands (v0.12.0-171-g2f6e94c9 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
Loaded MCU 'rpi' 118 commands (v0.12.0-171-g2f6e94c9 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'rpi' printer configuration...
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)

Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.


Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Script running error
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_button.py", line 41, in button_callback
    self.gcode.run_script(template.render())
  File "/home/pi/klipper/klippy/gcode.py", line 229, in run_script
    self._process_commands(script.split('\n'), need_ack=False)
  File "/home/pi/klipper/klippy/gcode.py", line 211, in _process_commands
    handler(gcmd)
  File "/home/pi/klipper/klippy/gcode.py", line 285, in cmd_default
    raise gcmd.error(self.printer.get_state_message()[0])
gcode.CommandError: 
Printer is not ready
The klippy host software is attempting to connect.  Please
retry in a few moments.

Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
state_notify: changing state from none to ready
state_notify:   running template: ready
Stats 5016.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9712 bytes_read=12868 bytes_retransmit=9 bytes_invalid=0 send_seq=720 receive_seq=720 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400021421 rpi: mcu_awake=0.007 mcu_task_avg=0.000046 mcu_task_stddev=0.000030 bytes_write=826 bytes_read=4628 bytes_retransmit=0 bytes_invalid=0 send_seq=112 receive_seq=112 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49996993 adj=49985982 Octopus_Max: temp=35.5 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.13 cputime=6.230 memavail=7496548 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
state_notify: changing state from ready to inactive
state_notify:   running template: inactive
webhooks: registering remote method 'shutdown_machine' for connection id: 4127756144
webhooks: registering remote method 'reboot_machine' for connection id: 4127756144
webhooks: registering remote method 'pause_job_queue' for connection id: 4127756144
webhooks: registering remote method 'start_job_queue' for connection id: 4127756144
webhooks: registering remote method 'set_device_power' for connection id: 4127756144
Stats 5017.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9718 bytes_read=13105 bytes_retransmit=9 bytes_invalid=0 send_seq=721 receive_seq=721 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400023961 rpi: mcu_awake=0.007 mcu_task_avg=0.000046 mcu_task_stddev=0.000030 bytes_write=832 bytes_read=4644 bytes_retransmit=0 bytes_invalid=0 send_seq=113 receive_seq=113 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49998497 adj=49998662 Octopus_Max: temp=35.5 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.13 cputime=6.278 memavail=7498456 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5018.2: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9724 bytes_read=13383 bytes_retransmit=9 bytes_invalid=0 send_seq=722 receive_seq=722 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400024940 rpi: mcu_awake=0.007 mcu_task_avg=0.000046 mcu_task_stddev=0.000030 bytes_write=838 bytes_read=4660 bytes_retransmit=0 bytes_invalid=0 send_seq=114 receive_seq=114 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999080 adj=49999668 Octopus_Max: temp=35.5 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.13 cputime=6.290 memavail=7498456 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 5019.2: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9730 bytes_read=13595 bytes_retransmit=9 bytes_invalid=0 send_seq=723 receive_seq=723 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400025841 rpi: mcu_awake=0.007 mcu_task_avg=0.000046 mcu_task_stddev=0.000030 bytes_write=844 bytes_read=4676 bytes_retransmit=0 bytes_invalid=0 send_seq=115 receive_seq=115 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999209 adj=49999551 Octopus_Max: temp=35.4 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.12 cputime=6.304 memavail=7498456 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Error evaluating 'gcode_macro STATE_NOTIFY_EXAMPLE:gcode': ValueError: incomplete format
Traceback (most recent call last):
  File "/home/pi/klipper/klippy/extras/gcode_macro.py", line 61, in render
    return str(self.template.render(context))
  File "/home/pi/klippy-env/lib/python3.9/site-packages/jinja2/environment.py", line 1090, in render
    self.environment.handle_exception()
  File "/home/pi/klippy-env/lib/python3.9/site-packages/jinja2/environment.py", line 832, in handle_exception
    reraise(*rewrite_traceback_stack(source=source))
  File "/home/pi/klippy-env/lib/python3.9/site-packages/jinja2/_compat.py", line 28, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 3, in top-level template code
ValueError: incomplete format
Error evaluating 'gcode_macro STATE_NOTIFY_EXAMPLE:gcode': ValueError: incomplete format

Stats 5020.2: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9736 bytes_read=13832 bytes_retransmit=9 bytes_invalid=0 send_seq=724 receive_seq=724 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400026908 rpi: mcu_awake=0.007 mcu_task_avg=0.000046 mcu_task_stddev=0.000030 bytes_write=850 bytes_read=4692 bytes_retransmit=0 bytes_invalid=0 send_seq=116 receive_seq=116 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999618 adj=49998678 Octopus_Max: temp=35.5 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.12 cputime=6.340 memavail=7498520 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5021.2: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9742 bytes_read=14098 bytes_retransmit=9 bytes_invalid=0 send_seq=725 receive_seq=725 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027844 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=856 bytes_read=4721 bytes_retransmit=0 bytes_invalid=0 send_seq=117 receive_seq=117 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999935 adj=49998680 Octopus_Max: temp=35.6 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.12 cputime=6.368 memavail=7498520 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5022.2: gcodein=0  mcu: mcu_awake=0.016 mcu_task_avg=0.000008 mcu_task_stddev=0.000057 bytes_write=9748 bytes_read=14321 bytes_retransmit=9 bytes_invalid=0 send_seq=726 receive_seq=726 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028265 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=862 bytes_read=4737 bytes_retransmit=0 bytes_invalid=0 send_seq=118 receive_seq=118 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000030 adj=49998611 Octopus_Max: temp=35.7 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.12 cputime=6.394 memavail=7498520 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 5023.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9754 bytes_read=14572 bytes_retransmit=9 bytes_invalid=0 send_seq=727 receive_seq=727 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028935 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=874 bytes_read=4769 bytes_retransmit=0 bytes_invalid=0 send_seq=120 receive_seq=120 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000113 adj=49998191 Octopus_Max: temp=35.6 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.12 cputime=6.423 memavail=7498520 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5024.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9760 bytes_read=14838 bytes_retransmit=9 bytes_invalid=0 send_seq=728 receive_seq=728 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028796 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=880 bytes_read=4785 bytes_retransmit=0 bytes_invalid=0 send_seq=121 receive_seq=121 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000086 adj=49997756 Octopus_Max: temp=35.7 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.11 cputime=6.451 memavail=7498536 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5025.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9766 bytes_read=15061 bytes_retransmit=9 bytes_invalid=0 send_seq=729 receive_seq=729 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028670 rpi: mcu_awake=0.001 mcu_task_avg=0.000012 mcu_task_stddev=0.000015 bytes_write=886 bytes_read=4801 bytes_retransmit=0 bytes_invalid=0 send_seq=122 receive_seq=122 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999962 adj=49997411 Octopus_Max: temp=35.7 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.11 cputime=6.478 memavail=7493748 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5026.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9772 bytes_read=15298 bytes_retransmit=9 bytes_invalid=0 send_seq=730 receive_seq=730 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028364 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=892 bytes_read=4830 bytes_retransmit=0 bytes_invalid=0 send_seq=123 receive_seq=123 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999822 adj=49996790 Octopus_Max: temp=35.9 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.11 cputime=6.491 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5027.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9778 bytes_read=15564 bytes_retransmit=9 bytes_invalid=0 send_seq=731 receive_seq=731 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028074 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=898 bytes_read=4846 bytes_retransmit=0 bytes_invalid=0 send_seq=124 receive_seq=124 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999725 adj=49996298 Octopus_Max: temp=35.9 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.11 cputime=6.502 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5028.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9784 bytes_read=15801 bytes_retransmit=9 bytes_invalid=0 send_seq=732 receive_seq=732 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027936 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=904 bytes_read=4862 bytes_retransmit=0 bytes_invalid=0 send_seq=125 receive_seq=125 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999649 adj=49996055 Octopus_Max: temp=35.9 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.11 cputime=6.513 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5029.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9790 bytes_read=16034 bytes_retransmit=9 bytes_invalid=0 send_seq=733 receive_seq=733 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027789 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=910 bytes_read=4878 bytes_retransmit=0 bytes_invalid=0 send_seq=126 receive_seq=126 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999603 adj=49995845 Octopus_Max: temp=35.9 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.10 cputime=6.525 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5030.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9796 bytes_read=16292 bytes_retransmit=9 bytes_invalid=0 send_seq=734 receive_seq=734 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027671 rpi: mcu_awake=0.001 mcu_task_avg=0.000019 mcu_task_stddev=0.000023 bytes_write=916 bytes_read=4894 bytes_retransmit=0 bytes_invalid=0 send_seq=127 receive_seq=127 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999653 adj=49995802 Octopus_Max: temp=36.0 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.4 bed_core: temp=23.7 sysload=0.10 cputime=6.537 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5031.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9802 bytes_read=16515 bytes_retransmit=9 bytes_invalid=0 send_seq=735 receive_seq=735 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027817 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000016 bytes_write=922 bytes_read=4923 bytes_retransmit=0 bytes_invalid=0 send_seq=128 receive_seq=128 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999679 adj=49996188 Octopus_Max: temp=36.0 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.10 cputime=6.564 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5032.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9808 bytes_read=16752 bytes_retransmit=9 bytes_invalid=0 send_seq=736 receive_seq=736 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027883 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000016 bytes_write=928 bytes_read=4939 bytes_retransmit=0 bytes_invalid=0 send_seq=129 receive_seq=129 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999705 adj=49996229 Octopus_Max: temp=36.0 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.10 cputime=6.591 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5033.2: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9814 bytes_read=17032 bytes_retransmit=9 bytes_invalid=0 send_seq=737 receive_seq=737 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027979 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000016 bytes_write=934 bytes_read=4955 bytes_retransmit=0 bytes_invalid=0 send_seq=130 receive_seq=130 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999716 adj=49996311 Octopus_Max: temp=36.1 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.10 cputime=6.619 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5034.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9820 bytes_read=17255 bytes_retransmit=9 bytes_invalid=0 send_seq=738 receive_seq=738 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028008 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000016 bytes_write=940 bytes_read=4971 bytes_retransmit=0 bytes_invalid=0 send_seq=131 receive_seq=131 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999732 adj=49996279 Octopus_Max: temp=36.2 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.09 cputime=6.646 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 5035.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9826 bytes_read=17492 bytes_retransmit=9 bytes_invalid=0 send_seq=739 receive_seq=739 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028045 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000016 bytes_write=946 bytes_read=4987 bytes_retransmit=0 bytes_invalid=0 send_seq=132 receive_seq=132 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999726 adj=49996332 Octopus_Max: temp=36.0 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.09 cputime=6.673 memavail=7498412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5036.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9832 bytes_read=17758 bytes_retransmit=9 bytes_invalid=0 send_seq=740 receive_seq=740 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028057 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000026 bytes_write=952 bytes_read=5016 bytes_retransmit=0 bytes_invalid=0 send_seq=133 receive_seq=133 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999734 adj=49996244 Octopus_Max: temp=36.0 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.09 cputime=6.699 memavail=7498420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5037.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9838 bytes_read=17981 bytes_retransmit=9 bytes_invalid=0 send_seq=741 receive_seq=741 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028054 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000026 bytes_write=958 bytes_read=5032 bytes_retransmit=0 bytes_invalid=0 send_seq=134 receive_seq=134 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999726 adj=49996277 Octopus_Max: temp=36.3 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.09 cputime=6.726 memavail=7498420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5038.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9844 bytes_read=18232 bytes_retransmit=9 bytes_invalid=0 send_seq=742 receive_seq=742 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028074 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000026 bytes_write=964 bytes_read=5048 bytes_retransmit=0 bytes_invalid=0 send_seq=135 receive_seq=135 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999720 adj=49996219 Octopus_Max: temp=36.1 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.09 cputime=6.754 memavail=7498420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5039.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9850 bytes_read=18498 bytes_retransmit=9 bytes_invalid=0 send_seq=743 receive_seq=743 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028066 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000026 bytes_write=970 bytes_read=5064 bytes_retransmit=0 bytes_invalid=0 send_seq=136 receive_seq=136 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999714 adj=49996166 Octopus_Max: temp=36.2 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.782 memavail=7498420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5040.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9856 bytes_read=18714 bytes_retransmit=9 bytes_invalid=0 send_seq=744 receive_seq=744 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028054 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000026 bytes_write=976 bytes_read=5080 bytes_retransmit=0 bytes_invalid=0 send_seq=137 receive_seq=137 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999707 adj=49996144 Octopus_Max: temp=36.3 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.808 memavail=7498420 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5041.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9862 bytes_read=18949 bytes_retransmit=9 bytes_invalid=0 send_seq=745 receive_seq=745 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028034 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=982 bytes_read=5109 bytes_retransmit=0 bytes_invalid=0 send_seq=138 receive_seq=138 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999705 adj=49996128 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.7 sysload=0.08 cputime=6.834 memavail=7498416 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5042.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9868 bytes_read=19215 bytes_retransmit=9 bytes_invalid=0 send_seq=746 receive_seq=746 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028005 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=988 bytes_read=5125 bytes_retransmit=0 bytes_invalid=0 send_seq=139 receive_seq=139 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999671 adj=49996146 Octopus_Max: temp=36.3 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.852 memavail=7498040 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5043.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9874 bytes_read=19452 bytes_retransmit=9 bytes_invalid=0 send_seq=747 receive_seq=747 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027938 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=994 bytes_read=5141 bytes_retransmit=0 bytes_invalid=0 send_seq=140 receive_seq=140 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999642 adj=49995949 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.08 cputime=6.863 memavail=7498040 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5044.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9880 bytes_read=19689 bytes_retransmit=9 bytes_invalid=0 send_seq=748 receive_seq=748 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027905 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1000 bytes_read=5157 bytes_retransmit=0 bytes_invalid=0 send_seq=141 receive_seq=141 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999617 adj=49995857 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.875 memavail=7498040 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5045.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9886 bytes_read=19955 bytes_retransmit=9 bytes_invalid=0 send_seq=749 receive_seq=749 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027875 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1006 bytes_read=5173 bytes_retransmit=0 bytes_invalid=0 send_seq=142 receive_seq=142 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999621 adj=49995780 Octopus_Max: temp=36.6 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.08 cputime=6.886 memavail=7498040 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5046.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9892 bytes_read=20178 bytes_retransmit=9 bytes_invalid=0 send_seq=750 receive_seq=750 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027847 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000021 bytes_write=1012 bytes_read=5189 bytes_retransmit=0 bytes_invalid=0 send_seq=143 receive_seq=143 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999601 adj=49995929 Octopus_Max: temp=36.4 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.08 cputime=6.898 memavail=7498044 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5047.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9898 bytes_read=20415 bytes_retransmit=9 bytes_invalid=0 send_seq=751 receive_seq=751 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027982 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000020 bytes_write=1018 bytes_read=5218 bytes_retransmit=0 bytes_invalid=0 send_seq=144 receive_seq=144 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999633 adj=49995853 Octopus_Max: temp=36.5 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.922 memavail=7498044 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5048.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9904 bytes_read=20695 bytes_retransmit=9 bytes_invalid=0 send_seq=752 receive_seq=752 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027984 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000020 bytes_write=1024 bytes_read=5234 bytes_retransmit=0 bytes_invalid=0 send_seq=145 receive_seq=145 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999635 adj=49996036 Octopus_Max: temp=36.6 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.08 cputime=6.949 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5049.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9910 bytes_read=20918 bytes_retransmit=9 bytes_invalid=0 send_seq=753 receive_seq=753 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027999 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000020 bytes_write=1030 bytes_read=5250 bytes_retransmit=0 bytes_invalid=0 send_seq=146 receive_seq=146 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999644 adj=49996077 Octopus_Max: temp=36.6 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.07 cputime=6.976 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5050.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9916 bytes_read=21155 bytes_retransmit=9 bytes_invalid=0 send_seq=754 receive_seq=754 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027997 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000020 bytes_write=1036 bytes_read=5266 bytes_retransmit=0 bytes_invalid=0 send_seq=147 receive_seq=147 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999656 adj=49996151 Octopus_Max: temp=36.5 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.07 cputime=7.003 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5051.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9922 bytes_read=21410 bytes_retransmit=9 bytes_invalid=0 send_seq=755 receive_seq=755 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028010 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000020 bytes_write=1042 bytes_read=5282 bytes_retransmit=0 bytes_invalid=0 send_seq=148 receive_seq=148 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999668 adj=49996248 Octopus_Max: temp=36.7 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.07 cputime=7.031 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5052.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9934 bytes_read=21648 bytes_retransmit=9 bytes_invalid=0 send_seq=757 receive_seq=757 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028018 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000025 bytes_write=1048 bytes_read=5311 bytes_retransmit=0 bytes_invalid=0 send_seq=149 receive_seq=149 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999682 adj=49996315 Octopus_Max: temp=36.6 Pi: temp=34.6  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.07 cputime=7.060 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5053.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9940 bytes_read=21899 bytes_retransmit=9 bytes_invalid=0 send_seq=758 receive_seq=758 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028019 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000025 bytes_write=1054 bytes_read=5327 bytes_retransmit=0 bytes_invalid=0 send_seq=150 receive_seq=150 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999683 adj=49996391 Octopus_Max: temp=36.4 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.07 cputime=7.087 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5054.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9946 bytes_read=22165 bytes_retransmit=9 bytes_invalid=0 send_seq=759 receive_seq=759 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028012 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000025 bytes_write=1060 bytes_read=5343 bytes_retransmit=0 bytes_invalid=0 send_seq=151 receive_seq=151 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999673 adj=49996342 Octopus_Max: temp=36.7 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.7 sysload=0.06 cputime=7.115 memavail=7498036 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.6 pwm=0.000
Stats 5055.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9952 bytes_read=22388 bytes_retransmit=9 bytes_invalid=0 send_seq=760 receive_seq=760 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027993 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000025 bytes_write=1066 bytes_read=5359 bytes_retransmit=0 bytes_invalid=0 send_seq=152 receive_seq=152 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999664 adj=49996226 Octopus_Max: temp=36.7 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.06 cputime=7.139 memavail=7495568 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5056.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9958 bytes_read=22625 bytes_retransmit=9 bytes_invalid=0 send_seq=761 receive_seq=761 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027946 rpi: mcu_awake=0.001 mcu_task_avg=0.000021 mcu_task_stddev=0.000025 bytes_write=1072 bytes_read=5375 bytes_retransmit=0 bytes_invalid=0 send_seq=153 receive_seq=153 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999650 adj=49996150 Octopus_Max: temp=36.8 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.06 cputime=7.152 memavail=7493092 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5057.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9964 bytes_read=22891 bytes_retransmit=9 bytes_invalid=0 send_seq=762 receive_seq=762 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027930 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1078 bytes_read=5404 bytes_retransmit=0 bytes_invalid=0 send_seq=154 receive_seq=154 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999631 adj=49996083 Octopus_Max: temp=36.9 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.06 cputime=7.165 memavail=7493100 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5058.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9970 bytes_read=23128 bytes_retransmit=9 bytes_invalid=0 send_seq=763 receive_seq=763 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027898 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1084 bytes_read=5420 bytes_retransmit=0 bytes_invalid=0 send_seq=155 receive_seq=155 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999618 adj=49995940 Octopus_Max: temp=36.8 Pi: temp=36.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.06 cputime=7.178 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5059.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9976 bytes_read=23365 bytes_retransmit=9 bytes_invalid=0 send_seq=764 receive_seq=764 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027882 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1090 bytes_read=5436 bytes_retransmit=0 bytes_invalid=0 send_seq=156 receive_seq=156 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999602 adj=49995901 Octopus_Max: temp=36.9 Pi: temp=35.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.06 cputime=7.190 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5060.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9982 bytes_read=23631 bytes_retransmit=9 bytes_invalid=0 send_seq=765 receive_seq=765 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027911 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1096 bytes_read=5452 bytes_retransmit=0 bytes_invalid=0 send_seq=157 receive_seq=157 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999590 adj=49995829 Octopus_Max: temp=36.7 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.06 cputime=7.206 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5061.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9988 bytes_read=23854 bytes_retransmit=9 bytes_invalid=0 send_seq=766 receive_seq=766 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027914 rpi: mcu_awake=0.001 mcu_task_avg=0.000018 mcu_task_stddev=0.000021 bytes_write=1102 bytes_read=5468 bytes_retransmit=0 bytes_invalid=0 send_seq=158 receive_seq=158 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999604 adj=49995749 Octopus_Max: temp=36.9 Pi: temp=36.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.6 sysload=0.06 cputime=7.233 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5062.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9994 bytes_read=24080 bytes_retransmit=9 bytes_invalid=0 send_seq=767 receive_seq=767 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027919 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000013 bytes_write=1108 bytes_read=5497 bytes_retransmit=0 bytes_invalid=0 send_seq=159 receive_seq=159 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999608 adj=49995970 Octopus_Max: temp=36.9 Pi: temp=34.6  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.06 cputime=7.261 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5063.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=10000 bytes_read=24360 bytes_retransmit=9 bytes_invalid=0 send_seq=768 receive_seq=768 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027921 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000013 bytes_write=1114 bytes_read=5513 bytes_retransmit=0 bytes_invalid=0 send_seq=160 receive_seq=160 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999606 adj=49996038 Octopus_Max: temp=37.0 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.7 sysload=0.06 cputime=7.289 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
Stats 5064.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=10006 bytes_read=24597 bytes_retransmit=9 bytes_invalid=0 send_seq=769 receive_seq=769 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027924 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000013 bytes_write=1120 bytes_read=5529 bytes_retransmit=0 bytes_invalid=0 send_seq=161 receive_seq=161 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999603 adj=49996042 Octopus_Max: temp=36.9 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.05 cputime=7.315 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5065.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=10012 bytes_read=24820 bytes_retransmit=9 bytes_invalid=0 send_seq=770 receive_seq=770 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027913 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000013 bytes_write=1126 bytes_read=5545 bytes_retransmit=0 bytes_invalid=0 send_seq=162 receive_seq=162 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999602 adj=49996024 Octopus_Max: temp=36.9 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.5 bed_core: temp=23.5 sysload=0.05 cputime=7.342 memavail=7491968 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5066.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=10018 bytes_read=25086 bytes_retransmit=9 bytes_invalid=0 send_seq=771 receive_seq=771 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027939 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000013 bytes_write=1132 bytes_read=5561 bytes_retransmit=0 bytes_invalid=0 send_seq=163 receive_seq=163 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999600 adj=49996047 Octopus_Max: temp=36.9 Pi: temp=35.0  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.05 cputime=7.370 memavail=7491252 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 5067.3: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=10024 bytes_read=25323 bytes_retransmit=9 bytes_invalid=0 send_seq=772 receive_seq=772 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400027933 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000024 bytes_write=1138 bytes_read=5590 bytes_retransmit=0 bytes_invalid=0 send_seq=164 receive_seq=164 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999595 adj=49996010 Octopus_Max: temp=37.0 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.05 cputime=7.396 memavail=7491252 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.6 pwm=0.000
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-171-g2f6e94c9-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:47:03 2024 (1713678423.3 5075.5)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
webhooks client 4128060032: New connection
webhooks client 4128060032: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': got {'oid': 41, 'next_clock': 1914196224, 'value': 10859, '#name': 'analog_in_state', '#sent_time': 5076.863172233, '#receive_time': 5076.866610399}
mcu 'mcu': got {'oid': 0, 'next_clock': 1842996224, 'count': 1, 'count_clock': 2800000000, '#name': 'counter_state', '#sent_time': 5076.965374103, '#receive_time': 5076.980940399}
mcu 'mcu': got {'oid': 1, 'next_clock': 1846996224, 'count': 1, 'count_clock': 2804000000, '#name': 'counter_state', '#sent_time': 5076.965374103, '#receive_time': 5076.990936862}
mcu 'mcu': got {'oid': 24, 'next_clock': 1966196224, 'value': 6295, '#name': 'analog_in_state', '#sent_time': 5076.965374103, '#receive_time': 5076.996588455}
mcu 'mcu': got {'oid': 26, 'next_clock': 1974196224, 'value': 31426, '#name': 'analog_in_state', '#sent_time': 5077.015980918, '#receive_time': 5077.016589825}
mcu 'mcu': got {'oid': 27, 'next_clock': 1978196224, 'value': 10864, '#name': 'analog_in_state', '#sent_time': 5077.015980918, '#receive_time': 5077.026592733}
mcu 'mcu': got {'oid': 41, 'next_clock': 2034196224, 'value': 10860, '#name': 'analog_in_state', '#sent_time': 5077.117091788, '#receive_time': 5077.16662851}
Loaded MCU 'mcu' 112 commands (v0.12.0-171-g2f6e94c9 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
mcu 'mcu': got {'oid': 24, 'next_clock': 2086196224, 'value': 6295, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.296626807}
mcu 'mcu': got {'oid': 26, 'next_clock': 2094196224, 'value': 31428, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.316635733}
mcu 'mcu': got {'oid': 27, 'next_clock': 2098196224, 'value': 10864, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.32661364}
mcu 'mcu': got {'oid': 41, 'next_clock': 2154196224, 'value': 10861, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.466612658}
mcu 'mcu': got {'oid': 24, 'next_clock': 2206196224, 'value': 6295, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.596626251}
mcu 'mcu': got {'oid': 26, 'next_clock': 2214196224, 'value': 31431, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.61661488}
mcu 'mcu': got {'oid': 27, 'next_clock': 2218196224, 'value': 10865, '#name': 'analog_in_state', '#sent_time': 5077.271489603, '#receive_time': 5077.626614603}
Loaded MCU 'rpi' 118 commands (v0.12.0-171-g2f6e94c9 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Configured MCU 'mcu' (1024 moves)
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)
Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
webhooks: registering remote method 'shutdown_machine' for connection id: 4128060032
webhooks: registering remote method 'reboot_machine' for connection id: 4128060032
webhooks: registering remote method 'pause_job_queue' for connection id: 4128060032
webhooks: registering remote method 'start_job_queue' for connection id: 4128060032
webhooks: registering remote method 'set_device_power' for connection id: 4128060032
webhooks client 4128060032: Disconnected
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-171-g2f6e94c9-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:48:35 2024 (1713678515.1 23.6)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
webhooks client 4127182752: New connection
webhooks client 4127182752: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
Loaded MCU 'mcu' 112 commands (v0.12.0-171-g2f6e94c9 / gcc: (15:8-2019-q3-1+b1) 8.3.1 20190703 (release) [gcc-8-branch revision 273027] binutils: (2.34-4+rpi1+14) 2.34)
MCU 'mcu' config: ADC_MAX=4095 BUS_PINS_i2c1_PB6_PB7=PB6,PB7 BUS_PINS_i2c1_PB8_PB9=PB8,PB9 BUS_PINS_i2c2_PB10_PB11=PB10,PB11 BUS_PINS_i2c3_PA8_PC9=PA8,PC9 BUS_PINS_spi1=PA6,PA7,PA5 BUS_PINS_spi1a=PB4,PB5,PB3 BUS_PINS_spi2=PB14,PB15,PB13 BUS_PINS_spi2a=PC2,PC3,PB10 BUS_PINS_spi3a=PC11,PC12,PC10 BUS_PINS_spi4=PE13,PE14,PE12 BUS_PINS_spi5=PF8,PF9,PF7 BUS_PINS_spi5a=PH7,PF11,PH6 BUS_PINS_spi6=PG12,PG14,PG13 CLOCK_FREQ=400000000 MCU=stm32h723xx PWM_MAX=255 RESERVE_PINS_USB=PA11,PA12 RESERVE_PINS_crystal=PH0,PH1 STATS_SUMSQ_BASE=256 STEPPER_BOTH_EDGE=1
mcu 'rpi': Starting connect
Loaded MCU 'rpi' 118 commands (v0.12.0-171-g2f6e94c9 / gcc: (Raspbian 10.2.1-6+rpi1) 10.2.1 20210110 binutils: (GNU Binutils for Raspbian) 2.35.2)
MCU 'rpi' config: ADC_MAX=4095 CLOCK_FREQ=50000000 MCU=linux PCA9685_MAX=4096 PWM_MAX=32768 STATS_SUMSQ_BASE=256
mcu_temperature 'mcu' nominal base=-273.952569 slope=1618.577075
Sending MCU 'mcu' printer configuration...
Configured MCU 'mcu' (1024 moves)
Sending MCU 'rpi' printer configuration...
Configured MCU 'rpi' (1024 moves)
Starting heater checks for heater_bed
bed_mesh: generated points
Index |  Tool Adjusted  |   Probe
  0   | (40.0, 23.0)    | (10.0, 8.4)
  1   | (57.8, 23.0)    | (27.8, 8.4)
  2   | (75.5, 23.0)    | (45.5, 8.4)
  3   | (93.3, 23.0)    | (63.3, 8.4)
  4   | (111.1, 23.0)   | (81.1, 8.4)
  5   | (128.8, 23.0)   | (98.8, 8.4)
  6   | (146.6, 23.0)   | (116.6, 8.4)
  7   | (164.4, 23.0)   | (134.4, 8.4)
  8   | (182.2, 23.0)   | (152.2, 8.4)
  9   | (199.9, 23.0)   | (169.9, 8.4)
  10  | (199.9, 42.7)   | (169.9, 28.1)
  11  | (182.2, 42.7)   | (152.2, 28.1)
  12  | (164.4, 42.7)   | (134.4, 28.1)
  13  | (146.6, 42.7)   | (116.6, 28.1)
  14  | (128.9, 42.7)   | (98.9, 28.1)
  15  | (111.1, 42.7)   | (81.1, 28.1)
  16  | (93.3, 42.7)    | (63.3, 28.1)
  17  | (75.5, 42.7)    | (45.5, 28.1)
  18  | (57.8, 42.7)    | (27.8, 28.1)
  19  | (40.0, 42.7)    | (10.0, 28.1)
  20  | (40.0, 62.3)    | (10.0, 47.8)
  21  | (57.8, 62.3)    | (27.8, 47.8)
  22  | (75.5, 62.3)    | (45.5, 47.8)
  23  | (93.3, 62.3)    | (63.3, 47.8)
  24  | (111.1, 62.3)   | (81.1, 47.8)
  25  | (128.8, 62.3)   | (98.8, 47.8)
  26  | (146.6, 62.3)   | (116.6, 47.8)
  27  | (164.4, 62.3)   | (134.4, 47.8)
  28  | (182.2, 62.3)   | (152.2, 47.8)
  29  | (199.9, 62.3)   | (169.9, 47.8)
  30  | (199.9, 82.0)   | (169.9, 67.4)
  31  | (182.2, 82.0)   | (152.2, 67.4)
  32  | (164.4, 82.0)   | (134.4, 67.4)
  33  | (146.6, 82.0)   | (116.6, 67.4)
  34  | (128.9, 82.0)   | (98.9, 67.4)
  35  | (111.1, 82.0)   | (81.1, 67.4)
  36  | (93.3, 82.0)    | (63.3, 67.4)
  37  | (75.5, 82.0)    | (45.5, 67.4)
  38  | (57.8, 82.0)    | (27.8, 67.4)
  39  | (40.0, 82.0)    | (10.0, 67.4)
  40  | (40.0, 101.6)   | (10.0, 87.1)
  41  | (57.8, 101.6)   | (27.8, 87.1)
  42  | (75.5, 101.6)   | (45.5, 87.1)
  43  | (93.3, 101.6)   | (63.3, 87.1)
  44  | (111.1, 101.6)  | (81.1, 87.1)
  45  | (128.8, 101.6)  | (98.8, 87.1)
  46  | (146.6, 101.6)  | (116.6, 87.1)
  47  | (164.4, 101.6)  | (134.4, 87.1)
  48  | (182.2, 101.6)  | (152.2, 87.1)
  49  | (199.9, 101.6)  | (169.9, 87.1)
  50  | (199.9, 121.3)  | (169.9, 106.7)
  51  | (182.2, 121.3)  | (152.2, 106.7)
  52  | (164.4, 121.3)  | (134.4, 106.7)
  53  | (146.6, 121.3)  | (116.6, 106.7)
  54  | (128.9, 121.3)  | (98.9, 106.7)
  55  | (111.1, 121.3)  | (81.1, 106.7)
  56  | (93.3, 121.3)   | (63.3, 106.7)
  57  | (75.5, 121.3)   | (45.5, 106.7)
  58  | (57.8, 121.3)   | (27.8, 106.7)
  59  | (40.0, 121.3)   | (10.0, 106.7)
  60  | (40.0, 141.0)   | (10.0, 126.4)
  61  | (57.8, 141.0)   | (27.8, 126.4)
  62  | (75.5, 141.0)   | (45.5, 126.4)
  63  | (93.3, 141.0)   | (63.3, 126.4)
  64  | (111.1, 141.0)  | (81.1, 126.4)
  65  | (128.8, 141.0)  | (98.8, 126.4)
  66  | (146.6, 141.0)  | (116.6, 126.4)
  67  | (164.4, 141.0)  | (134.4, 126.4)
  68  | (182.2, 141.0)  | (152.2, 126.4)
  69  | (199.9, 141.0)  | (169.9, 126.4)
  70  | (199.9, 160.6)  | (169.9, 146.1)
  71  | (182.2, 160.6)  | (152.2, 146.1)
  72  | (164.4, 160.6)  | (134.4, 146.1)
  73  | (146.6, 160.6)  | (116.6, 146.1)
  74  | (128.9, 160.6)  | (98.9, 146.1)
  75  | (111.1, 160.6)  | (81.1, 146.1)
  76  | (93.3, 160.6)   | (63.3, 146.1)
  77  | (75.5, 160.6)   | (45.5, 146.1)
  78  | (57.8, 160.6)   | (27.8, 146.1)
  79  | (40.0, 160.6)   | (10.0, 146.1)
  80  | (40.0, 180.3)   | (10.0, 165.7)
  81  | (57.8, 180.3)   | (27.8, 165.7)
  82  | (75.5, 180.3)   | (45.5, 165.7)
  83  | (93.3, 180.3)   | (63.3, 165.7)
  84  | (111.1, 180.3)  | (81.1, 165.7)
  85  | (128.8, 180.3)  | (98.8, 165.7)
  86  | (146.6, 180.3)  | (116.6, 165.7)
  87  | (164.4, 180.3)  | (134.4, 165.7)
  88  | (182.2, 180.3)  | (152.2, 165.7)
  89  | (199.9, 180.3)  | (169.9, 165.7)
  90  | (199.9, 199.9)  | (169.9, 185.4)
  91  | (182.2, 199.9)  | (152.2, 185.4)
  92  | (164.4, 199.9)  | (134.4, 185.4)
  93  | (146.6, 199.9)  | (116.6, 185.4)
  94  | (128.9, 199.9)  | (98.9, 185.4)
  95  | (111.1, 199.9)  | (81.1, 185.4)
  96  | (93.3, 199.9)   | (63.3, 185.4)
  97  | (75.5, 199.9)   | (45.5, 185.4)
  98  | (57.8, 199.9)   | (27.8, 185.4)
  99  | (40.0, 199.9)   | (10.0, 185.4)
Starting heater checks for extruder
autotune_tmc set stepper_x pwm_freq=2
autotune_tmc stepper_x ncycles=219 pfdcycles=73
autotune_tmc set stepper_x tpfd=1
autotune_tmc set stepper_x tbl=1
autotune_tmc set stepper_x toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x hstrt=7
autotune_tmc set stepper_x hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x pwm_autoscale=True
autotune_tmc set stepper_x pwm_autograd=True
autotune_tmc set stepper_x pwm_grad=4
autotune_tmc set stepper_x pwm_ofs=10
autotune_tmc set stepper_x pwm_reg=15
autotune_tmc set stepper_x pwm_lim=4
autotune_tmc set stepper_x tpwmthrs=1048575
autotune_tmc set stepper_x en_pwm_mode=False
autotune_tmc set stepper_x tcoolthrs=391(24.0)
autotune_tmc set stepper_x sgt=1
autotune_tmc set stepper_x small_hysteresis=False
autotune_tmc set stepper_x semin=2
autotune_tmc set stepper_x semax=2
autotune_tmc set stepper_x seup=3
autotune_tmc set stepper_x sedn=2
autotune_tmc set stepper_x seimin=0
autotune_tmc set stepper_x sfilt=0
autotune_tmc set stepper_x iholddelay=12
autotune_tmc set stepper_x vhighfs=False
autotune_tmc set stepper_x vhighchm=False
autotune_tmc set stepper_x multistep_filt=True
autotune_tmc set stepper_x1 pwm_freq=2
autotune_tmc stepper_x1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_x1 tpfd=1
autotune_tmc set stepper_x1 tbl=1
autotune_tmc set stepper_x1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_x1 hstrt=7
autotune_tmc set stepper_x1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_x1 pwm_autoscale=True
autotune_tmc set stepper_x1 pwm_autograd=True
autotune_tmc set stepper_x1 pwm_grad=4
autotune_tmc set stepper_x1 pwm_ofs=10
autotune_tmc set stepper_x1 pwm_reg=15
autotune_tmc set stepper_x1 pwm_lim=4
autotune_tmc set stepper_x1 tpwmthrs=1048575
autotune_tmc set stepper_x1 en_pwm_mode=False
autotune_tmc set stepper_x1 tcoolthrs=391(24.0)
autotune_tmc set stepper_x1 sgt=1
autotune_tmc set stepper_x1 small_hysteresis=False
autotune_tmc set stepper_x1 semin=2
autotune_tmc set stepper_x1 semax=2
autotune_tmc set stepper_x1 seup=3
autotune_tmc set stepper_x1 sedn=2
autotune_tmc set stepper_x1 seimin=0
autotune_tmc set stepper_x1 sfilt=0
autotune_tmc set stepper_x1 iholddelay=12
autotune_tmc set stepper_x1 vhighfs=False
autotune_tmc set stepper_x1 vhighchm=False
autotune_tmc set stepper_x1 multistep_filt=True
autotune_tmc set stepper_y pwm_freq=2
autotune_tmc stepper_y ncycles=219 pfdcycles=73
autotune_tmc set stepper_y tpfd=1
autotune_tmc set stepper_y tbl=1
autotune_tmc set stepper_y toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y hstrt=7
autotune_tmc set stepper_y hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y pwm_autoscale=True
autotune_tmc set stepper_y pwm_autograd=True
autotune_tmc set stepper_y pwm_grad=4
autotune_tmc set stepper_y pwm_ofs=10
autotune_tmc set stepper_y pwm_reg=15
autotune_tmc set stepper_y pwm_lim=4
autotune_tmc set stepper_y tpwmthrs=1048575
autotune_tmc set stepper_y en_pwm_mode=False
autotune_tmc set stepper_y tcoolthrs=391(24.0)
autotune_tmc set stepper_y sgt=1
autotune_tmc set stepper_y small_hysteresis=False
autotune_tmc set stepper_y semin=2
autotune_tmc set stepper_y semax=2
autotune_tmc set stepper_y seup=3
autotune_tmc set stepper_y sedn=2
autotune_tmc set stepper_y seimin=0
autotune_tmc set stepper_y sfilt=0
autotune_tmc set stepper_y iholddelay=12
autotune_tmc set stepper_y vhighfs=False
autotune_tmc set stepper_y vhighchm=False
autotune_tmc set stepper_y multistep_filt=True
autotune_tmc set stepper_y1 pwm_freq=2
autotune_tmc stepper_y1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_y1 tpfd=1
autotune_tmc set stepper_y1 tbl=1
autotune_tmc set stepper_y1 toff=1
autotune_tmc seting hysteresis based on 48.0 V
dcoilblank = 0.160000, dcoilsd = 0.015156
hysteresis = 42, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_y1 hstrt=7
autotune_tmc set stepper_y1 hend=9
autotune_tmc using max PWM speed 445.633841
autotune_tmc set stepper_y1 pwm_autoscale=True
autotune_tmc set stepper_y1 pwm_autograd=True
autotune_tmc set stepper_y1 pwm_grad=4
autotune_tmc set stepper_y1 pwm_ofs=10
autotune_tmc set stepper_y1 pwm_reg=15
autotune_tmc set stepper_y1 pwm_lim=4
autotune_tmc set stepper_y1 tpwmthrs=1048575
autotune_tmc set stepper_y1 en_pwm_mode=False
autotune_tmc set stepper_y1 tcoolthrs=391(24.0)
autotune_tmc set stepper_y1 sgt=1
autotune_tmc set stepper_y1 small_hysteresis=False
autotune_tmc set stepper_y1 semin=2
autotune_tmc set stepper_y1 semax=2
autotune_tmc set stepper_y1 seup=3
autotune_tmc set stepper_y1 sedn=2
autotune_tmc set stepper_y1 seimin=0
autotune_tmc set stepper_y1 sfilt=0
autotune_tmc set stepper_y1 iholddelay=12
autotune_tmc set stepper_y1 vhighfs=False
autotune_tmc set stepper_y1 vhighchm=False
autotune_tmc set stepper_y1 multistep_filt=True
autotune_tmc set stepper_z pwm_freq=2
autotune_tmc stepper_z ncycles=219 pfdcycles=73
autotune_tmc set stepper_z tbl=1
autotune_tmc set stepper_z toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z hstrt=7
autotune_tmc set stepper_z hend=9
autotune_tmc set stepper_z sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z pwm_autoscale=True
autotune_tmc set stepper_z pwm_autograd=True
autotune_tmc set stepper_z pwm_grad=7
autotune_tmc set stepper_z pwm_ofs=18
autotune_tmc set stepper_z pwm_reg=15
autotune_tmc set stepper_z pwm_lim=4
autotune_tmc set stepper_z tpwmthrs=1048575
autotune_tmc set stepper_z en_spreadcycle=True
autotune_tmc set stepper_z tcoolthrs=391(2.4)
autotune_tmc set stepper_z semin=2
autotune_tmc set stepper_z semax=2
autotune_tmc set stepper_z seup=3
autotune_tmc set stepper_z sedn=2
autotune_tmc set stepper_z seimin=0
autotune_tmc set stepper_z iholddelay=12
autotune_tmc set stepper_z multistep_filt=True
autotune_tmc set stepper_z1 pwm_freq=2
autotune_tmc stepper_z1 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z1 tbl=1
autotune_tmc set stepper_z1 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z1 hstrt=7
autotune_tmc set stepper_z1 hend=9
autotune_tmc set stepper_z1 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z1 pwm_autoscale=True
autotune_tmc set stepper_z1 pwm_autograd=True
autotune_tmc set stepper_z1 pwm_grad=7
autotune_tmc set stepper_z1 pwm_ofs=18
autotune_tmc set stepper_z1 pwm_reg=15
autotune_tmc set stepper_z1 pwm_lim=4
autotune_tmc set stepper_z1 tpwmthrs=1048575
autotune_tmc set stepper_z1 en_spreadcycle=True
autotune_tmc set stepper_z1 tcoolthrs=391(2.4)
autotune_tmc set stepper_z1 semin=2
autotune_tmc set stepper_z1 semax=2
autotune_tmc set stepper_z1 seup=3
autotune_tmc set stepper_z1 sedn=2
autotune_tmc set stepper_z1 seimin=0
autotune_tmc set stepper_z1 iholddelay=12
autotune_tmc set stepper_z1 multistep_filt=True
autotune_tmc set stepper_z2 pwm_freq=2
autotune_tmc stepper_z2 ncycles=219 pfdcycles=73
autotune_tmc set stepper_z2 tbl=1
autotune_tmc set stepper_z2 toff=1
autotune_tmc seting hysteresis based on 24.0 V
dcoilblank = 0.080000, dcoilsd = 0.013495
hysteresis = 22, htotal = 14, hstrt = 8, hend = 6
autotune_tmc set stepper_z2 hstrt=7
autotune_tmc set stepper_z2 hend=9
autotune_tmc set stepper_z2 sgthrs=40
autotune_tmc using max PWM speed 43.108253
autotune_tmc set stepper_z2 pwm_autoscale=True
autotune_tmc set stepper_z2 pwm_autograd=True
autotune_tmc set stepper_z2 pwm_grad=7
autotune_tmc set stepper_z2 pwm_ofs=18
autotune_tmc set stepper_z2 pwm_reg=15
autotune_tmc set stepper_z2 pwm_lim=4
autotune_tmc set stepper_z2 tpwmthrs=1048575
autotune_tmc set stepper_z2 en_spreadcycle=True
autotune_tmc set stepper_z2 tcoolthrs=391(2.4)
autotune_tmc set stepper_z2 semin=2
autotune_tmc set stepper_z2 semax=2
autotune_tmc set stepper_z2 seup=3
autotune_tmc set stepper_z2 sedn=2
autotune_tmc set stepper_z2 seimin=0
autotune_tmc set stepper_z2 iholddelay=12
autotune_tmc set stepper_z2 multistep_filt=True
Stats 48.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9307 bytes_read=12327 bytes_retransmit=9 bytes_invalid=0 send_seq=639 receive_seq=639 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028014 rpi: mcu_awake=0.003 mcu_task_avg=0.000022 mcu_task_stddev=0.000016 bytes_write=831 bytes_read=4710 bytes_retransmit=0 bytes_invalid=0 send_seq=113 receive_seq=113 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999941 adj=49996721 Octopus_Max: temp=36.1 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.7 sysload=0.57 cputime=2.665 memavail=7485752 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.5 pwm=0.000
webhooks: registering remote method 'shutdown_machine' for connection id: 4127182752
webhooks: registering remote method 'reboot_machine' for connection id: 4127182752
webhooks: registering remote method 'pause_job_queue' for connection id: 4127182752
webhooks: registering remote method 'start_job_queue' for connection id: 4127182752
webhooks: registering remote method 'set_device_power' for connection id: 4127182752
Stats 49.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000000 mcu_task_stddev=0.000000 bytes_write=9313 bytes_read=12550 bytes_retransmit=9 bytes_invalid=0 send_seq=640 receive_seq=640 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400030708 rpi: mcu_awake=0.003 mcu_task_avg=0.000022 mcu_task_stddev=0.000016 bytes_write=837 bytes_read=4726 bytes_retransmit=0 bytes_invalid=0 send_seq=114 receive_seq=114 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000512 adj=49996253 Octopus_Max: temp=36.2 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.57 cputime=2.706 memavail=7490332 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 50.6: gcodein=0  mcu: mcu_awake=0.015 mcu_task_avg=0.000008 mcu_task_stddev=0.000060 bytes_write=9319 bytes_read=12829 bytes_retransmit=9 bytes_invalid=0 send_seq=641 receive_seq=641 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029905 rpi: mcu_awake=0.003 mcu_task_avg=0.000022 mcu_task_stddev=0.000016 bytes_write=849 bytes_read=4758 bytes_retransmit=0 bytes_invalid=0 send_seq=116 receive_seq=116 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999612 adj=49996689 Octopus_Max: temp=36.2 Pi: temp=36.5  heater_bed: target=0 temp=23.0 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.718 memavail=7490476 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 51.6: gcodein=0  mcu: mcu_awake=0.015 mcu_task_avg=0.000008 mcu_task_stddev=0.000060 bytes_write=9325 bytes_read=13066 bytes_retransmit=9 bytes_invalid=0 send_seq=642 receive_seq=642 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029268 rpi: mcu_awake=0.003 mcu_task_avg=0.000022 mcu_task_stddev=0.000016 bytes_write=855 bytes_read=4774 bytes_retransmit=0 bytes_invalid=0 send_seq=117 receive_seq=117 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999558 adj=49995052 Octopus_Max: temp=36.2 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.5 sysload=0.52 cputime=2.730 memavail=7490476 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 52.6: gcodein=0  mcu: mcu_awake=0.015 mcu_task_avg=0.000008 mcu_task_stddev=0.000060 bytes_write=9331 bytes_read=13289 bytes_retransmit=9 bytes_invalid=0 send_seq=643 receive_seq=643 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029667 rpi: mcu_awake=0.003 mcu_task_avg=0.000022 mcu_task_stddev=0.000016 bytes_write=861 bytes_read=4790 bytes_retransmit=0 bytes_invalid=0 send_seq=118 receive_seq=118 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999886 adj=49995326 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.754 memavail=7489984 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.3 pwm=0.000
Stats 53.6: gcodein=0  mcu: mcu_awake=0.015 mcu_task_avg=0.000008 mcu_task_stddev=0.000060 bytes_write=9337 bytes_read=13555 bytes_retransmit=9 bytes_invalid=0 send_seq=644 receive_seq=644 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029386 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=867 bytes_read=4819 bytes_retransmit=0 bytes_invalid=0 send_seq=119 receive_seq=119 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999913 adj=49996164 Octopus_Max: temp=36.3 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.776 memavail=7485064 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.6 pwm=0.000
Stats 54.6: gcodein=0  mcu: mcu_awake=0.015 mcu_task_avg=0.000008 mcu_task_stddev=0.000060 bytes_write=9343 bytes_read=13792 bytes_retransmit=9 bytes_invalid=0 send_seq=645 receive_seq=645 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400029106 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=873 bytes_read=4835 bytes_retransmit=0 bytes_invalid=0 send_seq=120 receive_seq=120 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999855 adj=49996344 Octopus_Max: temp=36.3 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.792 memavail=7489244 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
b'Got EOF when reading from device'
Stats 55.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=879 bytes_read=4851 bytes_retransmit=0 bytes_invalid=0 send_seq=121 receive_seq=121 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999837 adj=49996254 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.804 memavail=7489240 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 56.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=1 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=885 bytes_read=4867 bytes_retransmit=0 bytes_invalid=0 send_seq=122 receive_seq=122 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999827 adj=49996321 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.814 memavail=7489244 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 57.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=2 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=891 bytes_read=4883 bytes_retransmit=0 bytes_invalid=0 send_seq=123 receive_seq=123 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999823 adj=49996266 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.823 memavail=7489248 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 58.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=3 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=897 bytes_read=4912 bytes_retransmit=0 bytes_invalid=0 send_seq=124 receive_seq=124 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999950 adj=49996241 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.838 memavail=7489248 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 59.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=4 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=903 bytes_read=4928 bytes_retransmit=0 bytes_invalid=0 send_seq=125 receive_seq=125 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000078 adj=49996728 Octopus_Max: temp=36.4 Pi: temp=37.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.859 memavail=7486224 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Timeout with MCU 'mcu' (eventtime=60.622479)
Transition to shutdown state: Lost communication with MCU 'mcu'
Dumping gcode input 0 blocks
Dumping 20 requests for client 4127182752
Received 48.133186: b'{"id": 3858509248, "method": "objects/subscribe", "params": {"objects": {"webhooks": null}, "response_template": {"method": "process_status_update"}}}'
Received 48.135122: b'{"id": 3858509248, "method": "gcode/subscribe_output", "params": {"response_template": {"method": "process_gcode_response"}}}'
Received 48.138455: b'{"id": 3858507304, "method": "list_endpoints", "params": {}}'
Received 48.142457: b'{"id": 3858507568, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null}, "response_template": {"method": "process_status_update"}}}'
Received 48.385806: b'{"id": 3858506104, "method": "objects/list", "params": {}}'
Received 48.387652: b'{"id": 3858502872, "method": "objects/query", "params": {"objects": {"configfile": null}}}'
Received 48.643970: b'{"id": 3858505128, "method": "register_remote_method", "params": {"response_template": {"method": "shutdown_machine"}, "remote_method": "shutdown_machine"}}'
Received 48.645717: b'{"id": 3858505128, "method": "register_remote_method", "params": {"response_template": {"method": "reboot_machine"}, "remote_method": "reboot_machine"}}'
Received 48.647010: b'{"id": 3858505128, "method": "register_remote_method", "params": {"response_template": {"method": "pause_job_queue"}, "remote_method": "pause_job_queue"}}'
Received 48.648207: b'{"id": 3858505128, "method": "register_remote_method", "params": {"response_template": {"method": "start_job_queue"}, "remote_method": "start_job_queue"}}'
Received 48.649365: b'{"id": 3858505128, "method": "register_remote_method", "params": {"response_template": {"method": "set_device_power"}, "remote_method": "set_device_power"}}'
Received 48.651971: b'{"id": 3858505296, "method": "objects/query", "params": {"objects": {"heaters": null}}}'
Received 48.651971: b'{"id": 3858504456, "method": "objects/query", "params": {"objects": {"heaters": null}}}'
Received 48.659832: b'{"id": 3858504768, "method": "info", "params": {}}'
Received 48.661782: b'{"id": 3858502104, "method": "objects/list", "params": {}}'
Received 48.661782: b'{"id": 3858502704, "method": "gcode/help", "params": {}}'
Received 48.686593: b'{"id": 3858502824, "method": "objects/subscribe", "params": {"objects": {"gcode": null, "webhooks": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_sensor Octopus_Max": null, "temperature_host Pi": null, "temperature_sensor Pi": null, "idle_timeout": null, "gcode_move": null, "print_stats": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null, "extruder": null}, "response_template": {"method": "process_status_update"}}}'
Received 48.904995: b'{"id": 3858504480, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null, "temperature_sensor Octopus_Max": null, "temperature_sensor Pi": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "extruder": null, "gcode": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_host Pi": null, "idle_timeout": null, "gcode_move": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null}, "response_template": {"method": "process_status_update"}}}'
Received 49.142828: b'{"id": 3858502176, "method": "objects/query", "params": {"objects": {"extruder": ["can_extrude"]}}}'
Received 49.149466: b'{"id": 3858504336, "method": "objects/subscribe", "params": {"objects": {"webhooks": null, "print_stats": null, "temperature_sensor Octopus_Max": null, "temperature_sensor Pi": null, "heater_bed": null, "temperature_sensor bed_mat": null, "temperature_sensor bed_core": null, "extruder": null, "gcode": null, "configfile": null, "mcu": null, "mcu rpi": null, "heaters": null, "temperature_host Pi": null, "idle_timeout": null, "gcode_move": null, "virtual_sdcard": null, "display_status": null, "pause_resume": null, "exclude_object": null, "temperature_combined heater_bed": null, "fan": null, "heater_fan toolhead": null, "stepper_enable": null, "controller_fan controller_fan": null, "gcode_macro HOME_X_SENSORLESS": null, "gcode_macro HOME_Y_SENSORLESS": null, "gcode_macro MAYBE_HOME": null, "gcode_macro ECHO_RATOS_VARS": null, "gcode_macro PAUSE": null, "gcode_macro RESUME": null, "gcode_macro CANCEL_PRINT": null, "gcode_macro PRIME_LINE": null, "gcode_macro PRIME_BLOB": null, "gcode_macro _PARK": null, "gcode_macro M600": null, "gcode_macro UNLOAD_FILAMENT": null, "gcode_macro LOAD_FILAMENT": null, "gcode_macro SET_CENTER_KINEMATIC_POSITION": null, "gcode_macro START_PRINT": null, "gcode_macro _USER_START_PRINT_BEFORE_HOMING": null, "gcode_macro _START_PRINT_AFTER_HEATING_BED": null, "gcode_macro Z_TILT_ADJUST": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_BED": null, "gcode_macro _START_PRINT_BED_MESH": null, "gcode_macro _USER_START_PRINT_BED_MESH": null, "gcode_macro _START_PRINT_PARK": null, "gcode_macro _USER_START_PRINT_PARK": null, "gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER": null, "gcode_macro _START_PRINT_HEAT_CHAMBER": null, "gcode_macro _USER_START_PRINT_HEAT_CHAMBER": null, "gcode_macro END_PRINT": null, "gcode_macro _END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF": null, "gcode_macro _END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF": null, "gcode_macro _END_PRINT_PARK": null, "gcode_macro _USER_END_PRINT_PARK": null, "gcode_macro SAVE_PROBE_RESULT": null, "gcode_macro PROBE_FOR_PRIMING": null, "gcode_macro RESET_PRIME_PROBE_STATE": null, "gcode_macro PROBE_CURRENT_POSITION": null, "gcode_macro ADD_PRIME_PROBE_TO_OFFSET": null, "gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET": null, "gcode_macro CALIBRATE_ADAPTIVE_MESH": null, "gcode_macro LINE_PURGE": null, "gcode_macro GENERATE_SHAPER_GRAPHS": null, "gcode_macro MEASURE_COREXY_BELT_TENSION": null, "gcode_macro COMPILE_FIRMWARE": null, "gcode_macro CHANGE_HOSTNAME": null, "tmc2209 stepper_z": null, "tmc2209 stepper_z1": null, "tmc2209 stepper_z2": null, "tmc5160 stepper_x": null, "tmc5160 stepper_x1": null, "tmc5160 stepper_y": null, "tmc5160 stepper_y1": null, "bed_mesh": null, "z_tilt": null, "gcode_macro enable_stepper": null, "gcode_macro disable_steppers": null, "gcode_macro STEPPER_BUZZ_X": null, "gcode_macro STEPPER_BUZZ_Y": null, "gcode_macro STEPPER_BUZZ_X1": null, "gcode_macro STEPPER_BUZZ_Y1": null, "gcode_macro STEPPER_BUZZ_Z": null, "gcode_macro STEPPER_BUZZ_Z1": null, "gcode_macro STEPPER_BUZZ_Z2": null, "gcode_macro TEST_SPEED": null, "probe": null, "gcode_macro RatOS": null, "tmc2209 extruder": null, "firmware_retraction": null, "filament_switch_sensor filament_switch": null, "gcode_macro FILDET_ENABLE": null, "gcode_macro FILDET_DISABLE": null, "output_pin status_led": null, "gcode_button top": null, "gcode_button bottom": null, "gcode_macro _POWER_OFF_PRINTER": null, "gcode_macro RESPOND": null, "motion_report": null, "query_endstops": null, "system_stats": null, "manual_probe": null, "toolhead": null}, "response_template": {"method": "process_status_update"}}}'
gcode state: absolute_coord=True absolute_extrude=True base_position=[0.0, 0.0, 0.0, 0.0] last_position=[0.0, 0.0, 0.0, 0.0] homing_position=[0.0, 0.0, 0.0, 0.0] speed_factor=0.016666666666666666 extrude_factor=1.0 speed=25.0
Reactor garbage collection: (48.89476347, 0.0, 0.0)
Stats 60.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=5 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=909 bytes_read=4944 bytes_retransmit=0 bytes_invalid=0 send_seq=126 receive_seq=126 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000041 adj=49997158 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.870 memavail=7489120 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
MCU 'rpi' shutdown: Command request
clocksync state: mcu_freq=50000000 last_clock=2622710292 clock_est=(49.453 2072641837 50000041.189) min_half_rtt=0.000044 min_rtt_time=46.515 time_avg=49.453(21.956) clock_avg=2072641837.892(1097804091.573) pred_variance=1151775745.629 clock_adj=(-36.881 49996828.250)
Dumping serial stats: bytes_write=915 bytes_read=4956 bytes_retransmit=0 bytes_invalid=0 send_seq=127 receive_seq=127 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0
Dumping send queue 100 messages
Sent 0 46.216208 46.216208 9: seq: 1b, identify offset=440 count=40
Sent 1 46.216545 46.216545 9: seq: 1c, identify offset=480 count=40
Sent 2 46.216870 46.216870 9: seq: 1d, identify offset=520 count=40
Sent 3 46.217191 46.217191 9: seq: 1e, identify offset=560 count=40
Sent 4 46.217493 46.217493 9: seq: 1f, identify offset=600 count=40
Sent 5 46.217821 46.217821 9: seq: 10, identify offset=640 count=40
Sent 6 46.218134 46.218134 9: seq: 11, identify offset=680 count=40
Sent 7 46.218448 46.218448 9: seq: 12, identify offset=720 count=40
Sent 8 46.218773 46.218773 9: seq: 13, identify offset=760 count=40
Sent 9 46.219084 46.219084 9: seq: 14, identify offset=800 count=40
Sent 10 46.219397 46.219397 9: seq: 15, identify offset=840 count=40
Sent 11 46.219704 46.219704 9: seq: 16, identify offset=880 count=40
Sent 12 46.220037 46.220037 9: seq: 17, identify offset=920 count=40
Sent 13 46.220357 46.220357 9: seq: 18, identify offset=960 count=40
Sent 14 46.220667 46.220667 9: seq: 19, identify offset=1000 count=40
Sent 15 46.220974 46.220974 9: seq: 1a, identify offset=1040 count=40
Sent 16 46.221293 46.221293 9: seq: 1b, identify offset=1080 count=40
Sent 17 46.221613 46.221613 9: seq: 1c, identify offset=1120 count=40
Sent 18 46.221927 46.221927 9: seq: 1d, identify offset=1160 count=40
Sent 19 46.222234 46.222234 9: seq: 1e, identify offset=1200 count=40
Sent 20 46.222553 46.222553 9: seq: 1f, identify offset=1240 count=40
Sent 21 46.222856 46.222856 9: seq: 10, identify offset=1280 count=40
Sent 22 46.223165 46.223165 9: seq: 11, identify offset=1320 count=40
Sent 23 46.223487 46.223487 9: seq: 12, identify offset=1360 count=40
Sent 24 46.223807 46.223807 9: seq: 13, identify offset=1400 count=40
Sent 25 46.224182 46.224182 9: seq: 14, identify offset=1440 count=40
Sent 26 46.224508 46.224508 9: seq: 15, identify offset=1480 count=40
Sent 27 46.224821 46.224821 9: seq: 16, identify offset=1520 count=40
Sent 28 46.225128 46.225128 9: seq: 17, identify offset=1560 count=40
Sent 29 46.225439 46.225439 9: seq: 18, identify offset=1600 count=40
Sent 30 46.225745 46.225745 9: seq: 19, identify offset=1640 count=40
Sent 31 46.226056 46.226056 9: seq: 1a, identify offset=1680 count=40
Sent 32 46.226359 46.226359 9: seq: 1b, identify offset=1720 count=40
Sent 33 46.226667 46.226667 9: seq: 1c, identify offset=1760 count=40
Sent 34 46.226975 46.226975 9: seq: 1d, identify offset=1800 count=40
Sent 35 46.227281 46.227281 9: seq: 1e, identify offset=1840 count=40
Sent 36 46.227591 46.227591 9: seq: 1f, identify offset=1880 count=40
Sent 37 46.227898 46.227898 9: seq: 10, identify offset=1920 count=40
Sent 38 46.228297 46.228297 9: seq: 11, identify offset=1960 count=40
Sent 39 46.228619 46.228619 9: seq: 12, identify offset=2000 count=40
Sent 40 46.228933 46.228933 9: seq: 13, identify offset=2040 count=40
Sent 41 46.229245 46.229245 9: seq: 14, identify offset=2080 count=40
Sent 42 46.229559 46.229559 9: seq: 15, identify offset=2120 count=40
Sent 43 46.229866 46.229866 9: seq: 16, identify offset=2160 count=40
Sent 44 46.230175 46.230175 9: seq: 17, identify offset=2200 count=40
Sent 45 46.230482 46.230482 9: seq: 18, identify offset=2240 count=40
Sent 46 46.230787 46.230787 9: seq: 19, identify offset=2280 count=40
Sent 47 46.231093 46.231093 9: seq: 1a, identify offset=2320 count=40
Sent 48 46.231404 46.231404 9: seq: 1b, identify offset=2360 count=40
Sent 49 46.231710 46.231710 9: seq: 1c, identify offset=2400 count=40
Sent 50 46.232097 46.232097 9: seq: 1d, identify offset=2440 count=40
Sent 51 46.232418 46.232418 9: seq: 1e, identify offset=2480 count=40
Sent 52 46.232738 46.232738 9: seq: 1f, identify offset=2520 count=40
Sent 53 46.233050 46.233050 9: seq: 10, identify offset=2560 count=40
Sent 54 46.233367 46.233367 9: seq: 11, identify offset=2600 count=40
Sent 55 46.233678 46.233678 9: seq: 12, identify offset=2640 count=40
Sent 56 46.233989 46.233989 9: seq: 13, identify offset=2680 count=40
Sent 57 46.234298 46.234298 9: seq: 14, identify offset=2720 count=40
Sent 58 46.234611 46.234611 9: seq: 15, identify offset=2760 count=40
Sent 59 46.234921 46.234921 9: seq: 16, identify offset=2800 count=40
Sent 60 46.235229 46.235229 9: seq: 17, identify offset=2840 count=40
Sent 61 46.235540 46.235540 9: seq: 18, identify offset=2880 count=40
Sent 62 46.235853 46.235853 9: seq: 19, identify offset=2920 count=40
Sent 63 46.236193 46.236193 9: seq: 1a, identify offset=2960 count=40
Sent 64 46.236512 46.236512 9: seq: 1b, identify offset=3000 count=40
Sent 65 46.236825 46.236825 9: seq: 1c, identify offset=3040 count=40
Sent 66 46.237135 46.237135 9: seq: 1d, identify offset=3080 count=40
Sent 67 46.237442 46.237442 9: seq: 1e, identify offset=3120 count=40
Sent 68 46.237747 46.237747 9: seq: 1f, identify offset=3160 count=40
Sent 69 46.238054 46.238054 9: seq: 10, identify offset=3200 count=40
Sent 70 46.238361 46.238361 9: seq: 11, identify offset=3232 count=40
Sent 71 46.261249 46.261249 6: seq: 12, get_uptime
Sent 72 46.312263 46.312263 6: seq: 13, get_clock
Sent 73 46.362788 46.362788 6: seq: 14, get_clock
Sent 74 46.413510 46.413510 6: seq: 15, get_clock
Sent 75 46.464093 46.464093 6: seq: 16, get_clock
Sent 76 46.514569 46.514569 6: seq: 17, get_clock
Sent 77 46.565171 46.565171 6: seq: 18, get_clock
Sent 78 46.616261 46.616261 6: seq: 19, get_clock
Sent 79 46.668282 46.668282 6: seq: 1a, get_clock
Sent 80 46.670692 46.670692 6: seq: 1b, get_clock
Sent 81 46.696630 46.696630 6: seq: 1c, get_config
Sent 82 46.698357 46.698357 7: seq: 1d, allocate_oids count=0
Sent 83 46.698831 46.698831 11: seq: 1e, finalize_config crc=3912464276
Sent 84 46.699243 46.699243 6: seq: 1f, get_config
Sent 85 47.654781 47.654781 6: seq: 10, get_clock
Sent 86 48.639144 48.639144 6: seq: 11, get_clock
Sent 87 49.623835 49.623835 6: seq: 12, get_clock
Sent 88 50.608557 50.608557 6: seq: 13, get_clock
Sent 89 51.593534 51.593534 6: seq: 14, get_clock
Sent 90 52.578265 52.578265 6: seq: 15, get_clock
Sent 91 53.562676 53.562676 6: seq: 16, get_clock
Sent 92 54.546807 54.546807 6: seq: 17, get_clock
Sent 93 55.531108 55.531108 6: seq: 18, get_clock
Sent 94 56.515529 56.515529 6: seq: 19, get_clock
Sent 95 57.500116 57.500116 6: seq: 1a, get_clock
Sent 96 58.484458 58.484458 6: seq: 1b, get_clock
Sent 97 59.469267 59.469267 6: seq: 1c, get_clock
Sent 98 60.454122 60.454122 6: seq: 1d, get_clock
Sent 99 60.624349 60.624349 6: seq: 1e, emergency_stop
Dumping receive queue 100 messages
Receive: 0 46.216624 46.216545 49: seq: 1d, identify_response offset=480 data=b'\xbd\xb8\x9f\xaa\x18\x8b\\\x8a\x7f\xc3\x95\x1c&0\xbd1G\t{z+9L\x89\xd6;\\\x92\xd8E\xfb\xb2\xd8\xa6Y\xe2\xf4I\xd9\x0b'
Receive: 1 46.216948 46.216870 49: seq: 1e, identify_response offset=520 data=b'X\xd0\xa0l\xe1P\xb4-\xaf\xd5\xe73\xa8\xb7[V+\xc1aZ\xaa\x05\xcc\x1c\xe9E\x96\xb9\xfd\x1e\x9b\x13:\xf6\xff,\x1e;\t\xa9'
Receive: 2 46.217283 46.217191 49: seq: 1f, identify_response offset=560 data=b'\xb3\xc2v\xeex \xf0\xe5V\xe8@F\xf1\xc0\xf3\x83\xd8\x1f\x94\x8c\xa3\xcc\xc7\x073\xdc\xd7\xfc\xf8\xc6\x98\x85\xe5\xe3s\xcf\xe9v\xa2\x19'
Receive: 3 46.217572 46.217493 49: seq: 10, identify_response offset=600 data=b'\xa51\xfdS\xc4\x1a\x947r\x8ff\x00\xbb\xcei\x1f\xc5x\x00\xc1\xe4\xa5\xb4\xca\x169s\x92\xe3f\xeb\xac\xa9\xb4z.\xcb\xfa\xde~'
Receive: 4 46.217902 46.217821 49: seq: 11, identify_response offset=640 data=b'\x8b\xca~>\xb7e>WiV6U~\xa4\xe5ko\x07\x8e\xce\xdf\xb2\x0e\xc3\\\x1b_%\x06\xf3I\x1eO!;\xac\xa9\x96\xdc['
Receive: 5 46.218214 46.218134 49: seq: 12, identify_response offset=680 data=b'4t\x07\x1b\x0f|h:\xb0\xf3\xfe\xa4D}\xb0\x13j\xea\x8e=6\xe5T\x0cV[\x86\xa7\xfc\xc8\x8b\xb1\xd1N\xa2\xee\x8f\xa2\xe1\xa4'
Receive: 6 46.218527 46.218448 49: seq: 13, identify_response offset=720 data=b"\xe3\xceg\x8e\x03\xca\xc3\x89\x15\x0e]\xf1\xbb\t,\xaa\x83\xb0\xb75#Xe\xaf\xac\x89\xee'\xb0h\x03/ \xa0\x0c\x15\x1f\x9cm\xa0"
Receive: 7 46.218853 46.218773 49: seq: 14, identify_response offset=760 data=b'\xb7\x0b\r\xc2\xe3 F~\x84\x81jL\x88\xc1\xd9\x8a7|\xd8\xf3\xb6|\xce\xd1\xbb\x01\x130E\x9e.?t\r?\n>\xb2hz'
Receive: 8 46.219163 46.219084 49: seq: 15, identify_response offset=800 data=b'\xdf$\xf4\xd8\x86\x9eyp\x02\xd6\x9d[\xa6\xe3Z\x19\x0fb\xbf\xe7\x03\x1eB\xa2\xc5\xa0\x03M\xdc\xe6*\xf4\x01O\xc5\xc8\xad\x80Bp'
Receive: 9 46.219475 46.219397 49: seq: 16, identify_response offset=840 data=b'_;\x01\xc1\x08\x9cJN2d\xe5P\x92\xc6\x9c\xad\xf6\xe0O\x14\x9f d=R8`\x0e4\x9cz\xbc\x05\xb0\xcc\xb3\x95v\xd0\xb9'
Receive: 10 46.219784 46.219704 49: seq: 17, identify_response offset=880 data=b'\x84\xfdr\xd0@\x1b\xb8\xf0\x9b\xe4\x9c\x86\x0b4\xbc\x02\x83\xe6\xae#\x05!\xa2cl\xbaJ\xec\x9es\xb8k\xbb\xd6\xc0\x95I1\x1d\x7f'
Receive: 11 46.220118 46.220037 49: seq: 18, identify_response offset=920 data=b'\x81\x03\x84j+\xdb\x12\x19\xdd\xe1\x1c\x1f\xe7\xf2\x9ak7\xb2&DE>I\xdf\x17+\xa7\x08\x9e\x14d\x84\xbfx\xbd\\\x92\xae\xc7\xa1'
Receive: 12 46.220436 46.220357 49: seq: 19, identify_response offset=960 data=b'\xa3\x92\xddn|,\x06\xee\x93\x83}Z\x9b\xac\n\xf3yj\xa54\xa1\x95\xb4.-\x8f\x1f\xe3\xf1+\xde\x8epx\xd6\xedv\xb0\xa12'
Receive: 13 46.220747 46.220667 49: seq: 1a, identify_response offset=1000 data=b'j\x1bB\x01\xae#\x1223\xbd\xa0V\xe3\x016<tu\xa5\x06\x9fS\x94\x0c\xb4\xd4D\x1du7VE\x12\x1f2\xf5\x95S\x1fJ'
Receive: 14 46.221053 46.220974 49: seq: 1b, identify_response offset=1040 data=b'\xb9\x0e\x93\xc7{\x02\x8a@z\xb6\xc8\x83fJ\x0c"\xd8.\xf0\x94^N\xce!\xa6\x99EX\xa6J\xff\xa3\xe14\xceptlq#'
Receive: 15 46.221371 46.221293 49: seq: 1c, identify_response offset=1080 data=b'H\xf7\xf6@x\xe0\xe5\xbd\x97\xaaD\x81\xe1a\x91_Y\x0e\xfa\x0e|\xd3r\x7f/\xf8\xa6f\x81E\x8e\xf4B\xe2\xe9\xb1(|\x0e\x05'
Receive: 16 46.221693 46.221613 49: seq: 1d, identify_response offset=1120 data=b'\xdc\x8f\x15\xd8"\x19Y\x086\x0b\x16xJ9\x16V\x9f\x85K\xa4\x85\xf4\xb3\xb5E\x98%5\x8b\xcd6\xd9\x1cm\xb9\xccfc\xe0\x8b'
Receive: 17 46.222006 46.221927 49: seq: 1e, identify_response offset=1160 data=b'\xb4g\xb9N\xb2\xc0;Z\xc8\xaa\xd5Q\xd4~A\x94\xe8\x96 H\x8b\x1d]\xe5\xc6\x9e\xf8T\x9c\xfa\xfcu\xcc\x14\x86\x06\x10\x1f\xc1m'
Receive: 18 46.222313 46.222234 49: seq: 1f, identify_response offset=1200 data=b'V\x9e\xbe\xa4t\xdd\x13?\x95b\xdb=:?=\x0b\x12C\xa2\xb3\xb3\x93$VQ\xe1f6\x96`\x9e^\x9dB\x8e\xed\xea\x18\xbd\xad'
Receive: 19 46.222631 46.222553 49: seq: 10, identify_response offset=1240 data=b'\x9fCU\xa6\x80e\x9c\xcaA9(\xf8\x05M\x0bAT\x94I\xaa\x90\xaf\xd6]n\x02X\xa0!\x88\xe3\x9ftQE\xc0\xe9\xa2#$'
Receive: 20 46.222937 46.222856 49: seq: 11, identify_response offset=1280 data=b'\xc5\xb6\xca\x01\xed\x9a\xb3\x84\x10\x88R"j\xf9\x93f\x01\x92\x12\xeb%\xc5@q+ $_j\xff}B\x0b\xe2\xd4\x9b\x19a~&'
Receive: 21 46.223244 46.223165 49: seq: 12, identify_response offset=1320 data=b'I\x05\x91\x82&z\xd9!\xd6\x89;\xe7\x18\x9c#\xdc\x04\x84\xe7\xb9R\x0f\x1a\xc5\x06:\x8b@8\xa5#\x10\xc4>\xee\xc5\x0f I\x1d'
Receive: 22 46.223566 46.223487 49: seq: 13, identify_response offset=1360 data=b'\xc9\xa9\xf0\xd3\x08\xd9\x99\xa0\xd3tR\x9cJ\x1b\x8f\x16M5\x1f/\x9f#\x02\x15\xa2\x8c\xf4S\x81=\xd9\xce\xb1N\xc7\xf5$C,\x95'
Receive: 23 46.223887 46.223807 49: seq: 14, identify_response offset=1400 data=b'{\xe6\x98<@\xf8\x10\x98\xdb[3\x0f\xb6\x0eA\xa5,h+\x14\xab\x98\r]^ \x03\nXRg\x8e3Q\xab\xd0j#?\xc5'
Receive: 24 46.224269 46.224182 49: seq: 15, identify_response offset=1440 data=b'1\xb8\x11M\x8d2D\x07q\xc2|@\xb52\x877\xfa\x19)\xef\xbbA\xa7C\xe4+\xd4\xd8*\t\x7f\xea\x05\\\x89\x9f|m\xedJ'
Receive: 25 46.224590 46.224508 49: seq: 16, identify_response offset=1480 data=b'\x8bS\xf8H`\xd0\x14UOy\r\xcf\x96\xe2\x8f&\xcb\xc5\xe6\xc9\xd5\xf7\xd7\xf9\xcd\xd5?1\x99\xd9\xc2\x15]\xff\xf4\xcb\xf5\x8f\xf9\x0f'
Receive: 26 46.224902 46.224821 49: seq: 17, identify_response offset=1520 data=b'\xbf\xbd\xfe\x15\xfb\x02\xf4w\xb6\xba\xb9\xfe\xb0\xba\\\xd5\xa2\x9d\x9eVg\xabw\xd7W\xcaV\x0c\x19(\xd4\xbb\x7f\xdc\xd00\n7\x18q'
Receive: 27 46.225209 46.225128 49: seq: 18, identify_response offset=1560 data=b'o\xdf_\xbd\xbf\xcdo?\xdc\xdc\xfe\x9a\x7fwu\xfb\x1a\x13\xc8\xf4#\xa6\x90\x13$\xb5\xaa\x10S\xad\x1b\x9d*\xe9\xcf\x8b\xf5\xea\xf2_'
Receive: 28 46.225519 46.225439 49: seq: 19, identify_response offset=1600 data=b'\xeb\xb3 \xf9\x1dPA\xd5TsGEm\x04\xa8\x9d\xb2\xdf!_\xecEG\x98af\xc6\xe5A\xf4\xebo^\x82\x04\x16\x02\xf3\x0bX'
Receive: 29 46.225827 46.225745 49: seq: 1a, identify_response offset=1640 data=b"ha\t\x14\xcesXda\x19h\xf8\x1c\x16[X\x10@\xe10\x07&\x0e\x18\xc7KnR\x07\xdc\x84Kv6\x8e\xd5u\xb0\xe4'"
Receive: 30 46.226137 46.226056 49: seq: 1b, identify_response offset=1680 data=b's\xc0hm\x18\x02\x97C\xa7\x87\x0f\x04\xa5I\x026\x1e\xa4\x0e\x14x `\xd5\x07\x85\x1e\x08.\xce\x07E\x1e(\x8bg\xa0\xd8\x81R'
Receive: 31 46.226440 46.226359 49: seq: 1c, identify_response offset=1720 data=b'\xd0\x0f\x1f\x94x\xa0`\xceF\xea\x81\xa29\x1b\x1b\x0f\x14+6>\xce\xdc#\xd4yJ\x19\x82(\x8aV\x97\xa0\x91\x85L\xd6\xf1\xa6R'
Receive: 32 46.226748 46.226667 49: seq: 1d, identify_response offset=1760 data=b'9\xecX\xf3d\x1d\x84w\xa0d\x9aJ\xab\x14|V\xfcam\xd4\n\xf7\xa3\xa9@M\x81J\xfa\x93\xa1\x9aL\x82\xd0\x9f\x8c\xd4\xe4\xc6'
Receive: 33 46.227055 46.226975 49: seq: 1e, identify_response offset=1800 data=b'\x88\x86&c5\x19\xac\xc3\xd8\x9fMh6\xccf[\xa54k\xaf\x84f74\x0b\x8e\xce\x9c\x15\xf2\x14\x81\x8eb\x80\x8a2\x17\x956'
Receive: 34 46.227362 46.227281 49: seq: 1f, identify_response offset=1840 data=b'M\xa6LxGy%\xb5\xb1\xae\xea\x9ai\x0b4\xa1I\xb2f\x92#;\x14\x0f\x1c\xebc\xcc\x1f\xb9\x1fz\xa8\xc5wU\xa3\x0b{f'
Receive: 35 46.227672 46.227591 49: seq: 10, identify_response offset=1880 data=b'\xa6L\xab(\xae^\x17-k\xbb\x91\x81/c\x18\x0f\x18\xdc\x04\x113E\xcc\x1e\x0f\x02\xbe\xc9\xb5H\xd6\x83s\x04\x16)p\x03\xed\x97'
Receive: 36 46.227979 46.227898 49: seq: 11, identify_response offset=1920 data=b'#\x06J&\xc5\x1eV\x85\xdd\x8b\x91\t\xc9\n\xbd\x17\xb5M\xa8|\xd4\xc8\x12Q\xd1-Q\x91K\xb3*OP\xb9\x16l\xc7[f:'
Receive: 37 46.228384 46.228297 49: seq: 12, identify_response offset=1960 data=b'\x0b\x96\x1er\x89kj\xf9\xb2\xbe\x18$\x80T?P\xd5\x8f\x060p\xc8Q\xe4\xa8\x1a\xbf\xd7\xddTWt.\xe5{\xbf\xbf\r\xb2\xef'
Receive: 38 46.228700 46.228619 49: seq: 13, identify_response offset=2000 data=b' oF\xb6\x80\x18k\x9a\xa2\xa2f\xcc_Be_\x81\xcb\xac \xe5\x11\xe3+J#\xff"Y3\x8d\xfc\xc9\xd2\x81\x18\x0c\xde\xfcf'
Receive: 39 46.229029 46.228933 49: seq: 14, identify_response offset=2040 data=b'\xb1\xa5k \x10\x7fd7@\x8aRi\xd1\xf4\xb45\xa3\x12\x19K\x9e\xd7xx\x06\xb1o\xc4\x06D\xd3\x01\x1b]+t\xf4\xd1x\x98'
Receive: 40 46.229328 46.229245 49: seq: 15, identify_response offset=2080 data=b'\xaa\x12\x1eDFr\xa3\x8cN\x9d\xd8\x15p\x8c+\xcc\xb7\xa6\xac\xe3\x87n(\xb9mB1\xddq\xa7~\xe6\x9bwo\x7fah\xb8\x0c'
Receive: 41 46.229640 46.229559 49: seq: 16, identify_response offset=2120 data=b'\x94Y\x00\x1a\xcaa\x079`E\x15\xd7[\xcai\xbdu\xb1\x97\xcbDu\x86\x99\xa2\x96[\x07\xba\xa4\xfa\xfb\x9a\x0b\xea\\~\x82Ti'
Receive: 42 46.229946 46.229866 49: seq: 17, identify_response offset=2160 data=b'9R\xc2]\x8c\x05\x08\xe4\xcbo\xbe\xa4\xe2\xc0\x10\x99V\xb7\xeb\xbcSfJ5\x98\xc1\xb2GI\xfc9@C\xdd\x02\xdb\x81\xb4\x96Z'
Receive: 43 46.230256 46.230175 49: seq: 18, identify_response offset=2200 data=b'R\x06\xd8t`YZ\xbd\x18\xf6M1\x8c:\xb0\xed\xb2\xda\xbe*\xa5YGp]\xf5\xda\xfd#\x8f\x01\xb0\x08F~\x0e\x9bDf\xd6'
Receive: 44 46.230562 46.230482 49: seq: 19, identify_response offset=2240 data=b"\xf4Z\xb5\xa53\x90\x96\n\xe5\x94@.\xb1\x0c\xc8\xdb\x1b\xbb\x99&\xda\x87\x9b\xd9\xbc\xae\x7f\xd45\xd2\xce\xb1'\xa4Y}\xe3\xe1`w"
Receive: 45 46.230870 46.230787 49: seq: 1a, identify_response offset=2280 data=b'\xe4\xa6xB\xdd\xcd\x8c\xbc\xa93y\xc3\xa5,\xf6\x9c\xf1\xb6\x84\xfc\xd0\x18(\xf0r#\xa4\xe4\xb0%\xd4\xc5\xd5T\xa3\xbe\x011\xa6\xe5'
Receive: 46 46.231174 46.231093 49: seq: 1b, identify_response offset=2320 data=b'Lg*\xca\x18\xf8\x03\xc7\x8b\xc2\x8c\xfce\x82C1T\xcaCill\xcc\xbd\x8cm\xe4\xa2\x91\xf1\xc1\xe7\x06\xafR\xd52\x0c\xbe\x86'
Receive: 47 46.231484 46.231404 49: seq: 1c, identify_response offset=2360 data=b']\xdd=R\xf5\xf4\x1b\xd7\x0b\xc0Rh@\x83\xb28\xf0\xa6}\x81>\x05\xbb6\xb7\x16\xe1\x88o\xf6(\xc0/\xf3\xa7\x92\x03\xd4\xef7'
Receive: 48 46.231790 46.231710 49: seq: 1d, identify_response offset=2400 data=b'S2\xea(g,}\x82\nK.\x8f\xca\x9c\xf8\x13\x14\x98%\xde\xf2Q\xdf\x89b\x1b1D35f\xce\xd8\x02\x9e\xc5\xda5v\xc0'
Receive: 49 46.232183 46.232097 49: seq: 1e, identify_response offset=2440 data=b'`1\xe5w\x95;\xf3\x1f\xa3n\xb5#\x1e\xbb\x8e\xed\n%\x13\x92\x076\xfc\xde\xfb*\xa2\xfd\x9e\xea\xbdS\x7f\xfc\xbd\x92"R\x82['
Receive: 50 46.232501 46.232418 49: seq: 1f, identify_response offset=2480 data=b'\x92\\50\xdf\xc3\x08t\xff\x19\x9bd\xdawHzX\xb3\x10\xd4X\x0b\xc1T\xffC[\xdca4\xea\xb4"+i\x10\x06\xf5\xf8\x1c'
Receive: 51 46.232819 46.232738 49: seq: 10, identify_response offset=2520 data=b'\x02h\x02\\,\xae\x00\t\xd3XS\xd3\xc9\x81\x95\xc7Y\xfa.\xea\x1e/\x90\x8a\xaat\xe0\xf51X\xc7\x02\x1b\x89\rn\x9c\x1d\xe1\xba'
Receive: 52 46.233132 46.233050 49: seq: 11, identify_response offset=2560 data=b"\x93R\x9d\xb4\x04\xfb\x1c\x81\xf6r\xea\xeb-\xb0P\xd1\x8e\xd0\xd2#4';z\xa9s`\x15\x8df\xac\x84>\x18\xc3\xef\xed\xbb\xb7\xaa"
Receive: 53 46.233448 46.233367 49: seq: 12, identify_response offset=2600 data=b'\xb2\xa3\xee\xdb1L\xf6\x1c\x93\x86$Y\x02\xdb\xae=\xbf\xc3\xc8\xa3lo\xc1\xc5\x8cI\xed\x00\x8d\xd4\xb4\xbfJfwH\xddL\\\xba'
Receive: 54 46.233759 46.233678 49: seq: 13, identify_response offset=2640 data=b'\x17\xd4\x93\xd70\x02\xcc\xce\x00\xb7\xab^\x7f\xf3\xf20\xb5\xf7\xa0|\x90\xaaT\xf4\xa8\xe8\xcdK\x07\x00n\xc8\xeb\xe9 \x8bN\x1d\xaa-'
Receive: 55 46.234069 46.233989 49: seq: 14, identify_response offset=2680 data=b'\xc9J\xc9T\xc5\x11\xaf\xe7OCp\x9e\x1a\xf2\x98\x07X\x80\x98P\xe9\x895\x91\xedQ\x87\xf9\x92\xfd\x02\xf9\x10\xd49wX\xa6\xed\xf0'
Receive: 56 46.234378 46.234298 49: seq: 15, identify_response offset=2720 data=b'\x85A\xfe\x8d\xaaA\xf5>mS#\xfdj]\xd1\xb3\x81\xc4>-zx\xf2=%\x80\x11\x84u5$e\xeaA\xf1\xe7\xab\xeb\x1f\xe9'
Receive: 57 46.234692 46.234611 49: seq: 16, identify_response offset=2760 data=b'\x85\xc7\xbcq\xa8\xf2\x18\r\xac.\x06\xcc"\xb0\x1dp\xa2\x06D\xab&\xa7\x8e/F:\xa9"\'\x88\x95/\xa4\x9fG\xaf*\x98\x7fB'
Receive: 58 46.235002 46.234921 49: seq: 17, identify_response offset=2800 data=b'A\x17\x05Y\x92\xa8\x84[\x0fR\x95q\xd3 M\x94\x8b\x80A\x9an\xe0;\xfa\x08+\xd5p1-\x1a\xfb\n\x9f\xf1\xdf\xbc\xfb\xe9!'
Receive: 59 46.235310 46.235229 49: seq: 18, identify_response offset=2840 data=b'Z\xa9>\x10$1\x92KW\xd2\xe5\xa2\x9du\x13\x95\xc7\xceOu\x9f\xce1{4\xef\xee3\x92\xc2k\xb32\x05\xa1\x06\xc19\xe6\x8b'
Receive: 60 46.235620 46.235540 49: seq: 19, identify_response offset=2880 data=b'\x94\x0b\xb9z\xfc\xdc=\x89\x83\x9f\xd0\x0f\x10\xaadW\xef\x148g\xeeU\xf5A <\xe4\xb6\xad\x85\xe4\x01\x92\xab\xfe\xed\xa7\x18\xd7$'
Receive: 61 46.235935 46.235853 49: seq: 1a, identify_response offset=2920 data=b'\xfa#\xf7\xf6\x0f\xb6\xeeuH\x82\x97\xb4\x8f=\xe7\xe8\xbaug\xd7\xc0>%\x14A^V\xaf\xea=\x0b\xcd\xd8:t\r\xd8\xe3\xf1"'
Receive: 62 46.236279 46.236193 49: seq: 1b, identify_response offset=2960 data=b"\xfe\xc3\x0f\xee\xbdq\xaf\x1d\xb9\xb9'\xaf\xbf\xaa\xc6F\xac\x91{Q\xf0p\xed\xd3\x02\xb5h.\x10\x17\x9fF\x9c@\xd9\xb2\xbe!\x99B"
Receive: 63 46.236594 46.236512 49: seq: 1c, identify_response offset=3000 data=b'\xf9\xb3z\xb1\xbd\xec\x1d\xc0\xbc3\xf8\xc2L\xbd\xd7\x84\xb9\xcc\xe4T\x96\xea\x89D\x1d\x0f\x18\x016\xfdW\xba\xf3\x88\xec\r\xec\x1f*\xc5'
Receive: 64 46.236905 46.236825 49: seq: 1d, identify_response offset=3040 data=b'\xfa~\xd6e\x92\x98\xe5\xb5%_\xbcG\x9cc\xbe\xe7\xd3\xcc\x1a\xcb\xaei\xaa{\xc3\xa6\x97C\xbdG\x7f\xc9\xbbi\xb7\xe3\x10o\xa9\xeb'
Receive: 65 46.237216 46.237135 49: seq: 1e, identify_response offset=3080 data=b'\x0f\xc5\x108\x95\xdcd"R\xab\x1a\xe6#.\xf1\xb6\xcf\x14\xa7e\x18\x9dj$\x1e\xdd\xa4\xdf\x9a\xf6\xaf\x14]\xa5\xdf\xb9\xfb\xac\n\xc4'
Receive: 66 46.237523 46.237442 49: seq: 1f, identify_response offset=3120 data=b'\xaaX\x1dF\x95\xb0o\x03*]\xa5S{95\xfaG\xfe\xa1\xaej\x1b\xbbf\xdc\xa2SG\x0f?\x02\x97\xcd\x16N\xe8/\x98\xc1d'
Receive: 67 46.237827 46.237747 49: seq: 10, identify_response offset=3160 data=b'\xcc\x00\xef\xd9o\xe0\x1d\x1f\x01[w\xc4~\xe07\xe5\x9c\xae\x95\x85\xed\x10\x9e|\xd8\xf2\xfd\x08V\xe1\xf4^\xc9\xe8\xff\x01&\x0f\xbaM'
Receive: 68 46.238134 46.238054 41: seq: 11, identify_response offset=3200 data=b"\xc0\t\xea\xff\x82\x02'\xf8\xb0\xbe\x08\xc2\x8b5\x8898\xdf\x87\xbb\x94o\xe3r\xbb\xfa\xf8\x1f\xeb\x91a\xe5"
Receive: 69 46.238441 46.238361 9: seq: 12, identify_response offset=3232 data=b''
Receive: 70 46.261413 46.261249 12: seq: 13, uptime high=0 clock=1913068206
Receive: 71 46.312366 46.312263 11: seq: 14, clock clock=1915616214
Receive: 72 46.362881 46.362788 11: seq: 15, clock clock=1918142112
Receive: 73 46.413640 46.413510 11: seq: 16, clock clock=1920679828
Receive: 74 46.464186 46.464093 11: seq: 17, clock clock=1923207372
Receive: 75 46.514658 46.514569 11: seq: 18, clock clock=1925730953
Receive: 76 46.565396 46.565171 11: seq: 19, clock clock=1928265136
Receive: 77 46.616483 46.616261 11: seq: 1a, clock clock=1930819269
Receive: 78 46.668548 46.668282 11: seq: 1b, clock clock=1933422240
Receive: 79 46.670960 46.670692 11: seq: 1c, clock clock=1933542269
Receive: 80 46.696969 46.696630 10: seq: 1d, config is_config=0 crc=0 is_shutdown=0 move_count=0
Receive: 81 46.699496 46.699243 15: seq: 10, config is_config=1 crc=3912464276 is_shutdown=0 move_count=1024
Receive: 82 47.654933 47.654781 11: seq: 11, clock clock=1982743981
Receive: 83 48.400138 47.654781 14: seq: 11, stats count=147 sum=160150 sumsq=1048473
Receive: 84 48.639357 48.639144 11: seq: 12, clock clock=2031964473
Receive: 85 49.623951 49.623835 11: seq: 13, clock clock=2081195561
Receive: 86 50.608660 50.608557 11: seq: 14, clock clock=2130430740
Receive: 87 51.593639 51.593534 11: seq: 15, clock clock=2179679646
Receive: 88 52.578605 52.578265 11: seq: 16, clock clock=2228921072
Receive: 89 53.400165 52.578265 13: seq: 16, stats count=55 sum=30428 sumsq=170452
Receive: 90 53.562830 53.562676 11: seq: 17, clock clock=2278139051
Receive: 91 54.546920 54.546807 11: seq: 18, clock clock=2327343803
Receive: 92 55.531226 55.531108 11: seq: 19, clock clock=2376559110
Receive: 93 56.515644 56.515529 11: seq: 1a, clock clock=2425780002
Receive: 94 57.500231 57.500116 11: seq: 1b, clock clock=2475009288
Receive: 95 58.400286 57.500116 13: seq: 1b, stats count=55 sum=24508 sumsq=84609
Receive: 96 58.484776 58.484458 11: seq: 1c, clock clock=2524232254
Receive: 97 59.469650 59.469267 11: seq: 1d, clock clock=2573474970
Receive: 98 60.454251 60.454122 11: seq: 1e, clock clock=2622710292
Receive: 99 60.624606 60.624349 12: seq: 1f, shutdown clock=2631222608 static_string_id=Command request
Stats 61.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=7 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=921 bytes_read=4972 bytes_retransmit=0 bytes_invalid=0 send_seq=128 receive_seq=128 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000026 adj=49996828 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.889 memavail=7489296 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 62.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=8 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000009 mcu_task_stddev=0.000009 bytes_write=927 bytes_read=4988 bytes_retransmit=0 bytes_invalid=0 send_seq=129 receive_seq=129 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000015 adj=49996666 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.897 memavail=7489296 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 63.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=9 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000020 bytes_write=933 bytes_read=5017 bytes_retransmit=0 bytes_invalid=0 send_seq=130 receive_seq=130 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999996 adj=49996556 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.906 memavail=7489296 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 64.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=10 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000020 bytes_write=939 bytes_read=5033 bytes_retransmit=0 bytes_invalid=0 send_seq=131 receive_seq=131 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999980 adj=49996425 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.52 cputime=2.914 memavail=7489296 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 65.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=11 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000020 bytes_write=945 bytes_read=5049 bytes_retransmit=0 bytes_invalid=0 send_seq=132 receive_seq=132 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000010 adj=49996340 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.934 memavail=7485800 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 66.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=12 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000020 bytes_write=951 bytes_read=5065 bytes_retransmit=0 bytes_invalid=0 send_seq=133 receive_seq=133 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999999 adj=49996509 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.945 memavail=7489412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 67.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=13 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000013 mcu_task_stddev=0.000020 bytes_write=957 bytes_read=5081 bytes_retransmit=0 bytes_invalid=0 send_seq=134 receive_seq=134 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999985 adj=49996422 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.954 memavail=7489412 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 68.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=14 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=963 bytes_read=5110 bytes_retransmit=0 bytes_invalid=0 send_seq=135 receive_seq=135 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999972 adj=49996339 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.963 memavail=7504680 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 69.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=15 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=969 bytes_read=5126 bytes_retransmit=0 bytes_invalid=0 send_seq=136 receive_seq=136 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999980 adj=49996274 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.48 cputime=2.973 memavail=7500304 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 70.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=16 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=975 bytes_read=5142 bytes_retransmit=0 bytes_invalid=0 send_seq=137 receive_seq=137 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=49999977 adj=49996351 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.44 cputime=2.982 memavail=7506448 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 71.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=17 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=981 bytes_read=5158 bytes_retransmit=0 bytes_invalid=0 send_seq=138 receive_seq=138 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000032 adj=49996338 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.44 cputime=3.002 memavail=7502416 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 72.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=18 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000012 bytes_write=987 bytes_read=5174 bytes_retransmit=0 bytes_invalid=0 send_seq=139 receive_seq=139 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000045 adj=49996701 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.44 cputime=3.013 memavail=7506456 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 73.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=19 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=993 bytes_read=5203 bytes_retransmit=0 bytes_invalid=0 send_seq=140 receive_seq=140 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000069 adj=49996722 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.44 cputime=3.022 memavail=7504348 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 74.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=20 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=999 bytes_read=5219 bytes_retransmit=0 bytes_invalid=0 send_seq=141 receive_seq=141 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000082 adj=49996818 Octopus_Max: temp=36.4 Pi: temp=37.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.44 cputime=3.032 memavail=7501228 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 75.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=21 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1005 bytes_read=5235 bytes_retransmit=0 bytes_invalid=0 send_seq=142 receive_seq=142 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000100 adj=49996823 Octopus_Max: temp=36.4 Pi: temp=37.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.41 cputime=3.040 memavail=7501228 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 76.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=22 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1011 bytes_read=5251 bytes_retransmit=0 bytes_invalid=0 send_seq=143 receive_seq=143 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000117 adj=49996867 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.41 cputime=3.049 memavail=7500988 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 77.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=23 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1017 bytes_read=5267 bytes_retransmit=0 bytes_invalid=0 send_seq=144 receive_seq=144 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000166 adj=49996895 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.41 cputime=3.069 memavail=7495976 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 78.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=24 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1023 bytes_read=5296 bytes_retransmit=0 bytes_invalid=0 send_seq=145 receive_seq=145 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000185 adj=49997174 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.41 cputime=3.079 memavail=7497144 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 79.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=25 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1029 bytes_read=5312 bytes_retransmit=0 bytes_invalid=0 send_seq=146 receive_seq=146 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000200 adj=49997165 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.41 cputime=3.088 memavail=7497152 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 80.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=26 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1035 bytes_read=5328 bytes_retransmit=0 bytes_invalid=0 send_seq=147 receive_seq=147 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000215 adj=49997138 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.37 cputime=3.096 memavail=7497152 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 81.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=27 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1041 bytes_read=5344 bytes_retransmit=0 bytes_invalid=0 send_seq=148 receive_seq=148 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000231 adj=49997124 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.37 cputime=3.105 memavail=7497152 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 82.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=28 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000011 mcu_task_stddev=0.000014 bytes_write=1047 bytes_read=5360 bytes_retransmit=0 bytes_invalid=0 send_seq=149 receive_seq=149 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000246 adj=49997131 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.37 cputime=3.113 memavail=7497152 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 83.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=30 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000014 bytes_write=1053 bytes_read=5389 bytes_retransmit=0 bytes_invalid=0 send_seq=150 receive_seq=150 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000282 adj=49997131 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.37 cputime=3.133 memavail=7497152 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 84.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=31 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000014 bytes_write=1059 bytes_read=5405 bytes_retransmit=0 bytes_invalid=0 send_seq=151 receive_seq=151 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000295 adj=49997311 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.37 cputime=3.141 memavail=7497300 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 85.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=32 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000014 bytes_write=1065 bytes_read=5421 bytes_retransmit=0 bytes_invalid=0 send_seq=152 receive_seq=152 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000307 adj=49997264 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.34 cputime=3.150 memavail=7492376 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 86.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=33 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000014 bytes_write=1071 bytes_read=5437 bytes_retransmit=0 bytes_invalid=0 send_seq=153 receive_seq=153 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000319 adj=49997228 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.34 cputime=3.159 memavail=7498560 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 87.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=34 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000010 mcu_task_stddev=0.000014 bytes_write=1077 bytes_read=5453 bytes_retransmit=0 bytes_invalid=0 send_seq=154 receive_seq=154 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000331 adj=49997203 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.34 cputime=3.167 memavail=7498112 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 88.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=35 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1083 bytes_read=5482 bytes_retransmit=0 bytes_invalid=0 send_seq=155 receive_seq=155 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000343 adj=49997193 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.34 cputime=3.177 memavail=7498112 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 89.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=36 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1089 bytes_read=5498 bytes_retransmit=0 bytes_invalid=0 send_seq=156 receive_seq=156 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000376 adj=49997186 Octopus_Max: temp=36.4 Pi: temp=35.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.34 cputime=3.197 memavail=7498116 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 90.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=37 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1095 bytes_read=5514 bytes_retransmit=0 bytes_invalid=0 send_seq=157 receive_seq=157 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000396 adj=49997389 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.32 cputime=3.217 memavail=7498116 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 91.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=38 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1101 bytes_read=5530 bytes_retransmit=0 bytes_invalid=0 send_seq=158 receive_seq=158 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000414 adj=49997427 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.32 cputime=3.237 memavail=7498116 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 92.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=39 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1107 bytes_read=5546 bytes_retransmit=0 bytes_invalid=0 send_seq=159 receive_seq=159 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000434 adj=49997438 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.32 cputime=3.257 memavail=7498116 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 93.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=40 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1113 bytes_read=5574 bytes_retransmit=0 bytes_invalid=0 send_seq=160 receive_seq=160 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000458 adj=49997477 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.32 cputime=3.278 memavail=7498128 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 94.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=41 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1119 bytes_read=5588 bytes_retransmit=0 bytes_invalid=0 send_seq=161 receive_seq=161 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000475 adj=49997555 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.32 cputime=3.298 memavail=7498128 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 95.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=42 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1125 bytes_read=5603 bytes_retransmit=0 bytes_invalid=0 send_seq=162 receive_seq=162 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000489 adj=49997544 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.29 cputime=3.318 memavail=7498128 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 96.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=43 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1131 bytes_read=5618 bytes_retransmit=0 bytes_invalid=0 send_seq=163 receive_seq=163 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000499 adj=49997520 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.29 cputime=3.338 memavail=7498572 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 97.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=44 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1137 bytes_read=5633 bytes_retransmit=0 bytes_invalid=0 send_seq=164 receive_seq=164 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000510 adj=49997466 Octopus_Max: temp=36.4 Pi: temp=35.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.29 cputime=3.358 memavail=7498700 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 98.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=45 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1143 bytes_read=5648 bytes_retransmit=0 bytes_invalid=0 send_seq=165 receive_seq=165 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000519 adj=49997442 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.29 cputime=3.376 memavail=7501008 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 99.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=46 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1149 bytes_read=5677 bytes_retransmit=0 bytes_invalid=0 send_seq=166 receive_seq=166 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000510 adj=49997401 Octopus_Max: temp=36.4 Pi: temp=36.5  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.29 cputime=3.385 memavail=7502276 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 100.6: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=47 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1155 bytes_read=5693 bytes_retransmit=0 bytes_invalid=0 send_seq=167 receive_seq=167 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000501 adj=49997183 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.27 cputime=3.394 memavail=7502276 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 101.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=48 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1161 bytes_read=5709 bytes_retransmit=0 bytes_invalid=0 send_seq=168 receive_seq=168 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000491 adj=49997023 Octopus_Max: temp=36.4 Pi: temp=37.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.27 cputime=3.402 memavail=7502276 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 102.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=49 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1167 bytes_read=5725 bytes_retransmit=0 bytes_invalid=0 send_seq=169 receive_seq=169 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000483 adj=49996888 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.27 cputime=3.412 memavail=7503260 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 103.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=50 freq=400028783 rpi: mcu_awake=0.001 mcu_task_avg=0.000020 mcu_task_stddev=0.000023 bytes_write=1173 bytes_read=5741 bytes_retransmit=0 bytes_invalid=0 send_seq=170 receive_seq=170 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000478 adj=49996804 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.27 cputime=3.422 memavail=7503260 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
Stats 104.7: gcodein=0  mcu: mcu_awake=0.000 mcu_task_avg=0.000002 mcu_task_stddev=0.000001 bytes_write=9349 bytes_read=13971 bytes_retransmit=9 bytes_invalid=0 send_seq=646 receive_seq=646 retransmit_seq=2 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=51 freq=400028783 rpi: mcu_awake=0.000 mcu_task_avg=0.000008 mcu_task_stddev=0.000009 bytes_write=1179 bytes_read=5770 bytes_retransmit=0 bytes_invalid=0 send_seq=171 receive_seq=171 retransmit_seq=0 srtt=0.000 rttvar=0.000 rto=0.025 ready_bytes=0 upcoming_bytes=0 freq=50000482 adj=49996767 Octopus_Max: temp=36.4 Pi: temp=36.0  heater_bed: target=0 temp=23.1 pwm=0.000 bed_mat: temp=22.6 bed_core: temp=23.6 sysload=0.27 cputime=3.443 memavail=7503260 print_time=0.000 buffer_time=0.000 print_stall=0 extruder: target=0 temp=23.4 pwm=0.000
webhooks client 4127182752: Disconnected
Starting Klippy...
Args: ['/home/pi/klipper/klippy/klippy.py', '/home/pi/printer_data/config/printer.cfg', '-l', '/home/pi/printer_data/logs/klippy.log', '-I', '/home/pi/printer_data/comms/klippy.serial', '-a', '/home/pi/printer_data/comms/klippy.sock']
Git version: 'v0.12.0-171-g2f6e94c9-dirty'
Untracked files: klippy/extras/autotune_tmc.py, klippy/extras/beacon.py, klippy/extras/gcode_shell_command.py, klippy/extras/linear_movement_vibrations.py, klippy/extras/motor_constants.py, klippy/extras/ratos_homing.py
Branch: master
Remote: origin
Tracked URL: https://github.com/Klipper3d/klipper.git
CPU: 4 core ?
Python: '3.9.2 (default, Mar 12 2021, 04:06:34) \n[GCC 10.2.1 20210110]'
Start printer at Sun Apr 21 06:51:35 2024 (1713678695.1 24.7)
===== Config file =====
[board_pins octopus_max_ez_tmc2209]
aliases = 
	
	
	motor_1_step=PC13, motor_1_dir=PC14, motor_1_enable=PE6, motor_1_uart=PG14,
	motor_2_step=PE4, motor_2_dir=PE5, motor_2_enable=PE3, motor_2_uart=PG13,
	motor_3_step=PE1, motor_3_dir=PE0, motor_3_enable=PE2, motor_3_uart=PG12,
	motor_4_step=PB8, motor_4_dir=PB9, motor_4_enable=PB7, motor_4_uart=PG11,
	motor_5_step=PB5, motor_5_dir=PB4, motor_5_enable=PB6, motor_5_uart=PG10,
	motor_6_step=PG15, motor_6_dir=PB3, motor_6_enable=PD5, motor_6_uart=PG9,
	motor_7_step=PD3, motor_7_dir=PD2, motor_7_enable=PD4, motor_7_uart=PD7,
	motor_8_step=PA10, motor_8_dir=PA9, motor_8_enable=PA15, motor_8_uart=PD6,
	motor_9_step=PA8, motor_9_dir=PC7, motor_9_enable=PC9, motor_9_uart=PG8,
	motor_10_step=PG6, motor_10_dir=PC6, motor_10_enable=PC8, motor_10_uart=PG7,
	
	stepper_spi_mosi=PE14, stepper_spi_miso=PE13, stepper_spi_sclk=PE12,
	
	
	heater_e0=PF6, heater_e1=PA3, heater_e2=PF9, heater_e3=PF7, heater_bed=PF5,
	
	
	thermistor_e0=PB0, thermistor_e1=PC5, thermistor_e2=PC4, thermistor_e3=PA7, thermistor_bed=PB1,
	
	
	endstop_motor_1=PF0, endstop_motor_2=PF2, endstop_motor_3=PF4, det_motor_4=PF3, det_motor_5=PF1, det_motor_6=PC15,
	
	
	fan_0=PA6, fan_1=PA5, fan_2=PA4, fan_3=PA3,
	fan_4_pwm=PA1, fan_4_tach=PC3, fan_5_pwm=PF8, fan_5_tach=PC1, fan_6_pwm=PA2, fan_6_tach=PC2,
	
	
	rgb_led_1=PE10, rgb_led_2=PE9,
	
	
	ps_on=PF13, pwr_det=PF12,
	
	
	bltouch_servo=PB14, bltouch_probe=PB15,
	
	
	proximity_probe=PF11,
	
	
	filament_sensor_adc1=PC0, filament_sensor_adc2=PF10,
	
	
	eeprom_scl=PB10, eeprom_sda=PB11,
	
	
	can_rx=PD0, can_tx=PD1,
	
	
	tft_uart_rx=PD9, tft_uart_tx=PD8,
	
	
	usb_dm=PA11, usb_dp=PA12,
	
	
	lcd_d7=PE15, lcd_d6=PD10, lcd_d5=PD11, lcd_d4=PD12, lcd_rs=PD13, lcd_en=PD14, lcd_buzzer=PG2, lcd_enc=PD15,
	lcd_reset=RESET, sd_detect=PG3,
	
	
	tmc_spi_cs=PF14, tmc_spi_mosi=PE14, tmc_spi_miso=PE13, tmc_spi_sclk=PE12,
	
	
	wifi_reset=PB2, wifi_io0=PG0, wifi_io4=PF15, wifi_rx=PE7, wifi_tx=PE8, wifi_cs=PG15, wifi_mosi=PC12, wifi_miso=PC11, wifi_sclk=PC10,

[mcu]
baud = 250000
serial = /dev/btt-octopus-max-ez

[temperature_sensor Octopus_Max]
sensor_type = temperature_mcu
min_temp = 0
max_temp = 100

[mcu rpi]
serial = /tmp/klipper_host_mcu

[temperature_sensor Pi]
sensor_type = temperature_host
min_temp = 0
max_temp = 100

[idle_timeout]
gcode = 
	{% if printer.webhooks.state|lower == 'ready' %}
	{% if printer.pause_resume.is_paused|lower == 'false' %}
	M117 Idle timeout reached
	TURN_OFF_HEATERS
	M84
	{% endif %}
	{% endif %}
timeout = 7200

[skew_correction]

[input_shaper]
shaper_type_x = ei
shaper_freq_x = 101.2
shaper_type_y = mzv
shaper_freq_y = 72.8

[virtual_sdcard]
path = ~/printer_data/gcodes

[display_status]

[pause_resume]

[force_move]
enable_force_move = True

[respond]

[exclude_object]

[gcode_arcs]
resolution = 0.3

[heater_bed]
heater_pin = heater_bed
sensor_type = temperature_combined
sensor_list = temperature_sensor bed_mat, temperature_sensor bed_core
combination_method = mean
maximum_deviation = 999999
min_temp = 0
max_temp = 140
pwm_cycle_time = 0.02
control = pid
pid_kp = 55.540
pid_ki = 1.448
pid_kd = 532.581

[temperature_sensor bed_mat]
sensor_pin = thermistor_bed
sensor_type = Generic 3950
min_temp = 0
max_temp = 150

[temperature_sensor bed_core]
sensor_pin = thermistor_e0
sensor_type = PT1000
pullup_resistor = 2200
min_temp = 0
max_temp = 150

[fan]
pin = fan_4_pwm
tachometer_pin = ^fan_4_tach
shutdown_speed = 1.0
tachometer_poll_interval = 0.0005
cycle_time = 0.01

[heater_fan toolhead]
pin = fan_0
fan_speed = 1.0
shutdown_speed = 1.0
kick_start_time = 5
heater = extruder
heater_temp = 49

[controller_fan controller_fan]
pin = fan_6_pwm
tachometer_pin = ^fan_6_tach
tachometer_poll_interval = 0.0005
cycle_time = 0.01
idle_timeout = 300
stepper = stepper_x, stepper_x1, stepper_y, stepper_y1, stepper_z, stepper_z1, stepper_z2, extruder

[printer]
kinematics = corexy
max_velocity = 800
max_accel = 12000
minimum_cruise_ratio = 0.5
max_z_velocity = 20
max_z_accel = 150
square_corner_velocity = 5

[ratos_homing]
axes = xyz
z_hop = 15
z_hop_speed = 15
gcode = 
	{% set x_homed = 'x' in printer.toolhead.homed_axes %}
	{% set y_homed = 'y' in printer.toolhead.homed_axes %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set z_probe = printer["gcode_macro RatOS"].z_probe|lower %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set homing_x = printer["gcode_macro RatOS"].homing_x|lower %}
	{% set homing_y = printer["gcode_macro RatOS"].homing_y|lower %}
	{% set homing = printer["gcode_macro RatOS"].homing|lower %}
	{% set prev_stop_on_error = printer["gcode_macro RatOS"].stowable_probe_stop_on_error %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE=True
	
	M400
	G90
	
	{% if params.X is defined or params.Y is not defined and params.Z is not defined %}
	RESPOND MSG="Homing X"
	{% if homing_x == 'endstop' or homing == 'endstops' %}
	G28 X
	{% elif homing_x == 'sensorless' or homing == 'sensorless' %}
	HOME_X_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_x to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_x, homing)) }
	{% endif %}
	{% set x_homed = True %}
	G0 X{safe_home_x} F{speed}
	M400
	{% endif %}
	
	{% if params.Y is defined or params.X is not defined and params.Z is not defined %}
	RESPOND MSG="Homing Y"
	{% if homing_y == 'endstop' or homing == 'endstops' %}
	G28 Y
	{% elif homing_y == 'sensorless' or homing == 'sensorless' %}
	HOME_Y_SENSORLESS
	{% else %}
	{ action_emergency_stop("expected RatOS variable_homing_y to be 'sensorless' 'endstop' or variable_homing to be 'sensorless' or 'endstops' but found {} and {}".format(homing_y, homing)) }
	{% endif %}
	{% set y_homed = True %}
	G0 Y{safe_home_y} F{speed}
	M400
	{% endif %}
	
	{% if params.Z is defined or params.Y is not defined and params.X is not defined %}
	RESPOND MSG="Homing Z"
	{% if x_homed == False or y_homed == False %}
	M118 X and Y must be homed before homing Z
	{ action_emergency_stop("X and Y must be homed before homing Z") }
	{% else %}
	{% if z_probe == "stowable" %}
	DEPLOY_PROBE
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	STOW_PROBE
	{% else %}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G28 Z
	G0 Z{z_hop} F{z_hop_speed}
	{% endif %}
	{% endif %}
	{% endif %}
	
	
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=stowable_probe_stop_on_error VALUE={prev_stop_on_error}

[gcode_macro HOME_X_SENSORLESS]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
	{% set safe_home_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_x_current}
	G4 P300
	G28 X
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro HOME_Y_SENSORLESS]
gcode = 
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% set x_driver = printer["gcode_macro RatOS"].driver_type_x|lower ~ " stepper_x" %}
	{% set y_driver = printer["gcode_macro RatOS"].driver_type_y|lower ~ " stepper_y" %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
	{% set safe_home_y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	M204 S1000
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer["gcode_macro RatOS"].sensorless_y_current}
	G4 P300
	G28 Y
	SET_TMC_CURRENT STEPPER=stepper_x CURRENT={printer.configfile.config[x_driver].run_current}
	SET_TMC_CURRENT STEPPER=stepper_y CURRENT={printer.configfile.config[y_driver].run_current}
	G4 P300
	
	M204 S{printer.configfile.config.printer.max_accel}

[gcode_macro MAYBE_HOME]
description = Only home unhomed axis
variable_is_kinematic_position_overriden = False
gcode = 
	{% if printer["gcode_macro MAYBE_HOME"].is_kinematic_position_overriden|lower == 'true' %}
	RESPOND MSG="SET_CENTER_KINEMATIC_POSITION has been abused. Homing all axes. Please refrain from using SET_CENTER_KINEMATIC_POSITION outside of debugging purposes."
	G28
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=False
	{% else %}
	{% set axes = '' %}
	{% set isHomed = true %}
	{% set axesToHome = '' %}
	{% if params.X is defined %}
	{% set axes = axes ~ 'X ' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% endif %}
	{% if params.Y is defined %}
	{% set axes = axes ~ 'Y ' %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% endif %}
	{% if params.Z is defined %}
	{% set axes = axes ~ 'Z ' %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if params.X is not defined and params.Y is not defined and params.Z is not defined %}
	{% set axes = '' %}
	{% if 'x' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'X ' %}
	{% endif %}
	{% if 'y' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Y ' %}
	{% endif %}
	{% if 'z' not in printer.toolhead.homed_axes %}
	{% set isHomed = false %}
	{% set axesToHome = axesToHome ~ 'Z ' %}
	{% endif %}
	{% endif %}
	{% if isHomed is false %}
	M117 Homing {axesToHome}
	RESPOND MSG="Homing {axesToHome}"
	G28 {axesToHome}
	{% else %}
	RESPOND MSG="All requested axes already homed, skipping.."
	{% endif %}
	{% endif %}

[gcode_macro ECHO_RATOS_VARS]
description = Echo RatOS variables to the console.
gcode = 
	{% for var, value in printer["gcode_macro RatOS"].items() %}
	{action_respond_info(var ~ ": " ~ value)}
	{% endfor %}

[gcode_macro PAUSE]
description = Pauses the printer
rename_existing = PAUSE_BASE
variable_extrude = 1.5
gcode = 
	SAVE_GCODE_STATE NAME=PAUSE_state
	
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% if act_z < (max_z - 20.0) %}
	{% set z_safe = 20.0 %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	PAUSE_BASE
	G91
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G1 E-{E} F2100
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	
	{% if "xyz" in printer.toolhead.homed_axes %}
	G1 Z{z_safe} F{z_speed}
	_PARK LOCATION={printer["gcode_macro RatOS"].pause_print_park_in} X={printer["gcode_macro RatOS"].pause_print_park_x}
	{% else %}
	{action_respond_info("Printer not homed")}
	{% endif %}

[gcode_macro RESUME]
description = Resumes the print if the printer is paused.
rename_existing = RESUME_BASE
gcode = 
	{% set E = printer["gcode_macro PAUSE"].extrude|float %}
	
	{% if printer.extruder.can_extrude|lower == 'true' %}
	G91
	G1 E{E} F2100
	G90
	{% else %}
	{action_respond_info("Extruder not hot enough")}
	{% endif %}
	RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_travel_speed|float}
	RESUME_BASE

[gcode_macro CANCEL_PRINT]
description = Cancels the printer
rename_existing = CANCEL_PRINT_BASE
gcode = 
	END_PRINT
	FILDET_DISABLE
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	
	CANCEL_PRINT_BASE
	RESPOND COLOR=error MSG="Print cancelled"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro PRIME_LINE]
description = Prints a primeline, used internally, if configured, as part of the START_PRINT macro.
gcode = 
	SAVE_GCODE_STATE NAME=prime_line_state
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M82
	M117 Priming nozzle with prime line..
	RESPOND MSG="Priming nozzle with prime line.."
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start} F{speed}
	
	G1 Z0.3 F{z_speed}
	
	G92 E0
	
	G1 Y{y_start + (70 * y_factor)} E16 F1200
	
	G1 Y{y_start + (90 * y_factor)} F{speed}
	RESTORE_GCODE_STATE NAME=prime_line_state

[gcode_macro PRIME_BLOB]
description = Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
gcode = 
	SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set fan_speed = printer["gcode_macro RatOS"].nozzle_prime_bridge_fan|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% set y_factor = -1 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
	{% set y_factor = 1 %}
	{% else %}
	{% set y_factor = -1 %}
	{% endif %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'forwards' %}
	{% set y_factor = 1 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_direction|lower == 'backwards' %}
	{% set y_factor = -1 %}
	{% endif %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	
	G1 Z0.5 F{z_speed}
	
	G1 Y{y_start} F{speed}
	
	G1 F60 E20
	
	M106 S{fan_speed}
	
	G1 Z5 F100 E5
	
	G1 F200 Y{y_start + (25 * y_factor)} E1
	
	
	
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	
	M106 S0
	
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6
	
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state

[gcode_macro _PARK]
gcode = 
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	
	{% if params.X != '' %}
	{% if params.X|float >= printer.toolhead.axis_minimum.x + 5 and params.X|float <= printer.toolhead.axis_maximum.x - 5 %}
	{% set safe_x = params.X|float %}
	{% else %}
	{action_respond_info('The requested X co-ordinate is outside the defined axis bounds - using defaults')}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	{% else %}
	{% set safe_x = printer.toolhead.axis_maximum.x / 2 %}
	{% endif %}
	
	{% if params.LOCATION|default('back')|lower == 'back' %}
	{% set y = printer.toolhead.axis_maximum.y - 5 %}
	{% elif params.LOCATION|lower == 'front' %}
	{% set y = printer.toolhead.axis_minimum.y + 5 %}
	{% elif params.LOCATION|lower == 'center' %}
	{% set y = printer.toolhead.axis_maximum.y / 2 %}
	{% endif %}
	
	G90
	
	G0 X{safe_x} Y{y} F{speed}

[gcode_macro M600]
description = Executes a color change by pausing the printer an unloading the filament.
gcode = 
	PAUSE
	UNLOAD_FILAMENT
	M117 Please load new filament and resume
	RESPOND MSG="Please load new filament and resume"

[gcode_macro UNLOAD_FILAMENT]
description = Unloads the filament. Note: be careful with PETG, make sure you inspect the tip of your filament before reloading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=unload_state
	G91
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set unload_speed = printer["gcode_macro RatOS"].filament_unload_speed|float * 60 %}
	{% set unload_length = printer["gcode_macro RatOS"].filament_unload_length|float %}
	M117 Unloading filament...
	
	G0 E10 F300
	
	G0 E-5 F3600
	
	G4 P3000
	
	G0 E5 F3600
	
	G0 E-15 F3600
	
	G0 E-{unload_length} F{unload_speed}
	M117 Filament unloaded!
	RESPOND MSG="Filament unloaded! Please inspect the tip of the filament before reloading."
	RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro LOAD_FILAMENT]
description = Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
gcode = 
	SAVE_GCODE_STATE NAME=load_state
	G91
	
	{% if params.TEMP is defined or printer.extruder.can_extrude|lower == 'false' %}
	M117 Heating...
	M104 S{params.TEMP|default(220, true)}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.TEMP|default(220, true)}
	{% endif %}
	{% set load_speed = printer["gcode_macro RatOS"].filament_load_speed|float * 60 %}
	{% set load_length = printer["gcode_macro RatOS"].filament_load_length|float %}
	M117 Loading filament...
	
	G0 E{load_length} F{load_speed}
	
	G4 P1000
	
	G0 E40 F100
	
	M400
	M117 Filament loaded!
	RESPOND MSG="Filament loaded!"
	RESTORE_GCODE_STATE NAME=load_state

[gcode_macro SET_CENTER_KINEMATIC_POSITION]
description = FOR DEBUGGING PURPOSES ONLY. Sets the internal printer kinematic state to the center of all axes regardless of actual physical position.
gcode = 
	RESPOND MSG="WARNING: ONLY USE SET_CENTER_KINEMATIC_POSITION FOR DEBUGGING PURPOSES. YOU'RE OVERRIDING THE INTERNAL POSITIONING STATE OF THE PRINTER. PROCEED WITH CAUTION AND DO A PROPER G28 WHEN DONE."
	SET_GCODE_VARIABLE MACRO=MAYBE_HOME VARIABLE=is_kinematic_position_overriden VALUE=True
	SET_KINEMATIC_POSITION X={printer.toolhead.axis_maximum.x / 2} Y={printer.toolhead.axis_maximum.y / 2} Z={printer.toolhead.axis_maximum.z / 2}

[gcode_macro START_PRINT]
description = Start print procedure, use this in your Slicer.
gcode = 
	CLEAR_PAUSE
	FILDET_ENABLE
	{% if printer["gcode_macro RatOS"].force_absolute_position|lower == 'true' %}
	G90
	{% endif %}
	SAVE_GCODE_STATE NAME=start_print_state
	
	G21
	
	G90
	
	M82
	_USER_START_PRINT_BEFORE_HOMING
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_BEGIN_BATCH
	{% endif %}
	
	MAYBE_HOME
	{% if params.CHAMBER_TEMP is defined %}
	_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	_USER_START_PRINT_HEAT_CHAMBER CHAMBER_TEMP={params.CHAMBER_TEMP} BED_TEMP={printer["gcode_macro RatOS"].start_print_heat_chamber_bed_temp}
	{% endif %}
	M117 Heating bed...
	RESPOND MSG="Heating bed..."
	
	M190 S{params.BED_TEMP|default(printer.heater_bed.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_BED
	
	_START_PRINT_AFTER_HEATING_BED
	
	_USER_START_PRINT_BED_MESH
	
	_START_PRINT_BED_MESH X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOWABLE_PROBE_END_BATCH
	{% endif %}
	
	M104 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_PARK
	
	_START_PRINT_PARK
	
	M117 Heating Extruder...
	RESPOND MSG="Heating Extruder..."
	M109 S{params.EXTRUDER_TEMP|default(printer.extruder.target, true) }
	
	_USER_START_PRINT_AFTER_HEATING_EXTRUDER
	
	_START_PRINT_AFTER_HEATING_EXTRUDER
	M117 Printing...
	RESPOND MSG="Printing..."
	RESTORE_GCODE_STATE NAME=start_print_state
	
	{% if printer["gcode_macro RatOS"].relative_extrusion|lower == 'true' %}
	M83
	{% else %}
	M82
	{% endif %}
	G92 E0

[gcode_macro _USER_START_PRINT_BEFORE_HOMING]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
	{% set min_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float %}
	{% set max_temp = printer["gcode_macro RatOS"].preheat_extruder_temp|float + 5 %}
	M117 Pre-heating extruder...
	RESPOND MSG="Pre-heating extruder..."
	
	
	M104 S{min_temp}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={min_temp} MAXIMUM={max_temp}
	{% endif %}
	M117 Adjusting Z tilt...
	RESPOND MSG="Adjusting Z tilt..."
	
	Z_TILT_ADJUST
	M117 Rehoming Z after Z tilt adjustment...
	RESPOND MSG="Rehoming Z after Z tilt adjustment..."
	
	G28 Z

[gcode_macro Z_TILT_ADJUST]
rename_existing = Z_TILT_ADJUST_ORIG
gcode = 
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	Z_TILT_ADJUST_ORIG
	{% if printer["gcode_macro RatOS"].z_probe == 'stowable' %}
	STOW_PROBE
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_BED]
gcode = 
	{% if printer["gcode_macro RatOS"].bed_soak|lower == 'true' %}
	G4 P{printer["gcode_macro RatOS"].bed_soak_time}
	{% endif %}

[gcode_macro _START_PRINT_BED_MESH]
gcode = 
	{% set default_profile = printer["gcode_macro RatOS"].bed_mesh_profile|default('ratos') %}
	{% if printer["gcode_macro RatOS"].calibrate_bed_mesh|lower == 'true' %}
	BED_MESH_CLEAR
	{% if printer["gcode_macro RatOS"].adaptive_mesh|lower == 'true' %}
	CALIBRATE_ADAPTIVE_MESH PROFILE={default_profile} X0={params.X0} X1={params.X1} Y0={params.Y0} Y1={params.Y1}
	{% else %}
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% endif %}
	BED_MESH_PROFILE LOAD={default_profile}
	{% elif printer["gcode_macro RatOS"].bed_mesh_profile is defined %}
	BED_MESH_CLEAR
	BED_MESH_PROFILE LOAD={printer["gcode_macro RatOS"].bed_mesh_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_BED_MESH]
gcode = 

[gcode_macro _START_PRINT_PARK]
gcode = 
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	_PARK LOCATION={printer["gcode_macro RatOS"].start_print_park_in} X={printer["gcode_macro RatOS"].start_print_park_x}
	G0 Z{z} F{zSpeed}

[gcode_macro _USER_START_PRINT_PARK]
gcode = 

[gcode_macro _START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 
	{% set has_offset = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) != 9999.9 %}
	{% if has_offset %}
	ADD_PRIME_PROBE_TO_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeline' %}
	PRIME_LINE
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'primeblob' %}
	PRIME_BLOB
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower == 'linepurge' %}
	LINE_PURGE
	{% endif %}
	{% if has_offset %}
	SUBTRACT_PRIME_PROBE_FROM_OFFSET
	{% endif %}
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SKEW_PROFILE LOAD={printer["gcode_macro RatOS"].skew_profile}
	{% endif %}

[gcode_macro _USER_START_PRINT_AFTER_HEATING_EXTRUDER]
gcode = 

[gcode_macro _START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 
	{% if params.CHAMBER_TEMP is defined and params.BED_TEMP is defined and params.CHAMBER_TEMP|int > 0 %}
	{% set z = printer["gcode_macro RatOS"].start_print_park_z_height|float %}
	{% set zSpeed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	G0 Z{z} F{zSpeed}
	M84
	M117 Heating chamber...
	RESPOND MSG="Heating chamber..."
	M140 S{params.BED_TEMP}
	TEMPERATURE_WAIT SENSOR=extruder MINIMUM={params.CHAMBER_TEMP}
	MAYBE_HOME
	{% endif %}

[gcode_macro _USER_START_PRINT_HEAT_CHAMBER]
description = Uses the extruder sensor to wait for chamber temp. Override the _START_PRINT_HEAT_CHAMBER macro to implement heated chamber handling.
gcode = 

[gcode_macro END_PRINT]
description = End print procedure, use this in your Slicer.
gcode = 
	FILDET_DISABLE
	SAVE_GCODE_STATE NAME=end_print_state
	_USER_END_PRINT_BEFORE_HEATERS_OFF
	_END_PRINT_BEFORE_HEATERS_OFF
	TURN_OFF_HEATERS
	_USER_END_PRINT_AFTER_HEATERS_OFF
	_END_PRINT_AFTER_HEATERS_OFF
	_USER_END_PRINT_PARK
	_END_PRINT_PARK
	
	{% if printer["gcode_macro RatOS"].skew_profile is defined %}
	SET_SKEW CLEAR=1
	{% endif %}
	
	M84
	
	M107
	
	BED_MESH_CLEAR
	BED_MESH_PROFILE REMOVE="ratos"
	M117 Done :)
	RESTORE_GCODE_STATE NAME=end_print_state
	RESPOND COLOR=success MSG="Print done"
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=30

[gcode_macro _END_PRINT_BEFORE_HEATERS_OFF]
gcode = 
	RESPOND MSG="Cleaning up..."

[gcode_macro _USER_END_PRINT_BEFORE_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_AFTER_HEATERS_OFF]
gcode = 
	
	{% set max_z = printer.toolhead.axis_maximum.z|float %}
	{% set act_z = printer.toolhead.position.z|float %}
	{% set z_hop = printer["gcode_macro RatOS"].end_print_park_z_hop|float %}
	{% if act_z < (max_z - z_hop) %}
	{% set z_safe = z_hop %}
	{% else %}
	{% set z_safe = max_z - act_z %}
	{% endif %}
	
	G91
	
	G1 E-2 F3600
	
	G0 Z{z_safe} F3600
	
	G1 E-2 F3600
	
	G90

[gcode_macro _USER_END_PRINT_AFTER_HEATERS_OFF]
gcode = 

[gcode_macro _END_PRINT_PARK]
gcode = 
	_PARK LOCATION={printer["gcode_macro RatOS"].end_print_park_in} X={printer["gcode_macro RatOS"].end_print_park_x}

[gcode_macro _USER_END_PRINT_PARK]
gcode = 

[gcode_macro SAVE_PROBE_RESULT]
gcode = 
	{% set last_z = printer.probe.last_z_result %}
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE={params.VARIABLE|default('last_z')} VALUE={last_z}

[gcode_macro PROBE_FOR_PRIMING]
gcode = 
	{% if printer["gcode_macro RatOS"].nozzle_priming|lower != 'false' %}
	SAVE_GCODE_STATE NAME=probe_for_priming_state
	RESPOND MSG="Probing the prime location.."
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'min' %}
	{% set x_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_x|lower == 'max' %}
	{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
	{% set x_start = printer["gcode_macro RatOS"].nozzle_prime_start_x|float %}
	{% endif %}
	{% if printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'min' %}
	{% set y_start = 5 %}
	{% elif printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == 'max' %}
	{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
	{% else %}
	{% set y_start = printer["gcode_macro RatOS"].nozzle_prime_start_y|float %}
	{% endif %}
	{% set z = printer.configfile.settings.bed_mesh.horizontal_move_z|float %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% if printer.configfile.settings.bltouch is defined %}
	{% set x_offset = printer.configfile.settings.bltouch.x_offset|float %}
	{% set y_offset = printer.configfile.settings.bltouch.y_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set x_offset = printer.configfile.settings.probe.x_offset|float %}
	{% set y_offset = printer.configfile.settings.probe.y_offset|float %}
	{% elif printer.configfile.settings.beacon is defined %}
	{% set x_offset = printer.configfile.settings.beacon.x_offset|float %}
	{% set y_offset = printer.configfile.settings.beacon.y_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float - x_offset %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float - y_offset %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float - x_offset %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float - y_offset %}
	
	
	{% set x_start = [[x_start, max_x]|min, min_x]|max %}
	{% set y_start = [[y_start, max_y]|min, min_y]|max %}
	
	RESPOND MSG="PROBE_FOR_PRIMING: Probing the prime location at X: {x_start} Y: {y_start}"
	
	
	G90
	
	M83
	
	G0 Z{z} F{z_speed}
	
	G1 X{x_start} Y{y_start} F{speed}
	PROBE_CURRENT_POSITION
	SAVE_PROBE_RESULT VARIABLE=probe_for_priming_result
	
	RESTORE_GCODE_STATE NAME=probe_for_priming_state
	{% endif %}

[gcode_macro RESET_PRIME_PROBE_STATE]
gcode = 
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=probe_for_priming_result VALUE=None

[gcode_macro PROBE_CURRENT_POSITION]
gcode = 
	SAVE_GCODE_STATE NAME=probe_current_position_state
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	ASSERT_PROBE_DEPLOYED
	{% endif %}
	PROBE
	RESTORE_GCODE_STATE NAME=probe_current_position_state MOVE=1 MOVE_SPEED={printer["gcode_macro RatOS"].macro_z_speed|float}

[gcode_macro ADD_PRIME_PROBE_TO_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	{% set adjustment = last_z - z_offset %}
	{% set adjustment_threshold = printer["gcode_macro RatOS"].adaptive_prime_offset_threshold|float %}
	{% if adjustment < adjustment_threshold %}
	{ action_raise_error("Abnormal probe offset detected. Needed offset of {adjustment} is below the offset threshold of -1mm. Please verify the probe is over the bed when probing for priming. If it isn't, you should adjust you min/max bed_mesh settings so the probe is always over the print area.") }
	{% endif %}
	RESPOND MSG="ADD_PRIME_PROBE_TO_OFFSET: adjusting z offset by {adjustment}"
	SET_GCODE_OFFSET Z_ADJUST={adjustment} MOVE=1

[gcode_macro SUBTRACT_PRIME_PROBE_FROM_OFFSET]
gcode = 
	{% set last_z = printer["gcode_macro RatOS"].probe_for_priming_result|float(9999.9) %}
	{% if printer.configfile.settings.bltouch is defined %}
	{% set z_offset = printer.configfile.settings.bltouch.z_offset|float %}
	{% elif printer.configfile.settings.probe is defined %}
	{% set z_offset = printer.configfile.settings.probe.z_offset|float %}
	{% else %}
	{ action_raise_error("No probe or bltouch section found. Adaptive priming only works with [probe] or [bltouch].") }
	{% endif %}
	{% if last_z == 9999.9 %}
	{ action_raise_error("No probe result found for prime area. This is likely a bug.") }
	{% endif %}
	RESPOND MSG="SUBTRACT_PRIME_PROBE_FROM_OFFSET: adjusting z offset by {z_offset - last_z}"
	SET_GCODE_OFFSET Z_ADJUST={z_offset - last_z} MOVE=1

[gcode_macro CALIBRATE_ADAPTIVE_MESH]
gcode = 
	
	{% set default_profile = params.PROFILE %}
	
	
	{% set x0 = params.X0|default(-1)|float %}
	{% set y0 = params.Y0|default(-1)|float %}
	{% set x1 = params.X1|default(-1)|float %}
	{% set y1 = params.Y1|default(-1)|float %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Recieved coordinates X0={x0} Y0={y0} X1={x1} Y1={y1}"
	
	{% if x0 >= x1 or y0 >= y1 %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Invalid coordinates received. Please check your slicer settings. Falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	
	{% set mesh_config = printer.configfile.config.bed_mesh %}
	
	
	{% set min_x = mesh_config.mesh_min.split(",")[0]|float %}
	{% set min_y = mesh_config.mesh_min.split(",")[1]|float %}
	{% set max_x = mesh_config.mesh_max.split(",")[0]|float %}
	{% set max_y = mesh_config.mesh_max.split(",")[1]|float %}
	
	
	{% set mesh_x0 = [[x0, max_x]|min, min_x]|max %}
	{% set mesh_y0 = [[y0, max_y]|min, min_y]|max %}
	{% set mesh_x1 = [[x1, max_x]|min, min_x]|max %}
	{% set mesh_y1 = [[y1, max_y]|min, min_y]|max %}
	
	{% if mesh_x0 == min_x and mesh_y0 == min_y and mesh_x1 == max_x and mesh_y1 == max_y %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: Print is using the full bed, falling back to full bed mesh."
	BED_MESH_CALIBRATE PROFILE={default_profile}
	{% else %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	DEPLOY_PROBE
	{% endif %}
	
	{% set probe_count_x = mesh_config.probe_count.split(",")[0]|int %}
	{% if mesh_config.probe_count.split(",")|length == 2 %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[1]|int %}
	{% else %}
	{% set probe_count_y = mesh_config.probe_count.split(",")[0]|int %}
	{% endif %}
	
	
	{% set probe_x_step = (max_x - min_x) / probe_count_x %}
	{% set probe_y_step = (max_y - min_y) / probe_count_y %}
	
	
	{% set mesh_count_x = ([(mesh_x1 - mesh_x0) / probe_x_step, 3]|max)|int %}
	{% set mesh_count_y = ([(mesh_y1 - mesh_y0) / probe_y_step, 3]|max)|int %}
	{% set min_mesh_count = [mesh_count_x, mesh_count_y]|min %}
	{% set max_mesh_count = [mesh_count_x, mesh_count_y]|max %}
	
	
	{% set algorithm = mesh_config.algorithm %}
	{% if algorithm|lower == 'lagrange' and max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: cannot exceed a probe_count of 6 when using lagrange interpolation. Falling back to bicubic interpolation."
	{% set algorithm = 'bicubic' %}
	{% endif %}
	{% if algorithm|lower == 'bicubic' and min_mesh_count < 4 %}
	{% if max_mesh_count > 6 %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: invalid probe_count option when using bicubic interpolation. Combination of 3 points on one axis with more than 6 on another is not permitted. Forcing minimum mesh count to be 4."
	{% set min_mesh_count = 4 %}
	{% else %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: bicubic interpolation with a probe_count of less than 4 points detected. Forcing lagrange interpolation."
	{% set algorithm = 'lagrange' %}
	{% endif %}
	{% endif %}
	
	{% set mesh_count_x = ([min_mesh_count, mesh_count_x]|max)|int %}
	{% set mesh_count_x = ([max_mesh_count, mesh_count_x]|min)|int %}
	{% set mesh_count_y = ([min_mesh_count, mesh_count_y]|max)|int %}
	{% set mesh_count_y = ([max_mesh_count, mesh_count_y]|min)|int %}
	
	{% set should_prime = printer["gcode_macro RatOS"].nozzle_priming == 'primeline' or printer["gcode_macro RatOS"].nozzle_priming == 'primeblob' %}
	{% if printer.configfile.settings.beacon is defined %}
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: adaptive priming is currently not supported for Beacon. Disabling priming.."
	SET_GCODE_VARIABLE MACRO=RatOS VARIABLE=nozzle_priming VALUE=False
	{% set should_prime = False %}
	{% endif %}
	
	{% set prime_first = printer["gcode_macro RatOS"].nozzle_prime_start_y|lower == "min" or printer["gcode_macro RatOS"].nozzle_prime_start_y|float(printer.toolhead.axis_maximum.y) < printer.toolhead.axis_maximum.y / 2 %}
	
	{% if should_prime and prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	
	RESPOND MSG="CALIBRATE_ADAPTIVE_MESH: mesh coordinates X0={mesh_x0} Y0={mesh_y0} X1={mesh_x1} Y1={mesh_y1}"
	BED_MESH_CALIBRATE PROFILE={default_profile} algorithm={algorithm} mesh_min={mesh_x0},{mesh_y0} mesh_max={mesh_x1},{mesh_y1} probe_count={mesh_count_x},{mesh_count_y}
	
	{% if should_prime and not prime_first %}
	PROBE_FOR_PRIMING
	{% endif %}
	{% if printer["gcode_macro RatOS"].z_probe|lower == 'stowable' %}
	STOW_PROBE
	{% endif %}
	
	{% endif %}
	{% endif %}

[gcode_macro LINE_PURGE]
description = A purge macro that adapts to be near your actual printed objects
gcode = 
	
	{% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
	{% set cross_section = printer.configfile.settings.extruder.max_extrude_cross_section | float %}
	
	
	{% if printer.firmware_retraction is defined %}
	{% set RETRACT = G10 | string %}
	{% set UNRETRACT = G11 | string %}
	{% else %}
	{% set RETRACT = 'G1 E-.5 F2100' | string %}
	{% set UNRETRACT = 'G1 E.5 F2100' | string %}
	{% endif %}
	
	{% set verbose_enable = printer["gcode_macro RatOS"].verbose_enable | abs %}
	{% set purge_height = printer["gcode_macro RatOS"].purge_height | float %}
	{% set tip_distance = printer["gcode_macro RatOS"].tip_distance | float %}
	{% set purge_margin = printer["gcode_macro RatOS"].purge_margin | float %}
	{% set purge_amount = printer["gcode_macro RatOS"].purge_amount | float %}
	{% set flow_rate = printer["gcode_macro RatOS"].flow_rate | float %}
	
	
	{% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
	{% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
	{% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
	{% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
	{% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
	
	{% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
	{% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}
	
	{% set purge_x_origin = ([purge_x_min - purge_margin, 0] | max) %}
	{% set purge_y_origin = ([purge_y_min - purge_margin, 0] | max) %}
	
	
	{% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
	{% if cross_section < 5 %}
	{action_respond_info("[Extruder] max_extrude_cross_section is insufficient for purge, please set it to 5 or greater. Purge skipped.")}
	{% else %}
	{% if verbose_enable == True %}
	{action_respond_info("Moving filament tip {}mms".format(
	(tip_distance),
	)) }
	{% endif %}
	{% if printer.firmware_retraction is defined %}
	{action_respond_info("KAMP purge is using firmware retraction.")}
	{% else %}
	{action_respond_info("KAMP purge is not using firmware retraction, it is recommended to configure it.")}
	{% endif %}
	{% if purge_y_origin > 0 %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_center),
	(purge_y_origin),
	(purge_amount),
	(flow_rate),
	)) }
	{% else %}
	{action_respond_info("KAMP purge starting at {}, {} and purging {}mm of filament, requested flow rate is {}mm3/s.".format(
	(purge_x_origin),
	(purge_y_center),
	(purge_amount),
	(flow_rate),
	)) }
	{% endif %}
	
	SAVE_GCODE_STATE NAME=Prepurge_State
	
	{% if purge_y_origin > 0 %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_center} Y{purge_y_origin}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 X{purge_x_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% else %}
	G92 E0
	G0 F{travel_speed}
	G90
	G0 X{purge_x_origin} Y{purge_y_center}
	G0 Z{purge_height}
	M83
	G1 E{tip_distance} F{purge_move_speed}
	G1 Y{purge_y_center + purge_amount} E{purge_amount} F{purge_move_speed}
	{RETRACT}
	G0 Y{purge_y_center + purge_amount + 10} F{travel_speed}
	G92 E0
	M82
	G0 Z{purge_height * 2} F{travel_speed}
	{% endif %}
	RESTORE_GCODE_STATE NAME=Prepurge_State
	{% endif %}

[gcode_shell_command generate_shaper_graph_x]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-x.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_shaper_graph_y]
command = /home/pi/printer_data/config/RatOS/scripts/generate-shaper-graph-y.sh
timeout = 60.
verbose = True

[gcode_shell_command generate_belt_tension_graph]
command = /home/pi/printer_data/config/RatOS/scripts/generate-belt-tension-graph.sh
timeout = 90.
verbose = True

[gcode_shell_command compile_binaries]
command = /home/pi/printer_data/config/RatOS/scripts/compile-binaries.sh
timeout = 600.

[gcode_shell_command change_hostname]
command = /home/pi/printer_data/config/RatOS/scripts/change-hostname.sh
timeout = 10.

[gcode_macro GENERATE_SHAPER_GRAPHS]
description = Genarates input shaper resonances graphs for analysis. Uses the AXIS parameter for if you only want to do one axis at a time, (eg. GENERATE_SHAPER_GRAPHS AXIS=X)
gcode = 
	{% if params.AXIS is defined %}
	{% if params.AXIS|lower == 'x' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RESPOND MSG="Input shaper graph generated for the X axis. You'll find it in the input_shaper folder in the machine tab!"
	{% elif params.AXIS|lower == 'y' %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graph generated for the Y axis. You'll find it in the input_shaper folder in the machine tab!"
	{% else %}
	{action_raise_error("Unknown axis specified. Expected X or Y.")}
	{% endif %}
	{% else %}
	MAYBE_HOME
	TEST_RESONANCES AXIS=X
	TEST_RESONANCES AXIS=Y
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_x
	RUN_SHELL_COMMAND CMD=generate_shaper_graph_y
	RESPOND MSG="Input shaper graphs generated for X and Y. You'll find them in the input_shaper folder in the machine tab!"
	{% endif %}

[gcode_macro MEASURE_COREXY_BELT_TENSION]
description = Generates resonance graph used to ensure belts are equally tensioned.
gcode = 
	TEST_RESONANCES AXIS=1,1  OUTPUT=raw_data NAME=belt-tension-upper
	TEST_RESONANCES AXIS=1,-1 OUTPUT=raw_data NAME=belt-tension-lower
	RUN_SHELL_COMMAND CMD=generate_belt_tension_graph
	RESPOND MSG="Belt tension graphs generated. You'll find them in the input_shaper folder in the machine tab!"

[gcode_macro COMPILE_FIRMWARE]
description = Compiles firmware with currently installed klipper version for all supported RatOS boards. Note: this may take up to 10 minutes.
gcode = 
	RESPOND MSG="Compiling binaries.. This can take up to 10 minutes. Please do not turn off your Raspberry Pi!"
	RUN_SHELL_COMMAND CMD=compile_binaries
	RESPOND MSG="Firmware binaries compiled successfully! You can find them in the firmware_binaries folder in the machine tab!"

[gcode_macro CHANGE_HOSTNAME]
description = Change the hostname of your Raspberry Pi.
gcode = 
	{% if params.HOSTNAME is not defined %}
	RESPOND MSG='You have to specify a new hostname with the HOSTNAME parameter. Ex: CHANGE_HOSTNAME HOSTNAME="MY_NEW_HOSTNAME"'
	RESPOND MSG="Please note: RFCs mandate that a hostname's labels may contain only the ASCII letters 'a' through 'z' (case-insensitive), the digits '0' through '9', and the hyphen. Hostname labels cannot begin or end with a hyphen. No other symbols, punctuation characters, or blank spaces are permitted."
	{% else %}
	RUN_SHELL_COMMAND CMD=change_hostname PARAMS={params.HOSTNAME}
	{% endif %}

[stepper_z]
endstop_pin = probe:z_virtual_endstop
step_pin = motor_1_step
dir_pin = motor_1_dir
enable_pin = !motor_1_enable
rotation_distance = 4
microsteps = 64
position_min = -5
homing_speed = 10
position_max = 200

[tmc2209 stepper_z]
uart_pin = motor_1_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z1]
step_pin = motor_2_step
dir_pin = motor_2_dir
enable_pin = !motor_2_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z1]
uart_pin = motor_2_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_z2]
step_pin = motor_3_step
dir_pin = motor_3_dir
enable_pin = !motor_3_enable
rotation_distance = 4
microsteps = 64

[tmc2209 stepper_z2]
uart_pin = motor_3_uart
run_current = 1.6
stealthchop_threshold = 0
interpolate = False
hold_current = 0.4

[stepper_x]
step_pin = motor_4_step
dir_pin = !motor_4_dir
enable_pin = !motor_4_enable
rotation_distance = 40
microsteps = 64
homing_speed = 30
homing_retract_dist = 5.0
full_steps_per_rotation = 200
position_max = 200
position_endstop = 0
endstop_pin = ^endstop_motor_1

[tmc5160 stepper_x]
cs_pin = motor_4_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_x1]
step_pin = motor_5_step
dir_pin = motor_5_dir
enable_pin = !motor_5_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_x1]
cs_pin = motor_5_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y]
step_pin = motor_6_step
dir_pin = !motor_6_dir
enable_pin = !motor_6_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200
position_max = 200
position_endstop = 200
homing_speed = 30
homing_retract_dist = 5.0
endstop_pin = ^endstop_motor_2
homing_positive_dir = true
position_min = 19

[tmc5160 stepper_y]
cs_pin = motor_6_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[stepper_y1]
step_pin = motor_7_step
dir_pin = motor_7_dir
enable_pin = !motor_7_enable
rotation_distance = 40
microsteps = 64
full_steps_per_rotation = 200

[tmc5160 stepper_y1]
cs_pin = motor_7_uart
spi_software_mosi_pin = stepper_spi_mosi
spi_software_miso_pin = stepper_spi_miso
spi_software_sclk_pin = stepper_spi_sclk
run_current = 1.768
stealthchop_threshold = 0
interpolate = False
hold_current = 0.442

[bed_mesh]
speed = 10
horizontal_move_z = 5
mesh_min = 10, 8.45
mesh_max = 170, 185.45
probe_count = 10,10
fade_start = 1.0
fade_end = 10.0
mesh_pps = 2,2
algorithm = bicubic
bicubic_tension = .2

[z_tilt]
speed = 50
z_positions = 
	0,0
	100,200
	200,0
points = 
	60,22
	135,190
	190,22
horizontal_move_z = 20
retries = 20
retry_tolerance = 0.02

[gcode_macro enable_stepper]
gcode = 
	SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_x1 ENABLE=1
	SET_STEPPER_ENABLE STEPPER=stepper_y1 ENABLE=1

[gcode_macro disable_steppers]
gcode = 
	m84

[gcode_macro STEPPER_BUZZ_X]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x

[gcode_macro STEPPER_BUZZ_Y]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y

[gcode_macro STEPPER_BUZZ_X1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_x1

[gcode_macro STEPPER_BUZZ_Y1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_y1

[gcode_macro STEPPER_BUZZ_Z]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z

[gcode_macro STEPPER_BUZZ_Z1]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z1

[gcode_macro STEPPER_BUZZ_Z2]
gcode = 
	STEPPER_BUZZ STEPPER=stepper_z2

[gcode_macro TEST_SPEED]
gcode = 
	
	{% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
	
	{% set iterations = params.ITERATIONS|default(5)|int %}
	
	{% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
	
	{% set bound = params.BOUND|default(20)|int %}
	
	{% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
	
	
	
	{% set x_min = printer.toolhead.axis_minimum.x + bound %}
	{% set x_max = printer.toolhead.axis_maximum.x - bound %}
	{% set y_min = printer.toolhead.axis_minimum.y + bound %}
	{% set y_max = printer.toolhead.axis_maximum.y - bound %}
	
	
	
	{% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
	{% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
	
	
	{% set x_center_min = x_center - (smallpatternsize/2) %}
	{% set x_center_max = x_center + (smallpatternsize/2) %}
	{% set y_center_min = y_center - (smallpatternsize/2) %}
	{% set y_center_max = y_center + (smallpatternsize/2) %}
	
	
	SAVE_GCODE_STATE NAME=TEST_SPEED
	
	
	{ action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
	
	
	SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
	
	
	
	
	
	G0 X{x_min+10} Y{y_min+10} Z{bound + 20} F{speed*60}
	
	{% for i in range(iterations) %}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	
	
	G0 X{x_min+10} Y{y_min+10} F{speed*60}
	G0 X{x_min+10} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_max-30} F{speed*60}
	G0 X{x_max-30} Y{y_min+10} F{speed*60}
	
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	
	
	G0 X{x_center_min} Y{y_center_min} F{speed*60}
	G0 X{x_center_min} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_max} F{speed*60}
	G0 X{x_center_max} Y{y_center_min} F{speed*60}
	{% endfor %}
	
	
	SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio}
	
	RESTORE_GCODE_STATE NAME=TEST_SPEED
	G0 X115 Y115 Z30

[bltouch]
sensor_pin = ^bltouch_probe
control_pin = bltouch_servo
speed = 7
pin_move_time = 0.675
sample_retract_dist = 10
pin_up_reports_not_triggered = True
pin_up_touch_mode_reports_triggered = True
x_offset = -30
y_offset = -14.550
z_offset = 3.825

[gcode_macro RatOS]
variable_z_probe = "static"
variable_homing_x = "endstop"
variable_homing_y = "endstop"
variable_homing = "endstops"
description = RatOS variable storage macro, will echo variables to the console when run.
variable_relative_extrusion = False
variable_force_absolute_position = False
variable_preheat_extruder = True
variable_preheat_extruder_temp = 150
variable_calibrate_bed_mesh = True
variable_bed_soak = False
variable_bed_soak_time = 60000
variable_nozzle_priming = "linepurge"
variable_verbose_enable = True
variable_purge_height = 0.8
variable_tip_distance = 0.4
variable_purge_margin = 20
variable_purge_amount = 30
variable_flow_rate = 10
variable_filament_unload_length = 130
variable_filament_unload_speed = 5
variable_filament_load_length = 100
variable_filament_load_speed = 10
variable_start_print_park_in = "back"
variable_start_print_park_z_height = 50
variable_end_print_park_in = "back"
variable_pause_print_park_in = "back"
variable_macro_travel_speed = 150
variable_macro_z_speed = 15
variable_end_print_park_z_hop = 20
variable_safe_home_x = "middle"
variable_safe_home_y = "middle"
variable_stowable_probe_stop_on_error = False
variable_adaptive_mesh = False
gcode = 
	ECHO_RATOS_VARS

[extruder]
rotation_distance = 5.57
full_steps_per_rotation = 200
filament_diameter = 1.750
max_extrude_only_velocity = 120
max_extrude_only_accel = 800
pressure_advance_smooth_time = 0.02
step_pin = motor_8_step
dir_pin = !motor_8_dir
enable_pin = !motor_8_enable
microsteps = 64
max_extrude_only_distance = 200
nozzle_diameter = 0.4
heater_pin = heater_e0
sensor_type = PT1000
pullup_resistor = 2200
sensor_pin = thermistor_e1
min_extrude_temp = 170
min_temp = 0
max_temp = 300
pressure_advance = 0.025
max_extrude_cross_section = 5
control = pid
pid_kp = 30.620
pid_ki = 1.926
pid_kd = 121.714

[tmc2209 extruder]
uart_pin = motor_8_uart
run_current = 0.5
stealthchop_threshold = 0
driver_tbl = 1
driver_toff = 3
driver_hend = 9
driver_hstrt = 7
interpolate = False
hold_current = 0.125

[firmware_retraction]
retract_speed = 120
unretract_extra_length = 0
unretract_speed = 120
retract_length = 0.5

[filament_switch_sensor filament_switch]
switch_pin = ^filament_sensor_adc2
pause_on_runout = false
runout_gcode = 
	PAUSE
	RESPOND COLOR=warning MSG="Filament ran out"
insert_gcode = 

[delayed_gcode DISABLEFILAMENTSENSOR]
initial_duration = 1
gcode = 
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[gcode_macro FILDET_ENABLE]
description = Enable smart filament sensor
gcode = 
	M117 ENABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="ENABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1

[gcode_macro FILDET_DISABLE]
description = Disable smart filament sensor
gcode = 
	M117 DISABLING the Smart Filament Sensor
	RESPOND COLOR=info MSG="DISABLING the Smart Filament Sensor"
	G92 E0
	SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0

[autotune_tmc stepper_x]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_x1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_y1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 48

[autotune_tmc stepper_z]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z1]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[autotune_tmc stepper_z2]
motor = ldo-42sth48-2804ah
tuning_goal = performance
voltage = 24

[output_pin status_led]
pin = heater_e3
value = 0
shutdown_value = 0

[gcode_button top]
pin = ^det_motor_6
press_gcode = 
release_gcode = 
	{% if printer.print_stats.state == "printing" %}
	PAUSE
	RESPOND COLOR=info MSG="Print paused"
	SET_PIN PIN=status_led VALUE=1
	{% elif printer.print_stats.state == "paused" %}
	RESUME
	RESPOND COLOR=info MSG="Print resumed"
	SET_PIN PIN=status_led VALUE=0
	{% else %}
	RESPOND COLOR=error MSG="Cannot pause or resume: no print in progress"
	{% endif %}

[gcode_button bottom]
pin = ^det_motor_5
press_gcode = 
release_gcode = 
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2

[gcode_macro _POWER_OFF_PRINTER]
gcode = 
	{action_call_remote_method(
	"set_device_power", device="printer", state="off"
	)}

[delayed_gcode POWER_OFF_PRINTER_CHECK]
gcode = 
	{% if printer.idle_timeout.state == "Idle" or printer.idle_timeout.state == "Ready" %}
	{% if printer.extruder.temperature < 50.0 and printer.heater_bed.temperature < 50.0 %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	RESPOND COLOR=info MSG="Powering printer off"
	G4 P3000
	_POWER_OFF_PRINTER
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% endif %}
	{% else %}
	{% if printer.idle_timeout.state == "Printing" %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% else %}
	{% if printer.extruder.target == 0.0 and printer.heater_bed.target == 0.0 %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=2
	{% else %}
	UPDATE_DELAYED_GCODE ID=POWER_OFF_PRINTER_CHECK DURATION=0
	{% endif %}
	{% endif %}
	{% endif %}
	{% endif %}

[gcode_macro RESPOND]
rename_existing = BASE_RESPOND
gcode = 
	{% set colors = ('primary', 'secondary', 'accent', 'info', 'success', 'error', 'warning') %}
	
	{% if params.MSG is defined %}
	{% set msg = 'MSG="'+ params.MSG + '"'|string %}
	{% endif %}
	
	{% if params.COLOR is defined %}
	{% set color = params.COLOR|lower %}
	
	{% if color in colors %}
	{% set msg = 'MSG="<span class=' + color + '--text>' + params.MSG + '</span>"'|string %}
	
	{% else %}
	BASE_RESPOND TYPE=error MSG="RESPOND COLOR '{color}' is invalid. Must be one of 'primary', 'secondary', 'accent', 'info', 'success', 'warning' or 'error'"
	{% endif %}
	
	{% endif %}
	BASE_RESPOND {msg}
=======================
Extruder max_extrude_ratio=2.078758
mcu 'mcu': Starting serial connect
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
webhooks client 4128661456: New connection
webhooks client 4128661456: Client info {'program': 'Moonraker', 'version': 'v0.8.0-327-g9447494'}
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
mcu 'mcu': Unable to open serial port: [Errno 2] could not open port /dev/btt-octopus-max-ez: [Errno 2] No such file or directory: '/dev/btt-octopus-max-ez'
